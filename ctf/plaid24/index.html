<!doctype html> <html lang=en > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <link rel=stylesheet  href="/wednesday/libs/katex/katex.min.css"> <link rel=stylesheet  href="/wednesday/libs/highlight/styles/base16/chalk.min.css" /> <link rel=stylesheet  href="/wednesday/css/franklin.css" /> <link rel=stylesheet  href="/wednesday/css/tufte.css" /> <link rel=stylesheet  href="/wednesday/css/latex.css" /> <link rel=stylesheet  href="/wednesday/css/adjust.css" /> <link rel=stylesheet  href="/wednesday/css/dark-reader.css"> <link rel=icon  href="/wednesday/assets/favicon.png" /> <title>PlaidCTF 2024</title> <div id=layout > <div id=menu > <ul> <li><a href="/wednesday/">home</a> <li><a href="/wednesday/about/">about</a> <li><a href="/wednesday/ctf/">ctf</a> </ul> </div> <div id=main > <div class=franklin-content ><h1 id=plaidctf_2024 ><a href="#plaidctf_2024" class=header-anchor >PlaidCTF 2024</a></h1> <p>Over the weekend I played in PPP&#39;s <a href="https://plaidctf.com/">PlaidCTF</a>, and managed to solve all the cryptography challenges&#33;</p> <p>Going in, I expected the difficulty to be slightly above my current skill level, so I&#39;m quite pleased with this result. Overall I spent about 6 hours on each challenge, with 12 hours on the first day for <code>DHCPPP</code> and <code>Paranormial Commmitment Scheme</code>, and then another 6 hours on the second day to solve <code>MMORPG</code>. </p> <p>This was definitely one of my favourite CTFs this year. Massive thank you to <a href="https://pwning.net/">Plaid Parliament of Pwning</a> for hosting.</p> <div class=franklin-toc ><ol><li><a href="#dhcppp">DHCPPP</a><li><a href="#paranormial_commitment_scheme">Paranormial Commitment Scheme</a><li><a href="#mmorpg">MMORPG </a></ol></div> <h2 id=dhcppp ><a href="#dhcppp" class=header-anchor >DHCPPP</a></h2> <p>In this challenge we are given access to two servers: a DHCP server which simulates assigning IP addresses and DNS parameters to clients using the DHCP protocol, and a flag server which receives leases from the DHCP server and uses the provided parameters to make HTTP requests.</p> <pre><code class="python hljs"><span class=hljs-keyword >import</span> time, zlib
<span class=hljs-keyword >import</span> secrets
<span class=hljs-keyword >import</span> hashlib
<span class=hljs-keyword >import</span> requests
<span class=hljs-keyword >from</span> Crypto.Cipher <span class=hljs-keyword >import</span> ChaCha20_Poly1305
<span class=hljs-keyword >import</span> dns.resolver

CHACHA_KEY = secrets.token_bytes(<span class=hljs-number >32</span>)
TIMEOUT = <span class=hljs-number >1e-1</span>

<span class=hljs-keyword >def</span> <span class="hljs-title function_">encrypt_msg</span>(<span class=hljs-params >msg, nonce</span>):
    <span class=hljs-comment ># In case our RNG nonce is repeated, we also hash</span>
    <span class=hljs-comment ># the message in. This means the worst-case scenario</span>
    <span class=hljs-comment ># is that our nonce reflects a hash of the message</span>
    <span class=hljs-comment ># but saves the chance of a nonce being reused across</span>
    <span class=hljs-comment ># different messages</span>
    nonce = sha256(msg[:<span class=hljs-number >32</span>] + nonce[:<span class=hljs-number >32</span>])[:<span class=hljs-number >12</span>]

    cipher = ChaCha20_Poly1305.new(key=CHACHA_KEY, nonce=nonce)
    ct, tag = cipher.encrypt_and_digest(msg)

    <span class=hljs-keyword >return</span> ct+tag+nonce

<span class=hljs-keyword >def</span> <span class="hljs-title function_">decrypt_msg</span>(<span class=hljs-params >msg</span>):
    ct = msg[:-<span class=hljs-number >28</span>]
    tag = msg[-<span class=hljs-number >28</span>:-<span class=hljs-number >12</span>]
    nonce = msg[-<span class=hljs-number >12</span>:]

    cipher = ChaCha20_Poly1305.new(key=CHACHA_KEY, nonce=nonce)
    pt = cipher.decrypt_and_verify(ct, tag)

    <span class=hljs-keyword >return</span> pt

<span class=hljs-keyword >def</span> <span class="hljs-title function_">calc_crc</span>(<span class=hljs-params >msg</span>):
    <span class=hljs-keyword >return</span> zlib.crc32(msg).to_bytes(<span class=hljs-number >4</span>, <span class=hljs-string >&quot;little&quot;</span>)

<span class=hljs-keyword >def</span> <span class="hljs-title function_">sha256</span>(<span class=hljs-params >msg</span>):
    <span class=hljs-keyword >return</span> hashlib.sha256(msg).digest()

RNG_INIT = secrets.token_bytes(<span class=hljs-number >512</span>)

<span class=hljs-keyword >class</span> <span class="hljs-title class_">DHCPServer</span>:
    <span class=hljs-keyword >def</span> <span class="hljs-title function_">__init__</span>(<span class=hljs-params >self</span>):
        self.leases = []
        self.ips = [<span class=hljs-string >f&quot;192.168.1.<span class=hljs-subst >{i}</span>&quot;</span> <span class=hljs-keyword >for</span> i <span class=hljs-keyword >in</span> <span class=hljs-built_in >range</span>(<span class=hljs-number >3</span>, <span class=hljs-number >64</span>)]
        self.mac = <span class=hljs-built_in >bytes</span>.fromhex(<span class=hljs-string >&quot;1b 7d 6f 49 37 c9&quot;</span>)
        self.gateway_ip = <span class=hljs-string >&quot;192.168.1.1&quot;</span>

        self.leases.append((<span class=hljs-string >&quot;192.168.1.2&quot;</span>, <span class=hljs-string >b&quot;rngserver_0&quot;</span>, time.time(), []))

    <span class=hljs-keyword >def</span> <span class="hljs-title function_">get_lease</span>(<span class=hljs-params >self, dev_name</span>):
        <span class=hljs-keyword >if</span> <span class=hljs-built_in >len</span>(self.ips) != <span class=hljs-number >0</span>:
            ip = self.ips.pop(<span class=hljs-number >0</span>)
            self.leases.append((ip, dev_name, time.time(), []))
        <span class=hljs-keyword >else</span>:
            <span class=hljs-comment ># relinquish the oldest lease</span>
            old_lease = self.leases.pop(<span class=hljs-number >0</span>)
            ip = old_lease[<span class=hljs-number >0</span>]
            self.leases.append((ip, dev_name, time.time(), []))

        pkt = <span class=hljs-built_in >bytearray</span>(
            <span class=hljs-built_in >bytes</span>([<span class=hljs-built_in >int</span>(x) <span class=hljs-keyword >for</span> x <span class=hljs-keyword >in</span> ip.split(<span class=hljs-string >&quot;.&quot;</span>)]) +
            <span class=hljs-built_in >bytes</span>([<span class=hljs-built_in >int</span>(x) <span class=hljs-keyword >for</span> x <span class=hljs-keyword >in</span> self.gateway_ip.split(<span class=hljs-string >&quot;.&quot;</span>)]) +
            <span class=hljs-built_in >bytes</span>([<span class=hljs-number >255</span>, <span class=hljs-number >255</span>, <span class=hljs-number >255</span>, <span class=hljs-number >0</span>]) +
            <span class=hljs-built_in >bytes</span>([<span class=hljs-number >8</span>, <span class=hljs-number >8</span>, <span class=hljs-number >8</span>, <span class=hljs-number >8</span>]) +
            <span class=hljs-built_in >bytes</span>([<span class=hljs-number >8</span>, <span class=hljs-number >8</span>, <span class=hljs-number >4</span>, <span class=hljs-number >4</span>]) +
            dev_name +
            <span class=hljs-string >b&quot;\x00&quot;</span>
        )

        pkt = <span class=hljs-string >b&quot;\x02&quot;</span> + encrypt_msg(pkt, self.get_entropy_from_lavalamps()) + calc_crc(pkt)

        <span class=hljs-keyword >return</span> pkt

    <span class=hljs-keyword >def</span> <span class="hljs-title function_">get_entropy_from_lavalamps</span>(<span class=hljs-params >self</span>):
        <span class=hljs-comment ># Get entropy from all available lava-lamp RNG servers</span>
        <span class=hljs-comment ># Falling back to local RNG if necessary</span>
        entropy_pool = RNG_INIT

        <span class=hljs-keyword >for</span> ip, name, ts, tags <span class=hljs-keyword >in</span> self.leases:
            <span class=hljs-keyword >if</span> <span class=hljs-string >b&quot;rngserver&quot;</span> <span class=hljs-keyword >in</span> name:
                <span class=hljs-keyword >try</span>:
                    <span class=hljs-comment ># get entropy from the server</span>
                    output = requests.get(<span class=hljs-string >f&quot;http://<span class=hljs-subst >{ip}</span>/get_rng&quot;</span>, timeout=TIMEOUT).text
                    entropy_pool += sha256(output.encode())
                <span class=hljs-keyword >except</span>:
                    <span class=hljs-comment ># if the server is broken, get randomness from local RNG instead</span>
                    entropy_pool += sha256(secrets.token_bytes(<span class=hljs-number >512</span>))

        <span class=hljs-keyword >return</span> sha256(entropy_pool)

    <span class=hljs-keyword >def</span> <span class="hljs-title function_">process_pkt</span>(<span class=hljs-params >self, pkt</span>):
        <span class=hljs-keyword >assert</span> pkt <span class=hljs-keyword >is</span> <span class=hljs-keyword >not</span> <span class=hljs-literal >None</span>

        src_mac = pkt[:<span class=hljs-number >6</span>]
        dst_mac = pkt[<span class=hljs-number >6</span>:<span class=hljs-number >12</span>]
        msg = pkt[<span class=hljs-number >12</span>:]

        <span class=hljs-keyword >if</span> dst_mac != self.mac:
            <span class=hljs-keyword >return</span> <span class=hljs-literal >None</span>

        <span class=hljs-keyword >if</span> src_mac == self.mac:
            <span class=hljs-keyword >return</span> <span class=hljs-literal >None</span>

        <span class=hljs-keyword >if</span> <span class=hljs-built_in >len</span>(msg) <span class=hljs-keyword >and</span> msg.startswith(<span class=hljs-string >b&quot;\x01&quot;</span>):
            <span class=hljs-comment ># lease request</span>
            dev_name = msg[<span class=hljs-number >1</span>:]
            lease_resp = self.get_lease(dev_name)
            <span class=hljs-keyword >return</span> (
                self.mac +
                src_mac + <span class=hljs-comment ># dest mac</span>
                lease_resp
            )
        <span class=hljs-keyword >else</span>:
            <span class=hljs-keyword >return</span> <span class=hljs-literal >None</span>

<span class=hljs-keyword >class</span> <span class="hljs-title class_">FlagServer</span>:
    <span class=hljs-keyword >def</span> <span class="hljs-title function_">__init__</span>(<span class=hljs-params >self, dhcp</span>):
        self.mac = <span class=hljs-built_in >bytes</span>.fromhex(<span class=hljs-string >&quot;53 79 82 b5 97 eb&quot;</span>)
        self.dns = dns.resolver.Resolver()
        self.process_pkt(dhcp.process_pkt(self.mac+dhcp.mac+<span class=hljs-string >b&quot;\x01&quot;</span>+<span class=hljs-string >b&quot;flag_server&quot;</span>))

    <span class=hljs-keyword >def</span> <span class="hljs-title function_">send_flag</span>(<span class=hljs-params >self</span>):
        <span class=hljs-keyword >with</span> <span class=hljs-built_in >open</span>(<span class=hljs-string >&quot;flag.txt&quot;</span>, <span class=hljs-string >&quot;r&quot;</span>) <span class=hljs-keyword >as</span> f:
            flag = f.read().strip()
        curl(<span class=hljs-string >&quot;example.com&quot;</span>, <span class=hljs-string >f&quot;/<span class=hljs-subst >{flag}</span>&quot;</span>, self.dns)

    <span class=hljs-keyword >def</span> <span class="hljs-title function_">process_pkt</span>(<span class=hljs-params >self, pkt</span>):
        <span class=hljs-keyword >assert</span> pkt <span class=hljs-keyword >is</span> <span class=hljs-keyword >not</span> <span class=hljs-literal >None</span>

        src_mac = pkt[:<span class=hljs-number >6</span>]
        dst_mac = pkt[<span class=hljs-number >6</span>:<span class=hljs-number >12</span>]
        msg = pkt[<span class=hljs-number >12</span>:]

        <span class=hljs-keyword >if</span> dst_mac != self.mac:
            <span class=hljs-keyword >return</span> <span class=hljs-literal >None</span>

        <span class=hljs-keyword >if</span> src_mac == self.mac:
            <span class=hljs-keyword >return</span> <span class=hljs-literal >None</span>

        <span class=hljs-keyword >if</span> <span class=hljs-built_in >len</span>(msg) <span class=hljs-keyword >and</span> msg.startswith(<span class=hljs-string >b&quot;\x02&quot;</span>):
            <span class=hljs-comment ># lease response</span>
            pkt = msg[<span class=hljs-number >1</span>:-<span class=hljs-number >4</span>]
            pkt = decrypt_msg(pkt)
            crc = msg[-<span class=hljs-number >4</span>:]
            <span class=hljs-keyword >assert</span> crc == calc_crc(pkt)

            self.ip = <span class=hljs-string >&quot;.&quot;</span>.join(<span class=hljs-built_in >str</span>(x) <span class=hljs-keyword >for</span> x <span class=hljs-keyword >in</span> pkt[<span class=hljs-number >0</span>:<span class=hljs-number >4</span>])
            self.gateway_ip = <span class=hljs-string >&quot;.&quot;</span>.join(<span class=hljs-built_in >str</span>(x) <span class=hljs-keyword >for</span> x <span class=hljs-keyword >in</span> pkt[<span class=hljs-number >4</span>:<span class=hljs-number >8</span>])
            self.subnet_mask = <span class=hljs-string >&quot;.&quot;</span>.join(<span class=hljs-built_in >str</span>(x) <span class=hljs-keyword >for</span> x <span class=hljs-keyword >in</span> pkt[<span class=hljs-number >8</span>:<span class=hljs-number >12</span>])
            self.dns1 = <span class=hljs-string >&quot;.&quot;</span>.join(<span class=hljs-built_in >str</span>(x) <span class=hljs-keyword >for</span> x <span class=hljs-keyword >in</span> pkt[<span class=hljs-number >12</span>:<span class=hljs-number >16</span>])
            self.dns2 = <span class=hljs-string >&quot;.&quot;</span>.join(<span class=hljs-built_in >str</span>(x) <span class=hljs-keyword >for</span> x <span class=hljs-keyword >in</span> pkt[<span class=hljs-number >16</span>:<span class=hljs-number >20</span>])
            self.dns.nameservers = [self.dns1, self.dns2]
            <span class=hljs-keyword >assert</span> pkt.endswith(<span class=hljs-string >b&quot;\x00&quot;</span>)

            <span class=hljs-built_in >print</span>(<span class=hljs-string >&quot;[FLAG SERVER] [DEBUG] Got DHCP lease&quot;</span>, self.ip, self.gateway_ip, self.subnet_mask, self.dns1, self.dns2)

            <span class=hljs-keyword >return</span> <span class=hljs-literal >None</span>

        <span class=hljs-keyword >elif</span> <span class=hljs-built_in >len</span>(msg) <span class=hljs-keyword >and</span> msg.startswith(<span class=hljs-string >b&quot;\x03&quot;</span>):
            <span class=hljs-comment ># FREE FLAGES!!!!!!!</span>
            self.send_flag()
            <span class=hljs-keyword >return</span> <span class=hljs-literal >None</span>

        <span class=hljs-keyword >else</span>:
            <span class=hljs-keyword >return</span> <span class=hljs-literal >None</span>

<span class=hljs-keyword >def</span> <span class="hljs-title function_">curl</span>(<span class=hljs-params >url, path, dns</span>):
    ip = <span class=hljs-built_in >str</span>(dns.resolve(url).response.resolve_chaining().answer).strip().split(<span class=hljs-string >&quot; &quot;</span>)[-<span class=hljs-number >1</span>]
    url = <span class=hljs-string >&quot;http://&quot;</span> + ip
    <span class=hljs-built_in >print</span>(<span class=hljs-string >f&quot;Sending flage to <span class=hljs-subst >{url}</span>&quot;</span>)
    requests.get(url + path)

<span class=hljs-keyword >if</span> __name__ == <span class=hljs-string >&quot;__main__&quot;</span>:
    dhcp = DHCPServer()
    flagserver = FlagServer(dhcp)

    <span class=hljs-keyword >while</span> <span class=hljs-literal >True</span>:
        pkt = <span class=hljs-built_in >bytes</span>.fromhex(<span class=hljs-built_in >input</span>(<span class=hljs-string >&quot;&gt; &quot;</span>).replace(<span class=hljs-string >&quot; &quot;</span>, <span class=hljs-string >&quot;&quot;</span>).strip())

        out = dhcp.process_pkt(pkt)
        <span class=hljs-keyword >if</span> out <span class=hljs-keyword >is</span> <span class=hljs-keyword >not</span> <span class=hljs-literal >None</span>:
            <span class=hljs-built_in >print</span>(out.<span class=hljs-built_in >hex</span>())

        out = flagserver.process_pkt(pkt)
        <span class=hljs-keyword >if</span> out <span class=hljs-keyword >is</span> <span class=hljs-keyword >not</span> <span class=hljs-literal >None</span>:
            <span class=hljs-built_in >print</span>(out.<span class=hljs-built_in >hex</span>())</code></pre> <p>At any time, can ask the flag server to make a request containing the flag to <code>example.com</code> by sending it a message beginning with <code>0x03</code>. The goal then, is to provide the flag server with a forged DHCP lease which contains a DNS server controlled by us. Then, when the flag server attempts to resolve <code>example.com</code> we can reply with an address we control, and intercept the following HTTP request.</p> <p>The DHCP leases are protected using <a href="https://en.wikipedia.org/wiki/ChaCha20-Poly1305">ChaCha20Poly1305</a>, which combines the ChaCha20 stream cipher with Poly1305 for authentication.</p> <div class=invert_image ><img src="https://upload.wikimedia.org/wikipedia/commons/5/55/ChaCha20-Poly1305_Encryption.svg" alt=ChaCha20Poly1305  /></div> <p>Since the encryption key remains constant throughout each session, we can forge messages if we can find two different ciphertexts encrypted using the same nonce. To protect against nonce reuse, the server employs two tactics. The first is the <code>get_entropy_from_lavalamps&#40;&#41;</code> function, which repeatedly extends and then hashes a persistent entropy pool.</p> <pre><code class="python hljs"><span class=hljs-keyword >def</span> <span class="hljs-title function_">get_entropy_from_lavalamps</span>(<span class=hljs-params >self</span>):
    <span class=hljs-comment ># Get entropy from all available lava-lamp RNG servers</span>
    <span class=hljs-comment ># Falling back to local RNG if necessary</span>
    entropy_pool = RNG_INIT

    <span class=hljs-keyword >for</span> ip, name, ts, tags <span class=hljs-keyword >in</span> self.leases:
        <span class=hljs-keyword >if</span> <span class=hljs-string >b&quot;rngserver&quot;</span> <span class=hljs-keyword >in</span> name:
            <span class=hljs-keyword >try</span>:
                <span class=hljs-comment ># get entropy from the server</span>
                output = requests.get(<span class=hljs-string >f&quot;http://<span class=hljs-subst >{ip}</span>/get_rng&quot;</span>, timeout=TIMEOUT).text
                entropy_pool += sha256(output.encode())
            <span class=hljs-keyword >except</span>:
                <span class=hljs-comment ># if the server is broken, get randomness from local RNG instead</span>
                entropy_pool += sha256(secrets.token_bytes(<span class=hljs-number >512</span>))

    <span class=hljs-keyword >return</span> sha256(entropy_pool)</code></pre> <p>The request made to the RNG server is never successful, and so the server will default back to Python&#39;s <code>secrets</code> module for randomness. Note however that the entropy pool only gets updated if there is an active lease containing the string <code>&quot;rngserver&quot;</code> in its device name. If no such lease exists, the entropy pool will remain constant across encryptions, opening up the potential for nonce reuse. Since the RNG server is the first client to receive a lease from the server, all we have to do is keep requesting additional leases until the server runs out of IP addresses and the RNG server&#39;s lease is relinquished.</p> <p>The second nonce-reuse mitigation comes from the <code>encrypt_msg&#40;&#41;</code> function, which hashes a portion of the message into the nonce. Here, <code>nonce</code> is the value obtained from the <code>get_entropy_from_lavalamps&#40;&#41;</code> function.</p> <pre><code class="python hljs"><span class=hljs-keyword >def</span> <span class="hljs-title function_">encrypt_msg</span>(<span class=hljs-params >msg, nonce</span>):
    <span class=hljs-comment ># In case our RNG nonce is repeated, we also hash</span>
    <span class=hljs-comment ># the message in. This means the worst-case scenario</span>
    <span class=hljs-comment ># is that our nonce reflects a hash of the message</span>
    <span class=hljs-comment ># but saves the chance of a nonce being reused across</span>
    <span class=hljs-comment ># different messages</span>
    nonce = sha256(msg[:<span class=hljs-number >32</span>] + nonce[:<span class=hljs-number >32</span>])[:<span class=hljs-number >12</span>]

    cipher = ChaCha20_Poly1305.new(key=CHACHA_KEY, nonce=nonce)
    ct, tag = cipher.encrypt_and_digest(msg)

    <span class=hljs-keyword >return</span> ct+tag+nonce</code></pre> <p>This means that to pull off our forgery attack, we must obtain two distinct ciphertexts for which the corresponding plaintexts are identical in the first 32 bytes. Fortunately this is fairly easy to do. The only information in the plaintext which changes across leases is the leased IP and the first twelve bytes of the device name. We can control the former by continuing to request leases until we are assigned the same IP again, and we can choose the latter at will.</p> <p>Now that we have a ciphertext pair <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mn>1</mn></msub><mo separator=true >,</mo><msub><mi>C</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">C_1, C_2</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.8778em;vertical-align:-0.1944em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.1667em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> encrypted with a shared nonce <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> and key <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span>, we can begin to forge messages. First, we have to replace the default DNS parameter <code>8.8.8.8</code> with the address of a server we control. Suppose <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mi>D</mi></msub></mrow><annotation encoding="application/x-tex">C_{D}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.8333em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is the ciphertext of the DNS parameter. Since the keystream <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi><mo stretchy=false >(</mo><mi>N</mi><mo separator=true >,</mo><mi>K</mi><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">E(N, K)</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class=mopen >(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class=mclose >)</span></span></span></span> depends only on the nonce and the key, we know that &#40;up to some offset in counter value&#41;, we have</p> <div class=nonumber ><span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mrow><mi>E</mi><mo stretchy=false >(</mo><mi>N</mi><mo separator=true >,</mo><mi>K</mi><mo stretchy=false >)</mo><mo>⊕</mo><mn>8.8.8.8</mn><mo>=</mo><msub><mi>C</mi><mi>D</mi></msub></mrow><annotation encoding="application/x-tex"> E(N, K) \oplus \mathrm{8.8.8.8} = C_D </annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class=mopen >(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >⊕</span><span class=mspace  style="margin-right:0.2222em;"></span></span><span class=base ><span class=strut  style="height:0.6444em;"></span><span class=mord ><span class="mord mathrm">8.8.8.8</span></span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2778em;"></span></span><span class=base ><span class=strut  style="height:0.8333em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></div> <p>and so</p> <div class=nonumber ><span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mrow><msub><mi>C</mi><mi>D</mi></msub><mo>⊕</mo><mn>8.8.8.8</mn><mo>⊕</mo><mtext>(chosen DNS)</mtext><mo>=</mo><mi>E</mi><mo stretchy=false >(</mo><mi>N</mi><mo separator=true >,</mo><mi>K</mi><mo stretchy=false >)</mo><mo>⊕</mo><mtext>(chosen DNS)</mtext><mi mathvariant=normal >.</mi></mrow><annotation encoding="application/x-tex"> C_D \oplus \mathrm{8.8.8.8} \oplus \text{(chosen DNS)} = E(N, K) \oplus \text{(chosen DNS)}. </annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.8333em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >⊕</span><span class=mspace  style="margin-right:0.2222em;"></span></span><span class=base ><span class=strut  style="height:0.7278em;vertical-align:-0.0833em;"></span><span class=mord ><span class="mord mathrm">8.8.8.8</span></span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >⊕</span><span class=mspace  style="margin-right:0.2222em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class=mord >(chosen DNS)</span></span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2778em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class=mopen >(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >⊕</span><span class=mspace  style="margin-right:0.2222em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class=mord >(chosen DNS)</span></span><span class=mord >.</span></span></span></span></span></div> <p>Hence replacing <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mi>D</mi></msub></mrow><annotation encoding="application/x-tex">C_D</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.8333em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> in the packet with <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mi>D</mi></msub><mo>⊕</mo><mn>8.8.8.8</mn><mo>⊕</mo><mtext>(chosen DNS)</mtext></mrow><annotation encoding="application/x-tex">C_D \oplus \mathrm{8.8.8.8} \oplus \text{(chosen DNS)}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.8333em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >⊕</span><span class=mspace  style="margin-right:0.2222em;"></span></span><span class=base ><span class=strut  style="height:0.7278em;vertical-align:-0.0833em;"></span><span class=mord ><span class="mord mathrm">8.8.8.8</span></span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >⊕</span><span class=mspace  style="margin-right:0.2222em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class=mord >(chosen DNS)</span></span></span></span></span> will cause the DNS parameter to decrypt to a server of our choosing.</p> <p>Finally, we have to recompute the Poly1305 tag so that our forged message authenticates as a genuine lease sent by the DHCP server. To do this, we must recover the Poly1305 keys used in the original authentication of <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">C_1</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.8333em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> and <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">C_2</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.8333em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>. </p> <p>In the general case, suppose <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi></mrow><annotation encoding="application/x-tex">C</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span> is a ciphertext composed of <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> 16-byte blocks <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>m</mi><mn>1</mn></msub><mo separator=true >,</mo><mo>…</mo><mo separator=true >,</mo><msub><mi>m</mi><mi>m</mi></msub></mrow><annotation encoding="application/x-tex">m_1, \ldots, m_m</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.625em;vertical-align:-0.1944em;"></span><span class=mord ><span class="mord mathnormal">m</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.1667em;"></span><span class=minner >…</span><span class=mspace  style="margin-right:0.1667em;"></span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.1667em;"></span><span class=mord ><span class="mord mathnormal">m</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> and let <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>m</mi><mrow><mi mathvariant=normal >m</mi><mi mathvariant=normal >e</mi><mi mathvariant=normal >t</mi><mi mathvariant=normal >a</mi></mrow></msub></mrow><annotation encoding="application/x-tex">m_{\mathrm{meta}}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.5806em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal">m</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">meta</span></span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> be a fixed metadata block containing ciphertext length information. Let <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi></mrow><annotation encoding="application/x-tex">r</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span> and <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi></mrow><annotation encoding="application/x-tex">s</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.4306em;"></span><span class="mord mathnormal">s</span></span></span></span> be the secret Poly1305 keys. Then the authentication tag is calculated as</p> <div class=nonumber ><span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mrow><mi>T</mi><mo>=</mo><mrow><mi mathvariant=normal >P</mi><mi mathvariant=normal >o</mi><mi mathvariant=normal >l</mi><mi mathvariant=normal >y</mi><mn>1305</mn></mrow><mo stretchy=false >(</mo><mi>C</mi><mo separator=true >,</mo><mi>r</mi><mo separator=true >,</mo><mi>s</mi><mo stretchy=false >)</mo><mo>=</mo><msub><mrow><mo fence=true >[</mo><mi>s</mi><mo>+</mo><msub><mrow><mo fence=true >[</mo><msub><mi>m</mi><mrow><mi mathvariant=normal >m</mi><mi mathvariant=normal >e</mi><mi mathvariant=normal >t</mi><mi mathvariant=normal >a</mi></mrow></msub><mo>+</mo><munderover><mo>∑</mo><mrow><mi>k</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><mrow><mi mathvariant=normal >p</mi><mi mathvariant=normal >a</mi><mi mathvariant=normal >d</mi></mrow><mo stretchy=false >(</mo><msub><mi>m</mi><mi>k</mi></msub><mo stretchy=false >)</mo><msup><mi>r</mi><mi>k</mi></msup><mo fence=true >]</mo></mrow><mi>p</mi></msub><mo fence=true >]</mo></mrow><msup><mn>2</mn><mn>128</mn></msup></msub></mrow><annotation encoding="application/x-tex"> T = \mathrm{Poly1305}(C, r, s) = \left[s + \left[m_{\mathrm{meta}} + \sum_{k = 1}^n \mathrm{pad}(m_k) r^k \right]_p\right]_{2^{128}} </annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2778em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mord ><span class="mord mathrm">Poly1305</span></span><span class=mopen >(</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.1667em;"></span><span class="mord mathnormal">s</span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2778em;"></span></span><span class=base ><span class=strut  style="height:3.6497em;vertical-align:-1.5997em;"></span><span class=minner ><span class=minner ><span class=mopen ><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:2.05em;"><span style="top:-2.25em;"><span class=pstrut  style="height:3.155em;"></span><span class="delimsizinginner delim-size4"><span>⎣</span></span></span><span style="top:-3.397em;"><span class=pstrut  style="height:3.155em;"></span><span style="height:0.016em;width:0.6667em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.6667em' height='0.016em' style='width:0.6667em' viewBox='0 0 666.67 16' preserveAspectRatio='xMinYMin'><path d='M319 0 H403 V16 H319z M319 0 H403 V16 H319z'/></svg></span></span><span style="top:-4.05em;"><span class=pstrut  style="height:3.155em;"></span><span class="delimsizinginner delim-size4"><span>⎡</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:1.55em;"><span></span></span></span></span></span></span><span class="mord mathnormal">s</span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222em;"></span><span class=minner ><span class=minner ><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">[</span></span><span class=mord ><span class="mord mathnormal">m</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">meta</span></span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:1.6514em;"><span style="top:-1.8479em;margin-left:0em;"><span class=pstrut  style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class=pstrut  style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class=pstrut  style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:1.3021em;"><span></span></span></span></span></span><span class=mspace  style="margin-right:0.1667em;"></span><span class=mord ><span class="mord mathrm">pad</span></span><span class=mopen >(</span><span class=mord ><span class="mord mathnormal">m</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mclose >)</span><span class=mord ><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8991em;"><span style="top:-3.113em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size4">]</span></span></span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:-1.0504em;"><span style="top:-1.3482em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:1.4879em;"><span></span></span></span></span></span></span><span class=mclose ><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:2.05em;"><span style="top:-2.25em;"><span class=pstrut  style="height:3.155em;"></span><span class="delimsizinginner delim-size4"><span>⎦</span></span></span><span style="top:-3.397em;"><span class=pstrut  style="height:3.155em;"></span><span style="height:0.016em;width:0.6667em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.6667em' height='0.016em' style='width:0.6667em' viewBox='0 0 666.67 16' preserveAspectRatio='xMinYMin'><path d='M263 0 H347 V16 H263z M263 0 H347 V16 H263z'/></svg></span></span><span style="top:-4.05em;"><span class=pstrut  style="height:3.155em;"></span><span class="delimsizinginner delim-size4"><span>⎤</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:1.55em;"><span></span></span></span></span></span></span></span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:-1.0773em;"><span style="top:-1.1003em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.7463em;"><span style="top:-2.786em;margin-right:0.0714em;"><span class=pstrut  style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">128</span></span></span></span></span></span></span></span></span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:1.5997em;"><span></span></span></span></span></span></span></span></span></span></span></div> <p>where <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span></span></span></span> is the prime <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>130</mn></msup><mo>−</mo><mn>5</mn></mrow><annotation encoding="application/x-tex">2^{130} - 5</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.8974em;vertical-align:-0.0833em;"></span><span class=mord ><span class=mord >2</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">130</span></span></span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >−</span><span class=mspace  style="margin-right:0.2222em;"></span></span><span class=base ><span class=strut  style="height:0.6444em;"></span><span class=mord >5</span></span></span></span> and the notation <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mo fence=true >[</mo><mspace width=1em /><mo fence=true >]</mo></mrow><mi>q</mi></msub></mrow><annotation encoding="application/x-tex">\left[ \quad\right]_q</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1.1858em;vertical-align:-0.4358em;"></span><span class=minner ><span class=minner ><span class="mopen delimcenter" style="top:0em;">[</span><span class=mspace  style="margin-right:1em;"></span><span class="mclose delimcenter" style="top:0em;">]</span></span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.0017em;"><span style="top:-2.4003em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.4358em;"><span></span></span></span></span></span></span></span></span></span> denotes reduction modulo <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>q</mi></mrow><annotation encoding="application/x-tex">q</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span></span></span></span>. Since the authentication tag is calculated as a polynomial in <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi></mrow><annotation encoding="application/x-tex">r</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span> and <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi></mrow><annotation encoding="application/x-tex">s</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.4306em;"></span><span class="mord mathnormal">s</span></span></span></span> with coefficients given by the ciphertext bytes, then given two distinct authentication tags <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">T_1</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.8333em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> and <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">T_2</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.8333em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> we can calculate </p> <div class=nonumber ><span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mrow><msub><mi>T</mi><mn>1</mn></msub><mo>−</mo><msub><mi>T</mi><mn>2</mn></msub><mo>=</mo><mrow><mi mathvariant=normal >P</mi><mi mathvariant=normal >o</mi><mi mathvariant=normal >l</mi><mi mathvariant=normal >y</mi><mn>1305</mn></mrow><mo stretchy=false >(</mo><msub><mi>C</mi><mn>1</mn></msub><mo separator=true >,</mo><mi>r</mi><mo separator=true >,</mo><mi>s</mi><mo stretchy=false >)</mo><mo>−</mo><mrow><mi mathvariant=normal >P</mi><mi mathvariant=normal >o</mi><mi mathvariant=normal >l</mi><mi mathvariant=normal >y</mi><mn>1305</mn></mrow><mo stretchy=false >(</mo><msub><mi>C</mi><mn>2</mn></msub><mo separator=true >,</mo><mi>r</mi><mo separator=true >,</mo><mi>s</mi><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex"> T_1 - T_2 = \mathrm{Poly1305}(C_1, r, s) - \mathrm{Poly1305}(C_2, r, s) </annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.8333em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >−</span><span class=mspace  style="margin-right:0.2222em;"></span></span><span class=base ><span class=strut  style="height:0.8333em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2778em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mord ><span class="mord mathrm">Poly1305</span></span><span class=mopen >(</span><span class=mord ><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.1667em;"></span><span class="mord mathnormal">s</span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >−</span><span class=mspace  style="margin-right:0.2222em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mord ><span class="mord mathrm">Poly1305</span></span><span class=mopen >(</span><span class=mord ><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.1667em;"></span><span class="mord mathnormal">s</span><span class=mclose >)</span></span></span></span></span></div> <p>which is a polynomial in <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi></mrow><annotation encoding="application/x-tex">r</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span> only. Finding the roots of this polynomial modulo <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span></span></span></span> yields possible values of <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi></mrow><annotation encoding="application/x-tex">r</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span> &#40;and hence <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi></mrow><annotation encoding="application/x-tex">s</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.4306em;"></span><span class="mord mathnormal">s</span></span></span></span>&#41;, up to a multiple of <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>128</mn></msup></mrow><annotation encoding="application/x-tex">2^{128}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.8141em;"></span><span class=mord ><span class=mord >2</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">128</span></span></span></span></span></span></span></span></span></span></span></span>. We can then narrow these possibilities down to a smaller subset containing the genuine values of <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi></mrow><annotation encoding="application/x-tex">r</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span> and <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi></mrow><annotation encoding="application/x-tex">s</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.4306em;"></span><span class="mord mathnormal">s</span></span></span></span> by considering only values which satisfy the <a href="https://datatracker.ietf.org/doc/html/rfc7539#section-2.5">clamping requirements</a> and which can correctly authenticate other genuine ciphertexts.</p> <p>In practice, the messages we were forging only differed in the last message block &#40;corresponding to a difference in device name&#41;. Hence the resulting polynomial <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>1</mn></msub><mo>−</mo><msub><mi>T</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">T_1 - T_2</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.8333em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >−</span><span class=mspace  style="margin-right:0.2222em;"></span></span><span class=base ><span class=strut  style="height:0.8333em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> was quadratic, and easily solvable over <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span></span></span></span> using only Python built-ins. Since we only had one chance to forge a lease, the low degree was also beneficial in that it reduced the number of roots, and so we were more likely to find the correct value of <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi></mrow><annotation encoding="application/x-tex">r</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span> on our first attempt.</p> <p>Once we have forged a DHCP lease, all that remains is to open a fake DNS server on port 53 which will resolve all requests back to ourselves, and then a listener on port 80 for the incoming HTTP request. For the DNS server I used Patryk Hes&#39;s <a href="https://github.com/pathes/fakedns/tree/master">fakedns</a> and for the listener I used <code>nc -lvnp 80</code>.</p> <p>Below is an implementation of the above solution in Python.</p> <pre><code class="python hljs"><span class=hljs-comment >#!/usr/bin/env python3</span>

<span class=hljs-keyword >import</span> time, zlib
<span class=hljs-keyword >import</span> secrets
<span class=hljs-keyword >import</span> hashlib
<span class=hljs-keyword >import</span> requests
<span class=hljs-keyword >from</span> Crypto.Cipher <span class=hljs-keyword >import</span> ChaCha20_Poly1305
<span class=hljs-keyword >from</span> Crypto.Util.strxor <span class=hljs-keyword >import</span> strxor
<span class=hljs-keyword >from</span> Crypto.Util.number <span class=hljs-keyword >import</span> *
<span class=hljs-keyword >import</span> dns.resolver
<span class=hljs-keyword >from</span> pwn <span class=hljs-keyword >import</span> *

CHACHA_KEY = secrets.token_bytes(<span class=hljs-number >32</span>)
TIMEOUT = <span class=hljs-number >1e-1</span>

context.log_level = <span class=hljs-string >&quot;debug&quot;</span>
conn = connect(<span class=hljs-string >&quot;dhcppp.chal.pwni.ng&quot;</span>, <span class=hljs-number >1337</span>)


<span class=hljs-keyword >def</span> <span class="hljs-title function_">encrypt_msg</span>(<span class=hljs-params >msg, nonce</span>):
    <span class=hljs-comment ># In case our RNG nonce is repeated, we also hash</span>
    <span class=hljs-comment ># the message in. This means the worst-case scenario</span>
    <span class=hljs-comment ># is that our nonce reflects a hash of the message</span>
    <span class=hljs-comment ># but saves the chance of a nonce being reused across</span>
    <span class=hljs-comment ># different messages</span>
    <span class=hljs-comment ># print(f&quot;DE<span class=hljs-doctag >BUG:</span> encrypt_msg on nonce[:32] = {nonce[:32]} and msg[:32] = {msg[:32]}&quot;)</span>
    nonce = sha256(msg[:<span class=hljs-number >32</span>] + nonce[:<span class=hljs-number >32</span>])[:<span class=hljs-number >12</span>]
    cipher = ChaCha20_Poly1305.new(key=CHACHA_KEY, nonce=nonce)
    ct, tag = cipher.encrypt_and_digest(msg)

    <span class=hljs-keyword >return</span> ct+tag+nonce

<span class=hljs-keyword >def</span> <span class="hljs-title function_">decrypt_msg</span>(<span class=hljs-params >msg</span>):
    ct = msg[:-<span class=hljs-number >28</span>]
    tag = msg[-<span class=hljs-number >28</span>:-<span class=hljs-number >12</span>]
    nonce = msg[-<span class=hljs-number >12</span>:]

    cipher = ChaCha20_Poly1305.new(key=CHACHA_KEY, nonce=nonce)
    pt = cipher.decrypt_and_verify(ct, tag)

    <span class=hljs-keyword >return</span> pt

<span class=hljs-keyword >def</span> <span class="hljs-title function_">calc_crc</span>(<span class=hljs-params >msg</span>):
    <span class=hljs-keyword >return</span> zlib.crc32(msg).to_bytes(<span class=hljs-number >4</span>, <span class=hljs-string >&quot;little&quot;</span>)

<span class=hljs-keyword >def</span> <span class="hljs-title function_">sha256</span>(<span class=hljs-params >msg</span>):
    <span class=hljs-keyword >return</span> hashlib.sha256(msg).digest()

RNG_INIT = secrets.token_bytes(<span class=hljs-number >512</span>)

<span class=hljs-keyword >class</span> <span class="hljs-title class_">DHCPServer</span>:
    <span class=hljs-comment ># -- same as in challenge script --</span>

<span class=hljs-keyword >class</span> <span class="hljs-title class_">FlagServer</span>:
    <span class=hljs-comment ># -- same as in challenge script --</span>

<span class=hljs-keyword >def</span> <span class="hljs-title function_">curl</span>(<span class=hljs-params >url, path, dns</span>):
    ip = <span class=hljs-built_in >str</span>(dns.resolve(url).response.resolve_chaining().answer).strip().split(<span class=hljs-string >&quot; &quot;</span>)[-<span class=hljs-number >1</span>]
    url = <span class=hljs-string >&quot;http://&quot;</span> + ip
    <span class=hljs-built_in >print</span>(<span class=hljs-string >f&quot;Sending flage to <span class=hljs-subst >{url}</span>&quot;</span>)
    requests.get(url + path)


<span class=hljs-keyword >def</span> <span class="hljs-title function_">get_flag</span>(<span class=hljs-params >dhcp, flagserver</span>):
    pkt = (
        dhcp.mac +              <span class=hljs-comment ># src_mac</span>
        flagserver.mac +        <span class=hljs-comment ># dst_mac</span>
        <span class=hljs-string >b&quot;\x03&quot;</span>                 <span class=hljs-comment ># msg: get flag</span>
    )

    conn.sendlineafter(<span class=hljs-string >b&quot;&gt; &quot;</span>, pkt.<span class=hljs-built_in >hex</span>().encode(<span class=hljs-string >&quot;utf-8&quot;</span>))


<span class=hljs-keyword >def</span> <span class="hljs-title function_">get_lease</span>(<span class=hljs-params >dhcp, flagserver, dev_name</span>):
    pkt = (
        flagserver.mac +              <span class=hljs-comment ># src_mac</span>
        dhcp.mac +                    <span class=hljs-comment ># dst_mac</span>
        <span class=hljs-string >b&quot;\x01&quot;</span> +                     <span class=hljs-comment ># msg: lease_request</span>
        dev_name                      <span class=hljs-comment ># dev_name</span>
    )

    conn.recvuntil(<span class=hljs-string >&quot;&gt; &quot;</span>)
    conn.sendline(pkt.<span class=hljs-built_in >hex</span>().encode(<span class=hljs-string >&quot;utf-8&quot;</span>))
    response = <span class=hljs-built_in >bytes</span>.fromhex(conn.recvline().strip().decode())
    <span class=hljs-keyword >return</span> response

<span class=hljs-keyword >def</span> <span class="hljs-title function_">parse_dhcp_lease</span>(<span class=hljs-params >pkt</span>):
    src_mac = pkt[:<span class=hljs-number >6</span>]
    dst_mac = pkt[<span class=hljs-number >6</span>:<span class=hljs-number >12</span>]
    msg = pkt[<span class=hljs-number >12</span>:]

    <span class=hljs-keyword >assert</span> <span class=hljs-built_in >len</span>(msg) <span class=hljs-keyword >and</span> msg.startswith(<span class=hljs-string >b&quot;\x02&quot;</span>)
    dhcp_type = msg[:<span class=hljs-number >1</span>]

    <span class=hljs-comment ># CRC</span>
    crc = msg[-<span class=hljs-number >4</span>:]
    <span class=hljs-comment ># assert crc == calc_crc(pkt) # flag server will check crc against decrypted packet</span>

    <span class=hljs-comment ># Encrypted portion</span>
    pkt = msg[<span class=hljs-number >1</span>:-<span class=hljs-number >4</span>]
    ct = pkt[:-<span class=hljs-number >28</span>]
    tag = pkt[-<span class=hljs-number >28</span>:-<span class=hljs-number >12</span>]
    nonce = pkt[-<span class=hljs-number >12</span>:]


    ip = ct[<span class=hljs-number >0</span>:<span class=hljs-number >4</span>]
    gateway_ip = ct[<span class=hljs-number >4</span>:<span class=hljs-number >8</span>]
    subnet_mask = ct[<span class=hljs-number >8</span>:<span class=hljs-number >12</span>]
    dns1 = ct[<span class=hljs-number >12</span>:<span class=hljs-number >16</span>]
    dns2 = ct[<span class=hljs-number >16</span>:<span class=hljs-number >20</span>]
    dev_name = ct[<span class=hljs-number >20</span>:-<span class=hljs-number >1</span>]
    null_byte = ct[-<span class=hljs-number >1</span>:]

    parsed = {
        <span class=hljs-string >&quot;src_mac&quot;</span>: src_mac,
        <span class=hljs-string >&quot;dst_mac&quot;</span>: dst_mac,
        <span class=hljs-string >&quot;dhcp_type&quot;</span>: dhcp_type,
        <span class=hljs-string >&quot;ip&quot;</span>: ip,
        <span class=hljs-string >&quot;gateway_ip&quot;</span>: gateway_ip,
        <span class=hljs-string >&quot;subnet_mask&quot;</span>: subnet_mask,
        <span class=hljs-string >&quot;dns1&quot;</span>: dns1,
        <span class=hljs-string >&quot;dns2&quot;</span>: dns2,
        <span class=hljs-string >&quot;dev_name&quot;</span>: dev_name,
        <span class=hljs-string >&quot;null_byte&quot;</span>: null_byte,
        <span class=hljs-string >&quot;ct&quot;</span>: ct,
        <span class=hljs-string >&quot;tag&quot;</span>: tag,
        <span class=hljs-string >&quot;nonce&quot;</span>: nonce,
        <span class=hljs-string >&quot;crc&quot;</span>: crc
    }

    <span class=hljs-keyword >return</span> parsed

<span class=hljs-keyword >def</span> <span class="hljs-title function_">serialise_dhcp_lease</span>(<span class=hljs-params >lease</span>):
    <span class=hljs-keyword >return</span> (
        lease[<span class=hljs-string >&quot;src_mac&quot;</span>] +
        lease[<span class=hljs-string >&quot;dst_mac&quot;</span>] +
        lease[<span class=hljs-string >&quot;dhcp_type&quot;</span>] +
        lease[<span class=hljs-string >&quot;ip&quot;</span>] +
        lease[<span class=hljs-string >&quot;gateway_ip&quot;</span>] +
        lease[<span class=hljs-string >&quot;subnet_mask&quot;</span>] +
        lease[<span class=hljs-string >&quot;dns1&quot;</span>] +
        lease[<span class=hljs-string >&quot;dns2&quot;</span>] +
        lease[<span class=hljs-string >&quot;dev_name&quot;</span>] +
        lease[<span class=hljs-string >&quot;null_byte&quot;</span>] +
        lease[<span class=hljs-string >&quot;tag&quot;</span>] +
        lease[<span class=hljs-string >&quot;nonce&quot;</span>] +
        lease[<span class=hljs-string >&quot;crc&quot;</span>]
    )

<span class=hljs-keyword >def</span> <span class="hljs-title function_">serialise_dhcp_lease_ct</span>(<span class=hljs-params >lease</span>):
    ct = (
        lease[<span class=hljs-string >&quot;ip&quot;</span>] +
        lease[<span class=hljs-string >&quot;gateway_ip&quot;</span>] +
        lease[<span class=hljs-string >&quot;subnet_mask&quot;</span>] +
        lease[<span class=hljs-string >&quot;dns1&quot;</span>] +
        lease[<span class=hljs-string >&quot;dns2&quot;</span>] +
        lease[<span class=hljs-string >&quot;dev_name&quot;</span>] +
        lease[<span class=hljs-string >&quot;null_byte&quot;</span>]
    )
    <span class=hljs-keyword >return</span> ct


<span class=hljs-keyword >def</span> <span class="hljs-title function_">serialise_ip</span>(<span class=hljs-params >ip</span>):
    <span class=hljs-keyword >return</span> <span class=hljs-built_in >bytes</span>([<span class=hljs-built_in >int</span>(x) <span class=hljs-keyword >for</span> x <span class=hljs-keyword >in</span> ip.split(<span class=hljs-string >&quot;.&quot;</span>)])

<span class=hljs-keyword >def</span> <span class="hljs-title function_">parse_ip</span>(<span class=hljs-params >ip</span>):
    <span class=hljs-keyword >return</span> <span class=hljs-string >&quot;.&quot;</span>.join(<span class=hljs-built_in >str</span>(x) <span class=hljs-keyword >for</span> x <span class=hljs-keyword >in</span> ip)

<span class=hljs-keyword >def</span> <span class="hljs-title function_">get_plaintext</span>(<span class=hljs-params >ip, gateway_ip, dns1, dev_name</span>):
    pkt = <span class=hljs-built_in >bytearray</span>(
        <span class=hljs-built_in >bytes</span>([<span class=hljs-built_in >int</span>(x) <span class=hljs-keyword >for</span> x <span class=hljs-keyword >in</span> ip.split(<span class=hljs-string >&quot;.&quot;</span>)]) + <span class=hljs-comment ># ip</span>
        <span class=hljs-built_in >bytes</span>([<span class=hljs-built_in >int</span>(x) <span class=hljs-keyword >for</span> x <span class=hljs-keyword >in</span> gateway_ip.split(<span class=hljs-string >&quot;.&quot;</span>)]) + <span class=hljs-comment ># gateway_ip</span>
        <span class=hljs-built_in >bytes</span>([<span class=hljs-number >255</span>, <span class=hljs-number >255</span>, <span class=hljs-number >255</span>, <span class=hljs-number >0</span>]) +                      <span class=hljs-comment ># subnet mask</span>
        serialise_ip(dns1) +                             <span class=hljs-comment ># nameserver 1</span>
        <span class=hljs-built_in >bytes</span>([<span class=hljs-number >8</span>, <span class=hljs-number >8</span>, <span class=hljs-number >4</span>, <span class=hljs-number >4</span>]) +                            <span class=hljs-comment ># nameserver 2</span>
        dev_name +
        <span class=hljs-string >b&quot;\x00&quot;</span>
    )

    <span class=hljs-keyword >return</span> <span class=hljs-built_in >bytes</span>(pkt)

<span class=hljs-keyword >def</span> <span class="hljs-title function_">grouper</span>(<span class=hljs-params >iterable, n, *, incomplete=<span class=hljs-string >&#x27;fill&#x27;</span>, fillvalue=<span class=hljs-literal >None</span></span>):
    <span class=hljs-string >&quot;Collect data into non-overlapping fixed-length chunks or blocks.&quot;</span>
    <span class=hljs-comment ># grouper(&#x27;ABCDEFG&#x27;, 3, fillvalue=&#x27;x&#x27;) → ABC DEF Gxx</span>
    <span class=hljs-comment ># grouper(&#x27;ABCDEFG&#x27;, 3, incomplete=&#x27;strict&#x27;) → ABC DEF ValueError</span>
    <span class=hljs-comment ># grouper(&#x27;ABCDEFG&#x27;, 3, incomplete=&#x27;ignore&#x27;) → ABC DEF</span>
    iterators = [<span class=hljs-built_in >iter</span>(iterable)] * n
    <span class=hljs-keyword >match</span> incomplete:
        <span class=hljs-keyword >case</span> <span class=hljs-string >&#x27;fill&#x27;</span>:
            <span class=hljs-keyword >return</span> zip_longest(*iterators, fillvalue=fillvalue)
        <span class=hljs-keyword >case</span> <span class=hljs-string >&#x27;strict&#x27;</span>:
            <span class=hljs-keyword >return</span> <span class=hljs-built_in >zip</span>(*iterators, strict=<span class=hljs-literal >True</span>)
        <span class=hljs-keyword >case</span> <span class=hljs-string >&#x27;ignore&#x27;</span>:
            <span class=hljs-keyword >return</span> <span class=hljs-built_in >zip</span>(*iterators)
        <span class=hljs-keyword >case</span> _:
            <span class=hljs-keyword >raise</span> ValueError(<span class=hljs-string >&#x27;Expected fill, strict, or ignore&#x27;</span>)

<span class=hljs-keyword >def</span> <span class="hljs-title function_">aead_chacha20_poly1305_message_construct</span>(<span class=hljs-params >ciphertext, aad</span>):
    padding1 = <span class=hljs-string >b&quot;\x00&quot;</span> * (-<span class=hljs-built_in >len</span>(aad) % <span class=hljs-number >16</span>)
    padding2 = <span class=hljs-string >b&quot;\x00&quot;</span> * (-<span class=hljs-built_in >len</span>(ciphertext) % <span class=hljs-number >16</span>)
    aad_length = p64(<span class=hljs-built_in >len</span>(aad))
    ciphertext_length = p64(<span class=hljs-built_in >len</span>(ciphertext))

    <span class=hljs-keyword >return</span> aad + padding1 + ciphertext + padding2 + aad_length + ciphertext_length


p = <span class=hljs-built_in >pow</span>(<span class=hljs-number >2</span>, <span class=hljs-number >130</span>) - <span class=hljs-number >5</span>
<span class=hljs-keyword >def</span> <span class="hljs-title function_">poly1305_poly</span>(<span class=hljs-params >message</span>):
    groups = grouper(<span class=hljs-built_in >bytearray</span>(message), <span class=hljs-number >16</span>, incomplete = <span class=hljs-string >&quot;strict&quot;</span>)
    coeffs = []

    <span class=hljs-keyword >for</span> m <span class=hljs-keyword >in</span> groups:
        m = <span class=hljs-built_in >bytes</span>(m)
        coeff = <span class=hljs-built_in >int</span>.from_bytes(m + <span class=hljs-string >b&quot;\x01&quot;</span>,<span class=hljs-string >&#x27;little&#x27;</span>) % p
        coeffs.append(coeff)
    <span class=hljs-keyword >return</span> coeffs

<span class=hljs-keyword >def</span> <span class="hljs-title function_">evalpoly</span>(<span class=hljs-params >point, coeffs, modulus = p</span>):
    <span class=hljs-comment ># Coeffs from big to small</span>
    acc = <span class=hljs-number >0</span>
    <span class=hljs-keyword >for</span> coeff <span class=hljs-keyword >in</span> coeffs:
        acc += coeff
        acc *= point
        acc = acc % p
    <span class=hljs-keyword >return</span> acc

<span class=hljs-keyword >def</span> <span class="hljs-title function_">forge_dhcp</span>(<span class=hljs-params >flagserver, lease, new_lease_dns, r, s, device_name, new_lease_dns_pt</span>):
    new_lease = lease | {<span class=hljs-string >&#x27;dns1&#x27;</span>: new_lease_dns}

    <span class=hljs-comment ># New ChaChaPoly1305 tag</span>
    new_lease_ct = serialise_dhcp_lease_ct(new_lease)
    message = aead_chacha20_poly1305_message_construct(new_lease_ct, <span class=hljs-string >b&quot;&quot;</span>)
    tag = (evalpoly(r, poly1305_poly(message)) + s) % <span class=hljs-built_in >pow</span>(<span class=hljs-number >2</span>, <span class=hljs-number >128</span>)
    new_lease[<span class=hljs-string >&#x27;tag&#x27;</span>] = <span class=hljs-built_in >int</span>.to_bytes(tag, <span class=hljs-number >16</span>, <span class=hljs-string >&#x27;little&#x27;</span>)

    <span class=hljs-comment ># New CRC</span>
    new_lease_pt = get_plaintext(<span class=hljs-string >&quot;192.168.1.3&quot;</span>, <span class=hljs-string >&quot;192.168.1.1&quot;</span>, new_lease_dns_pt, device_name)
    new_lease[<span class=hljs-string >&#x27;crc&#x27;</span>] = calc_crc(new_lease_pt)

    pkt = serialise_dhcp_lease(new_lease)

    conn.recvuntil(<span class=hljs-string >&quot;&gt; &quot;</span>)
    conn.sendline(pkt.<span class=hljs-built_in >hex</span>().encode(<span class=hljs-string >&quot;utf-8&quot;</span>))

<span class=hljs-keyword >def</span> <span class="hljs-title function_">solve</span>():
    dhcp = DHCPServer()
    flagserver = FlagServer(dhcp)

    <span class=hljs-comment ># Keep acquiring leases until the rng server&#x27;s lease is expired.</span>
    device_name = <span class=hljs-string >b&quot;X&quot;</span> * <span class=hljs-number >13</span>
    <span class=hljs-keyword >for</span> i <span class=hljs-keyword >in</span> <span class=hljs-built_in >range</span>(<span class=hljs-built_in >len</span>(dhcp.ips) + <span class=hljs-number >1</span>):
        get_lease(dhcp, flagserver, device_name)

    <span class=hljs-comment ># Now our entropy source is expired.</span>
    <span class=hljs-comment ># Acquire a lease. Any other lease with this ip will have a reused ChaCha20Poly1305 nonce.</span>
    lease = parse_dhcp_lease(get_lease(dhcp, flagserver, device_name))
    lease_ip = lease[<span class=hljs-string >&quot;ip&quot;</span>]
    lease_dns = lease[<span class=hljs-string >&quot;dns1&quot;</span>]

    <span class=hljs-comment ># We know that: keystream + &quot;8.8.8.8&quot; = lease_dns</span>
    <span class=hljs-comment ># lease_dns + &quot;8.8.8.8&quot; + &quot;our dns server&quot; = keystream + &quot;our dns server&quot;</span>
    new_lease_dns_pt = CISCOS_IP
    our_dns_server = serialise_ip(new_lease_dns_pt)
    google_dns_server = serialise_ip(<span class=hljs-string >&quot;8.8.8.8&quot;</span>)
    new_lease_dns = strxor(strxor(lease_dns, google_dns_server), our_dns_server)

    <span class=hljs-comment ># Now that we have our new dns server, we need to recompute the CRC and the authentication tag.</span>
    <span class=hljs-comment ># First, get another encryption using the same nonce</span>
    device_name2 = <span class=hljs-string >b&quot;X&quot;</span> * <span class=hljs-number >12</span> + <span class=hljs-string >b&quot;Y&quot;</span> * <span class=hljs-number >1</span>
    <span class=hljs-keyword >while</span> <span class=hljs-literal >True</span>:
        lease2 = parse_dhcp_lease(get_lease(dhcp, flagserver, device_name2))
        <span class=hljs-keyword >if</span> lease2[<span class=hljs-string >&quot;nonce&quot;</span>] == lease[<span class=hljs-string >&quot;nonce&quot;</span>]:
            <span class=hljs-keyword >break</span>

    <span class=hljs-comment ># Ciphertexts</span>
    ct1 = lease[<span class=hljs-string >&quot;ct&quot;</span>]
    ct2 = lease2[<span class=hljs-string >&quot;ct&quot;</span>]

    <span class=hljs-comment ># Tags</span>
    tag1 = <span class=hljs-built_in >int</span>.from_bytes(lease[<span class=hljs-string >&quot;tag&quot;</span>], <span class=hljs-string >&#x27;little&#x27;</span>)
    tag2 = <span class=hljs-built_in >int</span>.from_bytes(lease2[<span class=hljs-string >&quot;tag&quot;</span>], <span class=hljs-string >&#x27;little&#x27;</span>)

    <span class=hljs-comment ># Poly1305 inputs</span>
    message1 = aead_chacha20_poly1305_message_construct(ct1, <span class=hljs-string >b&quot;&quot;</span>)
    message2 = aead_chacha20_poly1305_message_construct(ct2, <span class=hljs-string >b&quot;&quot;</span>)

    <span class=hljs-comment ># Construct the corresponding Poly1305 </span>
    poly1 = poly1305_poly(message1)
    poly2 = poly1305_poly(message2)

    coeff1 = poly1[-<span class=hljs-number >2</span>]
    coeff2 = poly2[-<span class=hljs-number >2</span>]
    <span class=hljs-keyword >for</span> i <span class=hljs-keyword >in</span> <span class=hljs-built_in >range</span>(<span class=hljs-built_in >len</span>(poly1)):
        <span class=hljs-keyword >if</span> i != <span class=hljs-built_in >len</span>(poly1) - <span class=hljs-number >2</span>:
            <span class=hljs-keyword >assert</span> poly1[i] == poly2[i]

    <span class=hljs-comment ># (coeff1 - coeff2)r^2 = (tag1 - tag2) % pow(2, 128)</span>
    rs = []
    ss = []
    <span class=hljs-keyword >for</span> tag1_index <span class=hljs-keyword >in</span> <span class=hljs-built_in >range</span>(<span class=hljs-number >5</span>):
        tag1_s = (tag1 + <span class=hljs-built_in >pow</span>(<span class=hljs-number >2</span>, <span class=hljs-number >128</span>) * tag1_index) % p
        <span class=hljs-keyword >for</span> tag2_index <span class=hljs-keyword >in</span> <span class=hljs-built_in >range</span>(<span class=hljs-number >5</span>):
            tag2_s = (tag2 + <span class=hljs-built_in >pow</span>(<span class=hljs-number >2</span>, <span class=hljs-number >128</span>) * tag2_index) % p
            r_squared = ((inverse(coeff2 - coeff1, p) * (tag2_s - tag1_s)) % p)
            <span class=hljs-keyword >for</span> r <span class=hljs-keyword >in</span> [<span class=hljs-built_in >pow</span>(r_squared, (p + <span class=hljs-number >1</span>) // <span class=hljs-number >4</span>, p), -<span class=hljs-built_in >pow</span>(r_squared, (p + <span class=hljs-number >1</span>) // <span class=hljs-number >4</span>, p) % p]:
                s1 = (tag1_s - evalpoly(r, poly1)) % p
                s2 = (tag2_s - evalpoly(r, poly2)) % p
                <span class=hljs-keyword >if</span> s1 == s2:
                    rs.append(r)
                    ss.append(s1)

    ss = [s <span class=hljs-keyword >for</span> r, s <span class=hljs-keyword >in</span> <span class=hljs-built_in >zip</span>(rs, ss) <span class=hljs-keyword >if</span> (<span class=hljs-number >0x0ffffffc0ffffffc0ffffffc0fffffff</span> &amp; r) == r]
    rs = [r <span class=hljs-keyword >for</span> r <span class=hljs-keyword >in</span> rs <span class=hljs-keyword >if</span> (<span class=hljs-number >0x0ffffffc0ffffffc0ffffffc0fffffff</span> &amp; r) == r]

    <span class=hljs-comment ># Request a new lease and check if our keys can verify the message</span>
    <span class=hljs-keyword >for</span> _ <span class=hljs-keyword >in</span> <span class=hljs-built_in >range</span>(<span class=hljs-number >2</span>):
        char = long_to_bytes(<span class=hljs-number >0x61</span> + i)
        <span class=hljs-keyword >for</span> _ <span class=hljs-keyword >in</span> <span class=hljs-built_in >range</span>(<span class=hljs-number >100</span>):
            dummy_lease = parse_dhcp_lease(get_lease(dhcp, flagserver, <span class=hljs-string >b&quot;X&quot;</span> * <span class=hljs-number >12</span> + char))
            <span class=hljs-keyword >if</span> dummy_lease[<span class=hljs-string >&#x27;nonce&#x27;</span>] == lease[<span class=hljs-string >&#x27;nonce&#x27;</span>]:
                <span class=hljs-keyword >break</span>
        dummy_lease_ct = serialise_dhcp_lease_ct(dummy_lease)
        message = aead_chacha20_poly1305_message_construct(dummy_lease_ct, <span class=hljs-string >b&quot;&quot;</span>)

        <span class=hljs-keyword >for</span> r, s <span class=hljs-keyword >in</span> <span class=hljs-built_in >zip</span>(rs, ss):
            tag = (evalpoly(r, poly1305_poly(message)) + s) % <span class=hljs-built_in >pow</span>(<span class=hljs-number >2</span>, <span class=hljs-number >128</span>)
            tag = <span class=hljs-built_in >int</span>.to_bytes(tag, <span class=hljs-number >16</span>, <span class=hljs-string >&#x27;little&#x27;</span>)
            <span class=hljs-keyword >if</span> tag != dummy_lease[<span class=hljs-string >&#x27;tag&#x27;</span>]:
                rs.remove(r)
                ss.remove(s)

    <span class=hljs-keyword >for</span> r, s <span class=hljs-keyword >in</span> <span class=hljs-built_in >zip</span>(rs, ss):
        forge_dhcp(flagserver, lease, new_lease_dns, r, s, device_name, new_lease_dns_pt)
        <span class=hljs-keyword >break</span>

    get_flag(dhcp, flagserver)
    conn.recvall()</code></pre> <h3 id=flag ><a href="#flag" class=header-anchor >Flag</a></h3> <pre><code class="plaintext hljs">PCTF{d0nt_r3u5e_th3_n0nc3_d4839ed727736624}</code></pre>
<h2 id=paranormial_commitment_scheme ><a href="#paranormial_commitment_scheme" class=header-anchor >Paranormial Commitment Scheme</a></h2>
<p>This challenge is based on the <a href="https://en.wikipedia.org/wiki/Commitment_scheme#KZG_commitment">KZG commitment scheme</a> over <a href="https://github.com/zkcrypto/bls12_381">BLS12-381</a>, a pairing-friendly elliptic curve construction which trades-off pairing efficiency with security.</p>
<p>In the following, let <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span> and <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi></mrow><annotation encoding="application/x-tex">E</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span></span></span></span> be the field and elliptic curve defined by the BLS12-381 parameters, and let <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant=double-struck >G</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">\mathbb{G}_1</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.8389em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathbb">G</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> and <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant=double-struck >G</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">\mathbb{G}_2</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.8389em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathbb">G</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> be two additive cyclic subgroups of <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi><mo stretchy=false >(</mo><mover accent=true ><mi>K</mi><mo stretchy=true >‾</mo></mover><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">E(\overline{K})</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1.1333em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class=mopen >(</span><span class="mord overline"><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8833em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span><span style="top:-3.8033em;"><span class=pstrut  style="height:3em;"></span><span class=overline-line  style="border-bottom-width:0.04em;"></span></span></span></span></span></span><span class=mclose >)</span></span></span></span> of equal prime order, such that there exists a non-degenerate bilinear pairing <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi><mo>:</mo><msub><mi mathvariant=double-struck >G</mi><mn>1</mn></msub><mo>×</mo><msub><mi mathvariant=double-struck >G</mi><mn>2</mn></msub><mo>⟶</mo><msub><mi mathvariant=double-struck >G</mi><mi>T</mi></msub></mrow><annotation encoding="application/x-tex">e: \mathbb{G}_1 \times \mathbb{G}_2 \longrightarrow \mathbb{G}_T</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.4306em;"></span><span class="mord mathnormal">e</span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >:</span><span class=mspace  style="margin-right:0.2778em;"></span></span><span class=base ><span class=strut  style="height:0.8389em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathbb">G</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >×</span><span class=mspace  style="margin-right:0.2222em;"></span></span><span class=base ><span class=strut  style="height:0.8389em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathbb">G</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >⟶</span><span class=mspace  style="margin-right:0.2778em;"></span></span><span class=base ><span class=strut  style="height:0.8389em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathbb">G</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> into a third multiplicative cyclic group <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant=double-struck >G</mi><mi>T</mi></msub></mrow><annotation encoding="application/x-tex">\mathbb{G}_T</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.8389em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathbb">G</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>. More details of this construction can be found in <a href="https://github.com/zkcrypto/bls12_381">the crate documentation</a>.</p>
<p>For the KZG commitment, we follow the notation of the <a href="https://en.wikipedia.org/wiki/Commitment_scheme#KZG_commitment">Wikipedia article</a>. Let <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>G</mi></mrow><annotation encoding="application/x-tex">G</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6833em;"></span><span class="mord mathnormal">G</span></span></span></span> and <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>H</mi></mrow><annotation encoding="application/x-tex">H</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span></span></span></span> be the generators of <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant=double-struck >G</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">\mathbb{G}_1</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.8389em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathbb">G</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> and <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant=double-struck >G</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">\mathbb{G}_2</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.8389em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathbb">G</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> respectively. Let <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mo>∈</mo><mi>K</mi></mrow><annotation encoding="application/x-tex">t \in K</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6542em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">t</span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >∈</span><span class=mspace  style="margin-right:0.2778em;"></span></span><span class=base ><span class=strut  style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span> be a trapdoor value which is unknown and discarded after use, and assume that <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>G</mi><mo>⋅</mo><msup><mi>t</mi><mi>i</mi></msup></mrow><annotation encoding="application/x-tex">G \cdot t^i</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6833em;"></span><span class="mord mathnormal">G</span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >⋅</span><span class=mspace  style="margin-right:0.2222em;"></span></span><span class=base ><span class=strut  style="height:0.8247em;"></span><span class=mord ><span class="mord mathnormal">t</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8247em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span></span></span></span></span></span></span> and <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>H</mi><mo>⋅</mo><msup><mi>t</mi><mi>i</mi></msup></mrow><annotation encoding="application/x-tex">H \cdot t^i</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >⋅</span><span class=mspace  style="margin-right:0.2222em;"></span></span><span class=base ><span class=strut  style="height:0.8247em;"></span><span class=mord ><span class="mord mathnormal">t</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8247em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span></span></span></span></span></span></span> are known and shared for arbitrarily many positive integer values of <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span>.</p>
<p>The challenge program begins by first generating a random polynomial <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>p</mi><mo mathvariant=normal  lspace=0em  rspace=0em >′</mo></msup><mo stretchy=false >(</mo><mi>x</mi><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">p&#x27;(x)</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1.0019em;vertical-align:-0.25em;"></span><span class=mord ><span class="mord mathnormal">p</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class=mopen >(</span><span class="mord mathnormal">x</span><span class=mclose >)</span></span></span></span> over <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span>. It then augments <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>p</mi><mo mathvariant=normal  lspace=0em  rspace=0em >′</mo></msup><mo stretchy=false >(</mo><mi>x</mi><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">p&#x27;(x)</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1.0019em;vertical-align:-0.25em;"></span><span class=mord ><span class="mord mathnormal">p</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class=mopen >(</span><span class="mord mathnormal">x</span><span class=mclose >)</span></span></span></span> using the integer representation of the flag value <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>F</mi></mrow><annotation encoding="application/x-tex">F</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span></span></span></span> by calculating the polynomial</p>
<div class=nonumber ><span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mrow><mi>p</mi><mo stretchy=false >(</mo><mi>x</mi><mo stretchy=false >)</mo><mo>=</mo><msup><mi>p</mi><mo mathvariant=normal  lspace=0em  rspace=0em >′</mo></msup><mo stretchy=false >(</mo><mi>x</mi><mo stretchy=false >)</mo><mo>+</mo><mi>F</mi><mo>−</mo><msup><mi>p</mi><mo mathvariant=normal  lspace=0em  rspace=0em >′</mo></msup><mo stretchy=false >(</mo><mi>α</mi><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">
p(x) = p&#x27;(x) + F - p&#x27;(\alpha)
</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">p</span><span class=mopen >(</span><span class="mord mathnormal">x</span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2778em;"></span></span><span class=base ><span class=strut  style="height:1.0519em;vertical-align:-0.25em;"></span><span class=mord ><span class="mord mathnormal">p</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8019em;"><span style="top:-3.113em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class=mopen >(</span><span class="mord mathnormal">x</span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222em;"></span></span><span class=base ><span class=strut  style="height:0.7667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >−</span><span class=mspace  style="margin-right:0.2222em;"></span></span><span class=base ><span class=strut  style="height:1.0519em;vertical-align:-0.25em;"></span><span class=mord ><span class="mord mathnormal">p</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8019em;"><span style="top:-3.113em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class=mopen >(</span><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class=mclose >)</span></span></span></span></span></div>
<p>where <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi><mo>∈</mo><mi>K</mi></mrow><annotation encoding="application/x-tex">\alpha \in K</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >∈</span><span class=mspace  style="margin-right:0.2778em;"></span></span><span class=base ><span class=strut  style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span> is a fixed large constant. The challenge program then proceeds to perform a KZG commitment using the polynomial <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span></span></span></span>, revealing to us the commitment value</p>
<div class=nonumber ><span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mrow><mi>C</mi><mo>=</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><mn>255</mn></munderover><msub><mi>p</mi><mi>i</mi></msub><mi>G</mi><msup><mi>t</mi><mi>i</mi></msup></mrow><annotation encoding="application/x-tex">
C = \sum_{i = 0}^{255} p_iGt^i
</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2778em;"></span></span><span class=base ><span class=strut  style="height:3.0788em;vertical-align:-1.2777em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:1.8011em;"><span style="top:-1.8723em;margin-left:0em;"><span class=pstrut  style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.05em;"><span class=pstrut  style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class=pstrut  style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">255</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:1.2777em;"><span></span></span></span></span></span><span class=mspace  style="margin-right:0.1667em;"></span><span class=mord ><span class="mord mathnormal">p</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal">G</span><span class=mord ><span class="mord mathnormal">t</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8747em;"><span style="top:-3.113em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span></span></span></span></span></span></span></span></div>
<p>where the <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">p_i</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.625em;vertical-align:-0.1944em;"></span><span class=mord ><span class="mord mathnormal">p</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> are the coefficients of <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span></span></span></span> in ascending degree. The challenge program also provides us with 512 alleged proofs of the commitment&#39;s authenticity</p>
<div class=nonumber ><span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mrow><msub><mi>π</mi><mi>z</mi></msub><mo>=</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><mn>255</mn></munderover><msub><mi>q</mi><mrow><mi>i</mi><mo separator=true >,</mo><mi>z</mi></mrow></msub><mi>G</mi><msup><mi>t</mi><mi>i</mi></msup></mrow><annotation encoding="application/x-tex">
\pi_z = \sum_{i = 0}^{255}q_{i,z}Gt^i
</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.5806em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em;">z</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2778em;"></span></span><span class=base ><span class=strut  style="height:3.0788em;vertical-align:-1.2777em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:1.8011em;"><span style="top:-1.8723em;margin-left:0em;"><span class=pstrut  style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.05em;"><span class=pstrut  style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class=pstrut  style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">255</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:1.2777em;"><span></span></span></span></span></span><span class=mspace  style="margin-right:0.1667em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.04398em;">z</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mord mathnormal">G</span><span class=mord ><span class="mord mathnormal">t</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8747em;"><span style="top:-3.113em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span></span></span></span></span></span></span></span></div>
<p>where <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn><mo>≤</mo><mi>z</mi><mo>&lt;</mo><mn>512</mn></mrow><annotation encoding="application/x-tex">0 \leq z &lt; 512</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.7804em;vertical-align:-0.136em;"></span><span class=mord >0</span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >≤</span><span class=mspace  style="margin-right:0.2778em;"></span></span><span class=base ><span class=strut  style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >&lt;</span><span class=mspace  style="margin-right:0.2778em;"></span></span><span class=base ><span class=strut  style="height:0.6444em;"></span><span class=mord >512</span></span></span></span> and <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>q</mi><mrow><mi>i</mi><mo separator=true >,</mo><mi>z</mi></mrow></msub></mrow><annotation encoding="application/x-tex">q_{i,z}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.7167em;vertical-align:-0.2861em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.04398em;">z</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> are the coefficients of the polynomial</p>
<div class=nonumber ><span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mrow><msub><mi>q</mi><mi>z</mi></msub><mo stretchy=false >(</mo><mi>x</mi><mo stretchy=false >)</mo><mo>=</mo><mrow><mo fence=true >⌊</mo><mfrac><mrow><mi>p</mi><mo stretchy=false >(</mo><mi>x</mi><mo stretchy=false >)</mo></mrow><mrow><mi>x</mi><mo>−</mo><mi>z</mi></mrow></mfrac><mo fence=true >⌋</mo></mrow><mi mathvariant=normal >.</mi></mrow><annotation encoding="application/x-tex">
q_{z}(x) = \left\lfloor \frac{p(x)}{x - z}\right\rfloor.
</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em;">z</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mopen >(</span><span class="mord mathnormal">x</span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2778em;"></span></span><span class=base ><span class=strut  style="height:2.4em;vertical-align:-0.95em;"></span><span class=minner ><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">⌊</span></span><span class=mord ><span class="mopen nulldelimiter"></span><span class=mfrac ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:1.427em;"><span style="top:-2.314em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal">x</span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >−</span><span class=mspace  style="margin-right:0.2222em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span></span></span><span style="top:-3.23em;"><span class=pstrut  style="height:3em;"></span><span class=frac-line  style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal">p</span><span class=mopen >(</span><span class="mord mathnormal">x</span><span class=mclose >)</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.7693em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">⌋</span></span></span><span class=mspace  style="margin-right:0.1667em;"></span><span class=mord >.</span></span></span></span></span></div>
<p>Here <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy=false >⌊</mo><mspace width=1em /><mo stretchy=false >⌋</mo></mrow><annotation encoding="application/x-tex">\lfloor \quad \rfloor</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mopen >⌊</span><span class=mspace  style="margin-right:1em;"></span><span class=mclose >⌋</span></span></span></span> is used to denote the quotient after Euclidean division. Of the provided proofs, roughly two-thirds are genuine, and one third are have been obscured by &quot;paranomial activity&quot; and are just randomly generated values of <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span> and <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi><mo stretchy=false >(</mo><mi>K</mi><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">E(K)</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class=mopen >(</span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class=mclose >)</span></span></span></span>. </p>
<pre><code class="rust hljs"><span class=hljs-keyword >use</span> pairing_ce::{
    bls12_381::{Fr, G1Affine},
    ff::{Field, PrimeField}, CurveAffine, GenericCurveProjective,
};
<span class=hljs-keyword >use</span> paranormial::{Polynomial, Setup};
<span class=hljs-keyword >use</span> primitive_types::U256;
<span class=hljs-keyword >use</span> rand::{OsRng, Rng};
<span class=hljs-keyword >use</span> std::{
    fs::File,
    io::Read,
};

<span class=hljs-keyword >const</span> DEGREE: <span class=hljs-type >usize</span> = <span class=hljs-number >256</span>;
<span class=hljs-keyword >const</span> ALPHA: &amp;<span class=hljs-type >str</span> = <span class=hljs-string >&quot;1337133713371337133713371337133713371337133713371337133713371337133713371337&quot;</span>;

<span class=hljs-keyword >const</span> NUM_POINTS: <span class=hljs-type >usize</span> = <span class=hljs-number >512</span>;
<span class=hljs-keyword >const</span> PARANOMIAL_RATE: <span class=hljs-type >u32</span> = <span class=hljs-number >3</span>;

<span class=hljs-keyword >fn</span> <span class="hljs-title function_">main</span>() {
    <span class=hljs-keyword >let</span> <span class=hljs-variable >setup_path</span> = std::env::<span class="hljs-title function_ invoke__">args</span>().<span class="hljs-title function_ invoke__">nth</span>(<span class=hljs-number >1</span>).<span class="hljs-title function_ invoke__">expect</span>(<span class=hljs-string >&quot;no output file given&quot;</span>);
    <span class=hljs-keyword >let</span> <span class=hljs-variable >flag_path</span> = std::env::<span class="hljs-title function_ invoke__">args</span>().<span class="hljs-title function_ invoke__">nth</span>(<span class=hljs-number >2</span>).<span class="hljs-title function_ invoke__">expect</span>(<span class=hljs-string >&quot;no flag file given&quot;</span>);
    <span class=hljs-keyword >let</span> <span class=hljs-variable >output_path</span> = std::env::<span class="hljs-title function_ invoke__">args</span>().<span class="hljs-title function_ invoke__">nth</span>(<span class=hljs-number >3</span>).<span class="hljs-title function_ invoke__">expect</span>(<span class=hljs-string >&quot;no output file given&quot;</span>);

    <span class=hljs-keyword >let</span> <span class=hljs-variable >f</span> = File::<span class="hljs-title function_ invoke__">open</span>(setup_path).<span class="hljs-title function_ invoke__">unwrap</span>();
    <span class=hljs-keyword >let</span> <span class=hljs-variable >setup</span>: Setup = serde_json::<span class="hljs-title function_ invoke__">from_reader</span>(f).<span class="hljs-title function_ invoke__">expect</span>(<span class=hljs-string >&quot;error deserializing setup&quot;</span>);
    <span class=hljs-keyword >let</span> <span class=hljs-keyword >mut </span><span class=hljs-variable >poly</span> = Polynomial::<span class="hljs-title function_ invoke__">rand</span>(DEGREE);

    <span class=hljs-keyword >let</span> <span class=hljs-keyword >mut </span><span class=hljs-variable >f</span> = File::<span class="hljs-title function_ invoke__">open</span>(flag_path).<span class="hljs-title function_ invoke__">unwrap</span>();
    <span class=hljs-keyword >let</span> <span class=hljs-keyword >mut </span><span class=hljs-variable >flag</span> = [<span class=hljs-number >0u8</span>; <span class=hljs-number >32</span>];
    f.<span class="hljs-title function_ invoke__">read</span>(&amp;<span class=hljs-keyword >mut</span> flag).<span class="hljs-title function_ invoke__">expect</span>(<span class=hljs-string >&quot;error reading flag file&quot;</span>);

    <span class=hljs-keyword >let</span> <span class=hljs-variable >flag</span> = U256::<span class="hljs-title function_ invoke__">from_big_endian</span>(&amp;flag);
    <span class=hljs-keyword >let</span> <span class=hljs-keyword >mut </span><span class=hljs-variable >offset</span> = Fr::<span class="hljs-title function_ invoke__">from_str</span>(&amp;flag.<span class="hljs-title function_ invoke__">to_string</span>()).<span class="hljs-title function_ invoke__">unwrap</span>();

    <span class=hljs-keyword >let</span> <span class=hljs-variable >alpha</span> = Fr::<span class="hljs-title function_ invoke__">from_str</span>(ALPHA).<span class="hljs-title function_ invoke__">unwrap</span>();
    offset.<span class="hljs-title function_ invoke__">sub_assign</span>(&amp;poly.<span class="hljs-title function_ invoke__">evaluate</span>(alpha));
    poly.<span class="hljs-title function_ invoke__">add_scalar</span>(offset);

    <span class=hljs-keyword >let</span> <span class=hljs-variable >com</span> = poly.<span class="hljs-title function_ invoke__">commit</span>(&amp;setup);
    <span class=hljs-keyword >let</span> <span class=hljs-variable >f</span> = File::<span class="hljs-title function_ invoke__">create</span>(output_path).<span class="hljs-title function_ invoke__">unwrap</span>();

    <span class=hljs-keyword >let</span> <span class=hljs-keyword >mut </span><span class=hljs-variable >values</span> = <span class=hljs-type >Vec</span>::<span class="hljs-title function_ invoke__">with_capacity</span>(NUM_POINTS);
    <span class=hljs-keyword >for</span> <span class=hljs-variable >i</span> <span class=hljs-keyword >in</span> <span class=hljs-number >0</span>..NUM_POINTS {
        <span class=hljs-keyword >let</span> <span class=hljs-variable >z</span> = Fr::<span class="hljs-title function_ invoke__">from_str</span>(&amp;i.<span class="hljs-title function_ invoke__">to_string</span>()).<span class="hljs-title function_ invoke__">unwrap</span>();
        <span class=hljs-keyword >let</span> (<span class=hljs-keyword >mut</span> y, <span class=hljs-keyword >mut</span> proof) = poly.<span class="hljs-title function_ invoke__">prove</span>(&amp;setup, z);

        <span class=hljs-keyword >let</span> <span class=hljs-keyword >mut </span><span class=hljs-variable >rng</span> = OsRng::<span class="hljs-title function_ invoke__">new</span>().<span class="hljs-title function_ invoke__">unwrap</span>();
        <span class=hljs-keyword >if</span> rng.<span class="hljs-title function_ invoke__">gen_weighted_bool</span>(PARANOMIAL_RATE) {
            <span class=hljs-built_in >println!</span>(<span class=hljs-string >&quot;paranormial activity occured&quot;</span>);
            y = rng.gen::&lt;Fr&gt;();
            proof = G1Affine::<span class="hljs-title function_ invoke__">one</span>().<span class="hljs-title function_ invoke__">mul</span>(rng.gen::&lt;Fr&gt;()).<span class="hljs-title function_ invoke__">into_affine</span>();
        }
        values.<span class="hljs-title function_ invoke__">push</span>((y, proof));
    }

    serde_json::<span class="hljs-title function_ invoke__">to_writer</span>(f, &amp;(com, values)).<span class="hljs-title function_ invoke__">expect</span>(<span class=hljs-string >&quot;serialization failed&quot;</span>);
}</code></pre>
<p>To solve this challenge, we first observe that </p>
<div class=nonumber ><span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mrow><mi>p</mi><mo stretchy=false >(</mo><mi>α</mi><mo stretchy=false >)</mo><mo>=</mo><msup><mi>p</mi><mo mathvariant=normal  lspace=0em  rspace=0em >′</mo></msup><mo stretchy=false >(</mo><mi>α</mi><mo stretchy=false >)</mo><mo>+</mo><mi>F</mi><mo>−</mo><msup><mi>p</mi><mo mathvariant=normal  lspace=0em  rspace=0em >′</mo></msup><mo stretchy=false >(</mo><mi>α</mi><mo stretchy=false >)</mo><mo>=</mo><mi>F</mi><mo separator=true >,</mo></mrow><annotation encoding="application/x-tex">
p(\alpha) = p&#x27;(\alpha) + F - p&#x27;(\alpha) = F, 
</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">p</span><span class=mopen >(</span><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2778em;"></span></span><span class=base ><span class=strut  style="height:1.0519em;vertical-align:-0.25em;"></span><span class=mord ><span class="mord mathnormal">p</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8019em;"><span style="top:-3.113em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class=mopen >(</span><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222em;"></span></span><span class=base ><span class=strut  style="height:0.7667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >−</span><span class=mspace  style="margin-right:0.2222em;"></span></span><span class=base ><span class=strut  style="height:1.0519em;vertical-align:-0.25em;"></span><span class=mord ><span class="mord mathnormal">p</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8019em;"><span style="top:-3.113em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class=mopen >(</span><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2778em;"></span></span><span class=base ><span class=strut  style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class=mpunct >,</span></span></span></span></span></div>
<p>and so we can recover the flag if we can recover the polynomial <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span></span></span></span> and evaluate the point <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi></mrow><annotation encoding="application/x-tex">\alpha</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">α</span></span></span></span> on it. The values of <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mi>z</mi></msub></mrow><annotation encoding="application/x-tex">y_z</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.625em;vertical-align:-0.1944em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em;">z</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> revealed by the commitment scheme provide us with interpolation points for recoving the polynomial <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span></span></span></span>. For a 256-degree polynomial, 512 points with distinct abscissas should be more than sufficient to recover the polynomial. However approximately one third of the revealed <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mi>z</mi></msub></mrow><annotation encoding="application/x-tex">y_z</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.625em;vertical-align:-0.1944em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em;">z</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>&#39;s will be bogus randomly generated points which will throw off our interpolation, so we first need a way to distinguish genuine ordinates from randomly generated ones.</p>
<p>Luckily, this is what the KZG commitment scheme was designed for. Let <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mi>z</mi></msub></mrow><annotation encoding="application/x-tex">y_z</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.625em;vertical-align:-0.1944em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em;">z</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> be the revealed value of <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mo stretchy=false >(</mo><mi>z</mi><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">p(z)</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">p</span><span class=mopen >(</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class=mclose >)</span></span></span></span>. Following the <a href="https://en.wikipedia.org/wiki/Commitment_scheme#Verify">protocol</a>, we compute the pairings</p>
<div class=nonumber ><span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mrow><mi>e</mi><mo stretchy=false >(</mo><msub><mi>π</mi><mi>z</mi></msub><mo separator=true >,</mo><mi>H</mi><mo>⋅</mo><mi>t</mi><mo>−</mo><mi>H</mi><mo>⋅</mo><mi>z</mi><mo stretchy=false >)</mo><mo separator=true >,</mo><mspace linebreak=newline ></mspace><mi>e</mi><mo stretchy=false >(</mo><mi>C</mi><mo>−</mo><mi>G</mi><mo>⋅</mo><msub><mi>y</mi><mi>z</mi></msub><mo separator=true >,</mo><mi>H</mi><mo stretchy=false >)</mo><mi mathvariant=normal >.</mi></mrow><annotation encoding="application/x-tex">
e(\pi_z, H \cdot t - H \cdot z),\\
e(C - G \cdot y_z, H).
</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">e</span><span class=mopen >(</span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em;">z</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >⋅</span><span class=mspace  style="margin-right:0.2222em;"></span></span><span class=base ><span class=strut  style="height:0.6984em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">t</span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >−</span><span class=mspace  style="margin-right:0.2222em;"></span></span><span class=base ><span class=strut  style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >⋅</span><span class=mspace  style="margin-right:0.2222em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class=mclose >)</span><span class=mpunct >,</span></span><span class="mspace newline"></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">e</span><span class=mopen >(</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >−</span><span class=mspace  style="margin-right:0.2222em;"></span></span><span class=base ><span class=strut  style="height:0.6833em;"></span><span class="mord mathnormal">G</span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >⋅</span><span class=mspace  style="margin-right:0.2222em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em;">z</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class=mclose >)</span><span class=mord >.</span></span></span></span></span></div>
<p>If the revealed value is genuine, then these two pairings should be equal in <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant=double-struck >G</mi><mi>T</mi></msub></mrow><annotation encoding="application/x-tex">\mathbb{G}_T</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.8389em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathbb">G</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>. Once we have isolated the genuine interpolation points, we can then use Lagrange interpolation to reconstruct the polynomial <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span></span></span></span>, and evaluate <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>F</mi><mo>=</mo><mi>p</mi><mo stretchy=false >(</mo><mi>α</mi><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">F = p(\alpha)</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2778em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">p</span><span class=mopen >(</span><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class=mclose >)</span></span></span></span> to obtain the flag.</p>
<p>Note the challenge implementation differs from the protocol on the Wikipedia page somewhat in that provides</p>
<div class=nonumber ><span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mrow><msub><mi>q</mi><mi>z</mi></msub><mo stretchy=false >(</mo><mi>x</mi><mo stretchy=false >)</mo><mo>=</mo><mrow><mo fence=true >⌊</mo><mfrac><mrow><mi>p</mi><mo stretchy=false >(</mo><mi>x</mi><mo stretchy=false >)</mo></mrow><mrow><mi>x</mi><mo>−</mo><mi>z</mi></mrow></mfrac><mo fence=true >⌋</mo></mrow></mrow><annotation encoding="application/x-tex">
q_{z}(x) = \left\lfloor \frac{p(x)}{x - z}\right\rfloor
</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em;">z</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mopen >(</span><span class="mord mathnormal">x</span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2778em;"></span></span><span class=base ><span class=strut  style="height:2.4em;vertical-align:-0.95em;"></span><span class=minner ><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">⌊</span></span><span class=mord ><span class="mopen nulldelimiter"></span><span class=mfrac ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:1.427em;"><span style="top:-2.314em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal">x</span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >−</span><span class=mspace  style="margin-right:0.2222em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span></span></span><span style="top:-3.23em;"><span class=pstrut  style="height:3em;"></span><span class=frac-line  style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal">p</span><span class=mopen >(</span><span class="mord mathnormal">x</span><span class=mclose >)</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.7693em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">⌋</span></span></span></span></span></span></span></div>
<p>as the proof rather than</p>
<div class=nonumber ><span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mrow><msub><mi>q</mi><mi>z</mi></msub><mo stretchy=false >(</mo><mi>x</mi><mo stretchy=false >)</mo><mo>=</mo><mrow><mo fence=true >⌊</mo><mfrac><mrow><mi>p</mi><mo stretchy=false >(</mo><mi>x</mi><mo stretchy=false >)</mo><mo>−</mo><msub><mi>y</mi><mi>z</mi></msub></mrow><mrow><mi>x</mi><mo>−</mo><mi>z</mi></mrow></mfrac><mo fence=true >⌋</mo></mrow><mi mathvariant=normal >.</mi></mrow><annotation encoding="application/x-tex">
q_{z}(x) = \left\lfloor \frac{p(x) - y_z}{x - z}\right\rfloor.
</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em;">z</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mopen >(</span><span class="mord mathnormal">x</span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2778em;"></span></span><span class=base ><span class=strut  style="height:2.4em;vertical-align:-0.95em;"></span><span class=minner ><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">⌊</span></span><span class=mord ><span class="mopen nulldelimiter"></span><span class=mfrac ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:1.427em;"><span style="top:-2.314em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal">x</span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >−</span><span class=mspace  style="margin-right:0.2222em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span></span></span><span style="top:-3.23em;"><span class=pstrut  style="height:3em;"></span><span class=frac-line  style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal">p</span><span class=mopen >(</span><span class="mord mathnormal">x</span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >−</span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em;">z</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.7693em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">⌋</span></span></span><span class=mspace  style="margin-right:0.1667em;"></span><span class=mord >.</span></span></span></span></span></div>
<p>But both these quotients are in fact equal since <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mi>z</mi></msub></mrow><annotation encoding="application/x-tex">y_z</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.625em;vertical-align:-0.1944em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em;">z</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is a constant, and hence has degree less than the divisor.</p>
<p>Below is an implementation in Rust.</p>
<pre><code class="rust hljs"><span class=hljs-keyword >use</span> std::{fs::File, io::Read};

<span class=hljs-keyword >use</span> indicatif::ProgressIterator;
<span class=hljs-keyword >use</span> pairing_ce::{
    bls12_381::{Fr, FrRepr, G1Affine, G2Affine},
    ff::{Field, PrimeField},
    CurveAffine, CurveProjective,
};
<span class=hljs-keyword >use</span> paranormial::Setup;
<span class=hljs-keyword >use</span> primitive_types::U256;

<span class=hljs-keyword >const</span> ALPHA: &amp;<span class=hljs-type >str</span> = <span class=hljs-string >&quot;1337133713371337133713371337133713371337133713371337133713371337133713371337&quot;</span>;

<span class=hljs-keyword >fn</span> <span class="hljs-title function_">verify</span>(comm: &amp;G1Affine, y: &amp;Fr, proof: &amp;G1Affine, setup: &amp;Setup, z: Fr) <span class=hljs-punctuation >-&gt;</span> <span class=hljs-type >bool</span> {
    <span class=hljs-keyword >let</span> <span class=hljs-variable >ht</span> = setup.g2_base;
    <span class=hljs-keyword >let</span> <span class=hljs-variable >hz</span> = G2Affine::<span class="hljs-title function_ invoke__">one</span>().<span class="hljs-title function_ invoke__">mul</span>(z).<span class="hljs-title function_ invoke__">into_affine</span>();

    <span class=hljs-comment >// LHS = e(pi, Ht - Hi)</span>
    <span class=hljs-keyword >let</span> <span class=hljs-keyword >mut </span><span class=hljs-variable >lhs</span> = proof.<span class="hljs-title function_ invoke__">pairing_with</span>(&amp;ht);
    <span class=hljs-keyword >let</span> <span class=hljs-variable >pi_hz</span> = proof.<span class="hljs-title function_ invoke__">pairing_with</span>(&amp;hz).<span class="hljs-title function_ invoke__">inverse</span>().<span class="hljs-title function_ invoke__">unwrap</span>();
    lhs.<span class="hljs-title function_ invoke__">mul_assign</span>(&amp;pi_hz);

    <span class=hljs-comment >// RHS = e(C - Gy, H)</span>
    <span class=hljs-keyword >let</span> <span class=hljs-variable >h</span> = G2Affine::<span class="hljs-title function_ invoke__">one</span>();
    <span class=hljs-keyword >let</span> <span class=hljs-variable >gy</span> = G1Affine::<span class="hljs-title function_ invoke__">one</span>().<span class="hljs-title function_ invoke__">mul</span>(*y).<span class="hljs-title function_ invoke__">into_affine</span>();
    <span class=hljs-keyword >let</span> <span class=hljs-keyword >mut </span><span class=hljs-variable >rhs</span> = comm.<span class="hljs-title function_ invoke__">pairing_with</span>(&amp;h);
    <span class=hljs-keyword >let</span> <span class=hljs-variable >gy_h</span> = gy.<span class="hljs-title function_ invoke__">pairing_with</span>(&amp;h).<span class="hljs-title function_ invoke__">inverse</span>().<span class="hljs-title function_ invoke__">unwrap</span>();
    rhs.<span class="hljs-title function_ invoke__">mul_assign</span>(&amp;gy_h);

    lhs.<span class="hljs-title function_ invoke__">eq</span>(&amp;rhs)
}

<span class=hljs-keyword >fn</span> <span class="hljs-title function_">lagrange_interpolation</span>(points: <span class=hljs-type >Vec</span>&lt;(<span class=hljs-type >usize</span>, &amp;(Fr, G1Affine))&gt;, eval: Fr) <span class=hljs-punctuation >-&gt;</span> Fr {
    <span class=hljs-keyword >let</span> <span class=hljs-keyword >mut </span><span class=hljs-variable >res</span> = Fr::<span class="hljs-title function_ invoke__">zero</span>();
    <span class=hljs-keyword >let</span> <span class=hljs-variable >n</span>: <span class=hljs-type >usize</span> = points.<span class="hljs-title function_ invoke__">len</span>();

    <span class=hljs-keyword >for</span> <span class=hljs-variable >i</span> <span class=hljs-keyword >in</span> <span class=hljs-number >0</span>..n {
        <span class=hljs-keyword >if</span> <span class=hljs-keyword >let</span> <span class=hljs-variable >Some</span>((x_i, (y_i, _))) = points.<span class="hljs-title function_ invoke__">get</span>(i) {
            <span class=hljs-keyword >let</span> <span class=hljs-keyword >mut </span><span class=hljs-variable >prod_res</span> = Fr::<span class="hljs-title function_ invoke__">one</span>();

            <span class=hljs-keyword >for</span> <span class=hljs-variable >j</span> <span class=hljs-keyword >in</span> (<span class=hljs-number >0</span>..n)
                .<span class="hljs-title function_ invoke__">enumerate</span>()
                .<span class="hljs-title function_ invoke__">filter</span>(|&amp;(pos, _)| (pos != i))
                .<span class="hljs-title function_ invoke__">map</span>(|(_, e)| e)
            {
                <span class=hljs-comment >// alpha - x_j</span>
                <span class=hljs-keyword >let</span> <span class=hljs-keyword >mut </span><span class=hljs-variable >numerator</span> = eval.<span class="hljs-title function_ invoke__">clone</span>();
                <span class=hljs-keyword >let</span> <span class=hljs-variable >x_j</span> = points.<span class="hljs-title function_ invoke__">get</span>(j).<span class="hljs-title function_ invoke__">unwrap</span>().<span class=hljs-number >0</span>;
                <span class=hljs-keyword >let</span> <span class=hljs-variable >x_j</span> = Fr::<span class="hljs-title function_ invoke__">from_str</span>(&amp;x_j.<span class="hljs-title function_ invoke__">to_string</span>()).<span class="hljs-title function_ invoke__">unwrap</span>();
                numerator.<span class="hljs-title function_ invoke__">sub_assign</span>(&amp;x_j);

                <span class=hljs-comment >// x_i - x_j</span>
                <span class=hljs-keyword >let</span> <span class=hljs-keyword >mut </span><span class=hljs-variable >denominator</span> = Fr::<span class="hljs-title function_ invoke__">from_str</span>(&amp;x_i.<span class="hljs-title function_ invoke__">to_string</span>()).<span class="hljs-title function_ invoke__">unwrap</span>();
                denominator.<span class="hljs-title function_ invoke__">sub_assign</span>(&amp;x_j);
                denominator = denominator.<span class="hljs-title function_ invoke__">inverse</span>().<span class="hljs-title function_ invoke__">unwrap</span>();

                numerator.<span class="hljs-title function_ invoke__">mul_assign</span>(&amp;denominator);
                prod_res.<span class="hljs-title function_ invoke__">mul_assign</span>(&amp;numerator);
            }

            prod_res.<span class="hljs-title function_ invoke__">mul_assign</span>(&amp;y_i);
            res.<span class="hljs-title function_ invoke__">add_assign</span>(&amp;prod_res);
        }
    }
    res
}

<span class=hljs-keyword >fn</span> <span class="hljs-title function_">main</span>() {
    <span class=hljs-comment >// program args</span>
    <span class=hljs-keyword >let</span> <span class=hljs-variable >setup_path</span> = std::env::<span class="hljs-title function_ invoke__">args</span>().<span class="hljs-title function_ invoke__">nth</span>(<span class=hljs-number >1</span>).<span class="hljs-title function_ invoke__">expect</span>(<span class=hljs-string >&quot;no output file given&quot;</span>);
    <span class=hljs-keyword >let</span> <span class=hljs-variable >output_path</span> = std::env::<span class="hljs-title function_ invoke__">args</span>().<span class="hljs-title function_ invoke__">nth</span>(<span class=hljs-number >2</span>).<span class="hljs-title function_ invoke__">expect</span>(<span class=hljs-string >&quot;no output file given&quot;</span>);

    <span class=hljs-comment >// setup</span>
    <span class=hljs-keyword >let</span> <span class=hljs-variable >f</span> = File::<span class="hljs-title function_ invoke__">open</span>(setup_path).<span class="hljs-title function_ invoke__">unwrap</span>();
    <span class=hljs-keyword >let</span> <span class=hljs-variable >setup</span>: Setup = serde_json::<span class="hljs-title function_ invoke__">from_reader</span>(f).<span class="hljs-title function_ invoke__">expect</span>(<span class=hljs-string >&quot;error deserializing setup&quot;</span>);

    <span class=hljs-comment >// points / output</span>
    <span class=hljs-keyword >let</span> <span class=hljs-variable >f</span> = File::<span class="hljs-title function_ invoke__">open</span>(output_path).<span class="hljs-title function_ invoke__">unwrap</span>();
    <span class=hljs-keyword >let</span> (comm, values): (G1Affine, <span class=hljs-type >Vec</span>&lt;(Fr, G1Affine)&gt;) =
        serde_json::<span class="hljs-title function_ invoke__">from_reader</span>(f).<span class="hljs-title function_ invoke__">expect</span>(<span class=hljs-string >&quot;error deserializing output&quot;</span>);

    <span class=hljs-keyword >let</span> <span class=hljs-variable >valid_points</span>: <span class=hljs-type >Vec</span>&lt;(<span class=hljs-type >usize</span>, &amp;(Fr, G1Affine))&gt; = values
        .<span class="hljs-title function_ invoke__">iter</span>()
        .<span class="hljs-title function_ invoke__">enumerate</span>()
        .<span class="hljs-title function_ invoke__">progress</span>()
        .<span class="hljs-title function_ invoke__">filter</span>(|(z, (y, proof))| {
            <span class=hljs-keyword >let</span> <span class=hljs-variable >z</span> = Fr::<span class="hljs-title function_ invoke__">from_str</span>(&amp;z.<span class="hljs-title function_ invoke__">to_string</span>()).<span class="hljs-title function_ invoke__">unwrap</span>();
            <span class="hljs-title function_ invoke__">verify</span>(&amp;comm, y, proof, &amp;setup, z)
        })
        .<span class="hljs-title function_ invoke__">collect</span>();

    dbg!(&amp;valid_points.<span class="hljs-title function_ invoke__">len</span>());

    <span class=hljs-keyword >let</span> <span class=hljs-variable >f</span> = File::<span class="hljs-title function_ invoke__">create</span>(<span class=hljs-string >&quot;valid_points.json&quot;</span>).<span class="hljs-title function_ invoke__">unwrap</span>();
    serde_json::<span class="hljs-title function_ invoke__">to_writer</span>(f, &amp;valid_points).<span class="hljs-title function_ invoke__">expect</span>(<span class=hljs-string >&quot;serialization failed&quot;</span>);

    <span class=hljs-keyword >let</span> <span class=hljs-variable >alpha</span> = Fr::<span class="hljs-title function_ invoke__">from_str</span>(ALPHA).<span class="hljs-title function_ invoke__">unwrap</span>();
    <span class=hljs-keyword >let</span> <span class=hljs-variable >computed_flag</span> = <span class="hljs-title function_ invoke__">lagrange_interpolation</span>(valid_points, alpha);

    dbg!(computed_flag);
}</code></pre>
<h3 id=flag__2 ><a href="#flag__2" class=header-anchor >Flag</a></h3>
<pre><code class="plaintext hljs">PCTF{k4t3_d3t3cts_paran0rm1als}</code></pre>
<h2 id=mmorpg ><a href="#mmorpg" class=header-anchor >MMORPG </a></h2>
<p>In this challenge we are placed in a restricted Python environment where we are only permitted to evaluate a small subset of &quot;safe&quot; expressions. In particular, evaluating the <code>get_flag&#40;&#41;</code> function is deemed unsafe. Once the safety of an expression is determined, its hash is stored in a cache and future expressions exhibiting the same hash are not checked again for safety.</p>
<p>The goal then, is to pull off a second-preimage attack, where given an &quot;unsafe&quot; expression <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> containing a call to <code>get_flag&#40;&#41;</code>, we wish to find a &quot;safe&quot; expression <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>x</mi><mo mathvariant=normal  lspace=0em  rspace=0em >′</mo></msup></mrow><annotation encoding="application/x-tex">x&#x27;</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.7519em;"></span><span class=mord ><span class="mord mathnormal">x</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span> which hashes to the same value.</p>
<pre><code class="python hljs"><span class=hljs-keyword >from</span> functools <span class=hljs-keyword >import</span> reduce
<span class=hljs-keyword >from</span> operator <span class=hljs-keyword >import</span> xor
<span class=hljs-keyword >from</span> hashlib <span class=hljs-keyword >import</span> sha256
<span class=hljs-keyword >from</span> binascii <span class=hljs-keyword >import</span> hexlify, unhexlify

<span class=hljs-keyword >with</span> <span class=hljs-built_in >open</span>(<span class=hljs-string >&quot;flag&quot;</span>, <span class=hljs-string >&quot;r&quot;</span>) <span class=hljs-keyword >as</span> f:
  FLAG = f.read().strip()

BLOCK_SZ = <span class=hljs-number >32</span>
HBS = BLOCK_SZ // <span class=hljs-number >2</span>
<span class=hljs-keyword >assert</span> HBS % <span class=hljs-number >4</span> == <span class=hljs-number >0</span>

<span class=hljs-keyword >def</span> <span class="hljs-title function_">mpy</span>(<span class=hljs-params >x, y</span>):
  <span class=hljs-keyword >assert</span> <span class=hljs-number >0</span> &lt;= <span class=hljs-built_in >min</span>(x, y) &lt;= <span class=hljs-built_in >max</span>(x, y) &lt; <span class=hljs-number >256</span>
  p = <span class=hljs-number >0</span>
  <span class=hljs-keyword >for</span> _ <span class=hljs-keyword >in</span> <span class=hljs-built_in >range</span>(<span class=hljs-number >8</span>):
    <span class=hljs-keyword >if</span> y &amp; <span class=hljs-number >1</span> != <span class=hljs-number >0</span>:
      p ^= x
    x &lt;&lt;= <span class=hljs-number >1</span>
    <span class=hljs-keyword >if</span> x &amp; <span class=hljs-number >0x100</span> != <span class=hljs-number >0</span>:
      x ^= <span class=hljs-number >0x11d</span>
    y &gt;&gt;= <span class=hljs-number >1</span>
  <span class=hljs-keyword >return</span> p

M = [[<span class=hljs-number >0x04</span>, <span class=hljs-number >0x47</span>, <span class=hljs-number >0x8e</span>, <span class=hljs-number >0x01</span>], [<span class=hljs-number >0x47</span>, <span class=hljs-number >0x04</span>, <span class=hljs-number >0x01</span>, <span class=hljs-number >0x8e</span>], [<span class=hljs-number >0x8e</span>, <span class=hljs-number >0x01</span>, <span class=hljs-number >0x04</span>, <span class=hljs-number >0x47</span>], [<span class=hljs-number >0x01</span>, <span class=hljs-number >0x8e</span>, <span class=hljs-number >0x47</span>, <span class=hljs-number >0x04</span>]]
P = [<span class=hljs-number >10</span>, <span class=hljs-number >11</span>, <span class=hljs-number >12</span>, <span class=hljs-number >2</span>, <span class=hljs-number >14</span>, <span class=hljs-number >6</span>, <span class=hljs-number >15</span>, <span class=hljs-number >13</span>, <span class=hljs-number >8</span>, <span class=hljs-number >7</span>, <span class=hljs-number >9</span>, <span class=hljs-number >5</span>, <span class=hljs-number >0</span>, <span class=hljs-number >1</span>, <span class=hljs-number >4</span>, <span class=hljs-number >3</span>]
S = [<span class=hljs-number >6</span>, <span class=hljs-number >98</span>, <span class=hljs-number >179</span>, <span class=hljs-number >28</span>, <span class=hljs-number >64</span>, <span class=hljs-number >3</span>, <span class=hljs-number >110</span>, <span class=hljs-number >124</span>, <span class=hljs-number >194</span>, <span class=hljs-number >137</span>, <span class=hljs-number >105</span>, <span class=hljs-number >62</span>, <span class=hljs-number >19</span>, <span class=hljs-number >146</span>, <span class=hljs-number >82</span>, <span class=hljs-number >73</span>, <span class=hljs-number >199</span>, <span class=hljs-number >10</span>, <span class=hljs-number >33</span>, <span class=hljs-number >165</span>, <span class=hljs-number >151</span>, <span class=hljs-number >251</span>, <span class=hljs-number >97</span>, <span class=hljs-number >148</span>, <span class=hljs-number >101</span>, <span class=hljs-number >153</span>, <span class=hljs-number >252</span>, <span class=hljs-number >187</span>, <span class=hljs-number >103</span>, <span class=hljs-number >254</span>, <span class=hljs-number >5</span>, <span class=hljs-number >213</span>, <span class=hljs-number >100</span>, <span class=hljs-number >108</span>, <span class=hljs-number >142</span>, <span class=hljs-number >51</span>, <span class=hljs-number >68</span>, <span class=hljs-number >224</span>, <span class=hljs-number >16</span>, <span class=hljs-number >58</span>, <span class=hljs-number >183</span>, <span class=hljs-number >208</span>, <span class=hljs-number >55</span>, <span class=hljs-number >215</span>, <span class=hljs-number >128</span>, <span class=hljs-number >210</span>, <span class=hljs-number >107</span>, <span class=hljs-number >242</span>, <span class=hljs-number >80</span>, <span class=hljs-number >192</span>, <span class=hljs-number >36</span>, <span class=hljs-number >50</span>, <span class=hljs-number >157</span>, <span class=hljs-number >173</span>, <span class=hljs-number >45</span>, <span class=hljs-number >122</span>, <span class=hljs-number >106</span>, <span class=hljs-number >56</span>, <span class=hljs-number >104</span>, <span class=hljs-number >32</span>, <span class=hljs-number >195</span>, <span class=hljs-number >232</span>, <span class=hljs-number >132</span>, <span class=hljs-number >13</span>, <span class=hljs-number >155</span>, <span class=hljs-number >246</span>, <span class=hljs-number >35</span>, <span class=hljs-number >138</span>, <span class=hljs-number >66</span>, <span class=hljs-number >221</span>, <span class=hljs-number >2</span>, <span class=hljs-number >121</span>, <span class=hljs-number >227</span>, <span class=hljs-number >113</span>, <span class=hljs-number >203</span>, <span class=hljs-number >234</span>, <span class=hljs-number >228</span>, <span class=hljs-number >207</span>, <span class=hljs-number >196</span>, <span class=hljs-number >9</span>, <span class=hljs-number >225</span>, <span class=hljs-number >201</span>, <span class=hljs-number >184</span>, <span class=hljs-number >89</span>, <span class=hljs-number >248</span>, <span class=hljs-number >95</span>, <span class=hljs-number >129</span>, <span class=hljs-number >126</span>, <span class=hljs-number >8</span>, <span class=hljs-number >222</span>, <span class=hljs-number >49</span>, <span class=hljs-number >181</span>, <span class=hljs-number >154</span>, <span class=hljs-number >241</span>, <span class=hljs-number >217</span>, <span class=hljs-number >250</span>, <span class=hljs-number >0</span>, <span class=hljs-number >249</span>, <span class=hljs-number >38</span>, <span class=hljs-number >167</span>, <span class=hljs-number >57</span>, <span class=hljs-number >41</span>, <span class=hljs-number >59</span>, <span class=hljs-number >12</span>, <span class=hljs-number >185</span>, <span class=hljs-number >30</span>, <span class=hljs-number >39</span>, <span class=hljs-number >26</span>, <span class=hljs-number >7</span>, <span class=hljs-number >214</span>, <span class=hljs-number >238</span>, <span class=hljs-number >20</span>, <span class=hljs-number >198</span>, <span class=hljs-number >79</span>, <span class=hljs-number >166</span>, <span class=hljs-number >162</span>, <span class=hljs-number >159</span>, <span class=hljs-number >239</span>, <span class=hljs-number >193</span>, <span class=hljs-number >119</span>, <span class=hljs-number >189</span>, <span class=hljs-number >65</span>, <span class=hljs-number >54</span>, <span class=hljs-number >130</span>, <span class=hljs-number >1</span>, <span class=hljs-number >178</span>, <span class=hljs-number >93</span>, <span class=hljs-number >237</span>, <span class=hljs-number >133</span>, <span class=hljs-number >63</span>, <span class=hljs-number >223</span>, <span class=hljs-number >147</span>, <span class=hljs-number >92</span>, <span class=hljs-number >43</span>, <span class=hljs-number >163</span>, <span class=hljs-number >123</span>, <span class=hljs-number >141</span>, <span class=hljs-number >191</span>, <span class=hljs-number >168</span>, <span class=hljs-number >37</span>, <span class=hljs-number >15</span>, <span class=hljs-number >220</span>, <span class=hljs-number >211</span>, <span class=hljs-number >69</span>, <span class=hljs-number >244</span>, <span class=hljs-number >27</span>, <span class=hljs-number >86</span>, <span class=hljs-number >70</span>, <span class=hljs-number >240</span>, <span class=hljs-number >53</span>, <span class=hljs-number >160</span>, <span class=hljs-number >116</span>, <span class=hljs-number >144</span>, <span class=hljs-number >145</span>, <span class=hljs-number >11</span>, <span class=hljs-number >134</span>, <span class=hljs-number >21</span>, <span class=hljs-number >229</span>, <span class=hljs-number >233</span>, <span class=hljs-number >22</span>, <span class=hljs-number >17</span>, <span class=hljs-number >182</span>, <span class=hljs-number >109</span>, <span class=hljs-number >114</span>, <span class=hljs-number >206</span>, <span class=hljs-number >158</span>, <span class=hljs-number >131</span>, <span class=hljs-number >115</span>, <span class=hljs-number >52</span>, <span class=hljs-number >197</span>, <span class=hljs-number >175</span>, <span class=hljs-number >202</span>, <span class=hljs-number >186</span>, <span class=hljs-number >143</span>, <span class=hljs-number >180</span>, <span class=hljs-number >245</span>, <span class=hljs-number >169</span>, <span class=hljs-number >25</span>, <span class=hljs-number >88</span>, <span class=hljs-number >102</span>, <span class=hljs-number >236</span>, <span class=hljs-number >140</span>, <span class=hljs-number >226</span>, <span class=hljs-number >120</span>, <span class=hljs-number >125</span>, <span class=hljs-number >4</span>, <span class=hljs-number >235</span>, <span class=hljs-number >177</span>, <span class=hljs-number >164</span>, <span class=hljs-number >47</span>, <span class=hljs-number >171</span>, <span class=hljs-number >81</span>, <span class=hljs-number >118</span>, <span class=hljs-number >48</span>, <span class=hljs-number >61</span>, <span class=hljs-number >14</span>, <span class=hljs-number >172</span>, <span class=hljs-number >72</span>, <span class=hljs-number >18</span>, <span class=hljs-number >112</span>, <span class=hljs-number >91</span>, <span class=hljs-number >255</span>, <span class=hljs-number >76</span>, <span class=hljs-number >174</span>, <span class=hljs-number >205</span>, <span class=hljs-number >216</span>, <span class=hljs-number >75</span>, <span class=hljs-number >161</span>, <span class=hljs-number >243</span>, <span class=hljs-number >29</span>, <span class=hljs-number >99</span>, <span class=hljs-number >44</span>, <span class=hljs-number >46</span>, <span class=hljs-number >231</span>, <span class=hljs-number >42</span>, <span class=hljs-number >139</span>, <span class=hljs-number >136</span>, <span class=hljs-number >67</span>, <span class=hljs-number >83</span>, <span class=hljs-number >135</span>, <span class=hljs-number >204</span>, <span class=hljs-number >84</span>, <span class=hljs-number >247</span>, <span class=hljs-number >253</span>, <span class=hljs-number >60</span>, <span class=hljs-number >150</span>, <span class=hljs-number >77</span>, <span class=hljs-number >176</span>, <span class=hljs-number >190</span>, <span class=hljs-number >127</span>, <span class=hljs-number >96</span>, <span class=hljs-number >117</span>, <span class=hljs-number >34</span>, <span class=hljs-number >90</span>, <span class=hljs-number >188</span>, <span class=hljs-number >78</span>, <span class=hljs-number >74</span>, <span class=hljs-number >149</span>, <span class=hljs-number >230</span>, <span class=hljs-number >209</span>, <span class=hljs-number >200</span>, <span class=hljs-number >31</span>, <span class=hljs-number >219</span>, <span class=hljs-number >24</span>, <span class=hljs-number >23</span>, <span class=hljs-number >85</span>, <span class=hljs-number >111</span>, <span class=hljs-number >94</span>, <span class=hljs-number >218</span>, <span class=hljs-number >71</span>, <span class=hljs-number >170</span>, <span class=hljs-number >152</span>, <span class=hljs-number >212</span>, <span class=hljs-number >40</span>, <span class=hljs-number >87</span>, <span class=hljs-number >156</span>]

<span class=hljs-keyword >def</span> <span class="hljs-title function_">perm</span>(<span class=hljs-params >bs</span>):
  bs = <span class=hljs-built_in >list</span>(bs)
  <span class=hljs-keyword >assert</span> <span class=hljs-built_in >len</span>(bs) == HBS
  m = [bs[P[i]] <span class=hljs-keyword >for</span> i <span class=hljs-keyword >in</span> <span class=hljs-built_in >range</span>(<span class=hljs-built_in >len</span>(bs))]
  ns = []
  <span class=hljs-keyword >for</span> i <span class=hljs-keyword >in</span> <span class=hljs-built_in >range</span>(<span class=hljs-number >0</span>, <span class=hljs-built_in >len</span>(m), <span class=hljs-number >4</span>):
    ms = m[i:i+<span class=hljs-number >4</span>]
    ns.append([reduce(xor, [mpy(ms[j], M[i][j]) <span class=hljs-keyword >for</span> j <span class=hljs-keyword >in</span> <span class=hljs-built_in >range</span>(<span class=hljs-number >4</span>)]) <span class=hljs-keyword >for</span> i <span class=hljs-keyword >in</span> <span class=hljs-built_in >range</span>(<span class=hljs-number >4</span>)])
  <span class=hljs-keyword >return</span> reduce(<span class=hljs-keyword >lambda</span> a,b: a+b, ns)

<span class=hljs-keyword >def</span> <span class="hljs-title function_">x</span>(<span class=hljs-params >a, b</span>):
  <span class=hljs-keyword >return</span> <span class=hljs-built_in >bytes</span>([x ^ y <span class=hljs-keyword >for</span> (x, y) <span class=hljs-keyword >in</span> <span class=hljs-built_in >zip</span>(a, b)])

<span class=hljs-keyword >def</span> <span class="hljs-title function_">encrypt_block</span>(<span class=hljs-params >key, block</span>):
  <span class=hljs-keyword >assert</span> <span class=hljs-built_in >len</span>(block) == BLOCK_SZ
  <span class=hljs-keyword >assert</span> <span class=hljs-built_in >len</span>(key) == BLOCK_SZ
  a = sha256(key).digest()
  b = sha256(a).digest()
  c = sha256(b).digest()
  sks = [key[:HBS], key[HBS:], a[:HBS], a[HBS:], b[:HBS], b[HBS:], c[:HBS]]
  <span class=hljs-keyword >assert</span> <span class=hljs-built_in >all</span>(<span class=hljs-built_in >len</span>(x) == HBS <span class=hljs-keyword >for</span> x <span class=hljs-keyword >in</span> sks)
  L, R = block[:<span class=hljs-number >16</span>], block[<span class=hljs-number >16</span>:]
  L, R = x(perm(S[b] <span class=hljs-keyword >for</span> b <span class=hljs-keyword >in</span> x(R, sks[<span class=hljs-number >0</span>])), L), R
  L, R = L, x(perm(S[b] <span class=hljs-keyword >for</span> b <span class=hljs-keyword >in</span> x(L, sks[<span class=hljs-number >1</span>])), R)
  L, R = x(perm(S[b] <span class=hljs-keyword >for</span> b <span class=hljs-keyword >in</span> x(R, sks[<span class=hljs-number >2</span>])), L), R
  L, R = L, x(perm(S[b] <span class=hljs-keyword >for</span> b <span class=hljs-keyword >in</span> x(L, sks[<span class=hljs-number >3</span>])), R)
  L, R = x(perm(S[b] <span class=hljs-keyword >for</span> b <span class=hljs-keyword >in</span> x(R, sks[<span class=hljs-number >4</span>])), L), R
  L, R = L, x(perm(S[b] <span class=hljs-keyword >for</span> b <span class=hljs-keyword >in</span> x(L, sks[<span class=hljs-number >5</span>])), R)
  L, R = x(perm(S[b] <span class=hljs-keyword >for</span> b <span class=hljs-keyword >in</span> x(R, sks[<span class=hljs-number >6</span>])), L), R
  <span class=hljs-keyword >return</span> <span class=hljs-built_in >bytes</span>(L + R)

<span class=hljs-keyword >def</span> <span class="hljs-title function_">g</span>(<span class=hljs-params >h</span>):
  <span class=hljs-keyword >return</span> <span class=hljs-built_in >bytes</span>(h + <span class=hljs-built_in >bytes</span>([S[c] <span class=hljs-keyword >for</span> c <span class=hljs-keyword >in</span> h]))[:BLOCK_SZ]

<span class=hljs-keyword >def</span> <span class="hljs-title function_">hash</span>(<span class=hljs-params >start_key, data</span>):
  padding_needed = (BLOCK_SZ - (<span class=hljs-built_in >len</span>(data) % BLOCK_SZ))
  data = data + <span class=hljs-built_in >bytes</span>(padding_needed * [padding_needed])
  blocks = [data[i:i+BLOCK_SZ] <span class=hljs-keyword >for</span> i <span class=hljs-keyword >in</span> <span class=hljs-built_in >range</span>(<span class=hljs-number >0</span>, <span class=hljs-built_in >len</span>(data), BLOCK_SZ)]
  now = start_key
  <span class=hljs-keyword >for</span> block <span class=hljs-keyword >in</span> blocks:
    <span class=hljs-comment ># eh 128 bits is enough</span>
    now = x(encrypt_block(g(now), block), block)[-<span class=hljs-number >16</span>:]
  <span class=hljs-keyword >return</span> now

<span class=hljs-keyword >import</span> ast

SAFE_FUNCTIONS = <span class=hljs-built_in >set</span>([<span class=hljs-string >&quot;print&quot;</span>])
OP_MAP = {
  ast.Add: <span class=hljs-keyword >lambda</span> a,b: a + b,
  ast.Sub: <span class=hljs-keyword >lambda</span> a,b: a - b,
  ast.Mult: <span class=hljs-keyword >lambda</span> a,b: a * b,
}
<span class=hljs-keyword >def</span> <span class="hljs-title function_">check_expression_safety</span>(<span class=hljs-params >expr</span>):
  <span class=hljs-keyword >if</span> <span class=hljs-built_in >isinstance</span>(expr, ast.Call):
    func = expr.func
    <span class=hljs-keyword >if</span> func.<span class=hljs-built_in >id</span> <span class=hljs-keyword >not</span> <span class=hljs-keyword >in</span> SAFE_FUNCTIONS:
      <span class=hljs-keyword >return</span> <span class=hljs-literal >False</span>
    <span class=hljs-keyword >return</span> <span class=hljs-built_in >all</span>(
      check_expression_safety(arg) <span class=hljs-keyword >for</span> arg <span class=hljs-keyword >in</span> expr.args
    ) <span class=hljs-keyword >and</span> (<span class=hljs-built_in >len</span>(expr.keywords) == <span class=hljs-number >0</span>)
  <span class=hljs-keyword >elif</span> <span class=hljs-built_in >isinstance</span>(expr, ast.BinOp):
    <span class=hljs-keyword >if</span> <span class=hljs-keyword >not</span> <span class=hljs-built_in >any</span>(<span class=hljs-built_in >isinstance</span>(expr.op, typ) <span class=hljs-keyword >for</span> typ <span class=hljs-keyword >in</span> OP_MAP):
      <span class=hljs-keyword >return</span> <span class=hljs-literal >False</span>
    <span class=hljs-keyword >return</span> check_expression_safety(expr.left) <span class=hljs-keyword >and</span> check_expression_safety(expr.right)
  <span class=hljs-keyword >elif</span> <span class=hljs-built_in >isinstance</span>(expr, ast.Constant):
    <span class=hljs-keyword >return</span> <span class=hljs-built_in >isinstance</span>(expr.value, <span class=hljs-built_in >int</span>) <span class=hljs-keyword >or</span> <span class=hljs-built_in >isinstance</span>(expr.value, <span class=hljs-built_in >str</span>)
  <span class=hljs-keyword >return</span> <span class=hljs-literal >False</span>

<span class=hljs-keyword >def</span> <span class="hljs-title function_">check_if_safe</span>(<span class=hljs-params >cmd</span>):
  <span class=hljs-keyword >try</span>:
    mod = ast.parse(cmd)
    <span class=hljs-keyword >assert</span> <span class=hljs-built_in >len</span>(mod.body) == <span class=hljs-number >1</span> <span class=hljs-keyword >and</span> <span class=hljs-built_in >isinstance</span>(mod.body[<span class=hljs-number >0</span>], ast.Expr)
    <span class=hljs-keyword >return</span> check_expression_safety(mod.body[<span class=hljs-number >0</span>].value)
  <span class=hljs-keyword >except</span> (SyntaxError, UnicodeDecodeError):
    <span class=hljs-comment ># if it doesn&#x27;t parse, it won&#x27;t run</span>
    <span class=hljs-keyword >return</span> <span class=hljs-literal >True</span>

FUNC_MAP = {
  <span class=hljs-string >&quot;print&quot;</span>: <span class=hljs-built_in >print</span>,
  <span class=hljs-string >&quot;get_flag&quot;</span>: <span class=hljs-keyword >lambda</span>: FLAG
}
<span class=hljs-keyword >def</span> <span class="hljs-title function_">eval_expr</span>(<span class=hljs-params >expr</span>):
  <span class=hljs-keyword >if</span> <span class=hljs-built_in >isinstance</span>(expr, ast.Call):
    func = expr.func
    args = [eval_expr(arg) <span class=hljs-keyword >for</span> arg <span class=hljs-keyword >in</span> expr.args]
    <span class=hljs-keyword >return</span> FUNC_MAP[func.<span class=hljs-built_in >id</span>](*args)
  <span class=hljs-keyword >elif</span> <span class=hljs-built_in >isinstance</span>(expr, ast.BinOp):
    <span class=hljs-keyword >return</span> OP_MAP[<span class=hljs-built_in >type</span>(expr.op)](eval_expr(expr.left), eval_expr(expr.right))
  <span class=hljs-keyword >elif</span> <span class=hljs-built_in >isinstance</span>(expr, ast.Constant):
    <span class=hljs-keyword >if</span> <span class=hljs-built_in >isinstance</span>(expr.value, <span class=hljs-built_in >int</span>) <span class=hljs-keyword >or</span> <span class=hljs-built_in >isinstance</span>(expr.value, <span class=hljs-built_in >str</span>):
      <span class=hljs-keyword >return</span> expr.value
  <span class=hljs-keyword >raise</span> Exception(<span class=hljs-string >&quot;Something has gone wrong!&quot;</span>)

<span class=hljs-keyword >def</span> <span class="hljs-title function_">evaluate_safe</span>(<span class=hljs-params >cmd</span>):
  <span class=hljs-keyword >try</span>:
    mod = ast.parse(cmd)
    <span class=hljs-keyword >assert</span> <span class=hljs-built_in >len</span>(mod.body) == <span class=hljs-number >1</span> <span class=hljs-keyword >and</span> <span class=hljs-built_in >isinstance</span>(mod.body[<span class=hljs-number >0</span>], ast.Expr)
    <span class=hljs-keyword >return</span> eval_expr(mod.body[<span class=hljs-number >0</span>].value)
  <span class=hljs-keyword >except</span> (SyntaxError, UnicodeDecodeError):
    <span class=hljs-comment ># no parse, just fail</span>
    <span class=hljs-built_in >print</span>(<span class=hljs-string >&quot;There was a syntax error in your command - try a different one?&quot;</span>)

<span class=hljs-keyword >if</span> __name__ == <span class=hljs-string >&quot;__main__&quot;</span>:
  <span class=hljs-keyword >import</span> os
  START_KEY = os.urandom(BLOCK_SZ)
  <span class=hljs-built_in >print</span>(<span class=hljs-string >&quot;Hashing via key&quot;</span>, hexlify(START_KEY))
  safe_hashes = <span class=hljs-built_in >set</span>()
  <span class=hljs-keyword >for</span> _ <span class=hljs-keyword >in</span> <span class=hljs-built_in >range</span>(<span class=hljs-number >10</span>):
    <span class=hljs-built_in >print</span>(<span class=hljs-string >&quot;Send a hex-encoded command: &quot;</span>, end=<span class=hljs-string >&quot;&quot;</span>)
    command = unhexlify(<span class=hljs-built_in >input</span>())
    hsh = <span class=hljs-built_in >hash</span>(START_KEY, command)
    <span class=hljs-keyword >if</span> hsh <span class=hljs-keyword >in</span> safe_hashes <span class=hljs-keyword >or</span> check_if_safe(command):
      safe_hashes.add(hsh)
      <span class=hljs-built_in >print</span>(<span class=hljs-string >&quot;I think your command is safe!&quot;</span>)
      result = evaluate_safe(command)
      <span class=hljs-keyword >if</span> result <span class=hljs-keyword >is</span> <span class=hljs-keyword >not</span> <span class=hljs-literal >None</span>:
        <span class=hljs-built_in >print</span>(result)</code></pre>
<p>The hash function used in this challenge is a Merkle-Damgard construction where the one-way compression function is derived from a block cipher using a Matyas-Meyer-Oseas construction &#40;hence MMO in the challenge name&#41;. The block cipher itself is a 7-round Feistel cipher with round function given by a substitution permutation network bearing some similarity to AES. </p>
<p>Initial linear cryptanalysis of the S-box revealed no glaring weaknesses, so I focused my attention away from the round function and more on the peculiar combination of MMO and Feistel ciphers. After some searching, I came across <a href="https://iacr.org/archive/asiacrypt2007/48330316/48330316.pdf">this paper</a> by Knudsen and Rijmen which detailed the construction of known-key distinguishers on 7-round Feistel ciphers. The construction required the round function <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi></mrow><annotation encoding="application/x-tex">f</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span></span></span></span> be invertible &#40;or satisfying other nice properties&#41;, and that the second and sixth subkeys in the key schedule be not identical &#40;which is easily satisfied in practice&#41;. If these conditions are met, the construction computes two plaintexts denoted <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mo>=</mo><mo stretchy=false >(</mo><msub><mi>p</mi><mi>L</mi></msub><mo separator=true >,</mo><msub><mi>p</mi><mi>R</mi></msub><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">p = (p_L, p_R)</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2778em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mopen >(</span><span class=mord ><span class="mord mathnormal">p</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">L</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.1667em;"></span><span class=mord ><span class="mord mathnormal">p</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.00773em;">R</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mclose >)</span></span></span></span> and <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent=true ><mi>p</mi><mo>~</mo></mover><mo>=</mo><mo stretchy=false >(</mo><mover accent=true ><msub><mi>p</mi><mi>L</mi></msub><mo>~</mo></mover><mo separator=true >,</mo><mover accent=true ><msub><mi>p</mi><mi>R</mi></msub><mo>~</mo></mover><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">\tilde{p} = (\tilde{p_L}, \tilde{p_R})</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.8623em;vertical-align:-0.1944em;"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.6679em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class="mord mathnormal">p</span></span><span style="top:-3.35em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.1667em;"><span class=mord >~</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.1944em;"><span></span></span></span></span></span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2778em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mopen >(</span><span class="mord accent"><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.6679em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal">p</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">L</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span><span style="top:-3.35em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.25em;"><span class=mord >~</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.1944em;"><span></span></span></span></span></span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.1667em;"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.6679em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal">p</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.00773em;">R</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span><span style="top:-3.35em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.25em;"><span class=mord >~</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.1944em;"><span></span></span></span></span></span><span class=mclose >)</span></span></span></span> such that if <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mo>=</mo><mo stretchy=false >(</mo><msub><mi>c</mi><mi>L</mi></msub><mo separator=true >,</mo><msub><mi>c</mi><mi>R</mi></msub><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">c = (c_L, c_R)</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.4306em;"></span><span class="mord mathnormal">c</span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2778em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mopen >(</span><span class=mord ><span class="mord mathnormal">c</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">L</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.1667em;"></span><span class=mord ><span class="mord mathnormal">c</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.00773em;">R</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mclose >)</span></span></span></span> and <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent=true ><mi>c</mi><mo>~</mo></mover><mo>=</mo><mo stretchy=false >(</mo><mover accent=true ><msub><mi>c</mi><mi>L</mi></msub><mo>~</mo></mover><mo separator=true >,</mo><mover accent=true ><msub><mi>c</mi><mi>R</mi></msub><mo>~</mo></mover><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">\tilde{c} = (\tilde{c_L}, \tilde{c_R})</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6679em;"></span><span class="mord accent"><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.6679em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class="mord mathnormal">c</span></span><span style="top:-3.35em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.1944em;"><span class=mord >~</span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2778em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mopen >(</span><span class="mord accent"><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.6679em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal">c</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">L</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span><span style="top:-3.35em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.25em;"><span class=mord >~</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.1667em;"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.6679em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal">c</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.00773em;">R</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span><span style="top:-3.35em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.25em;"><span class=mord >~</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span><span class=mclose >)</span></span></span></span> are the corresponding &#40;Feistel-cipher&#41; ciphertexts, then we have </p>
<div class=nonumber ><span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mrow><msub><mi>p</mi><mi>R</mi></msub><mo>⊕</mo><msub><mi>c</mi><mi>R</mi></msub><mo>=</mo><mover accent=true ><msub><mi>p</mi><mi>R</mi></msub><mo>~</mo></mover><mo>⊕</mo><mover accent=true ><msub><mi>c</mi><mi>R</mi></msub><mo>~</mo></mover><mi mathvariant=normal >.</mi></mrow><annotation encoding="application/x-tex">
p_R \oplus c_R = \tilde{p_R} \oplus \tilde{c_R}.
</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.7778em;vertical-align:-0.1944em;"></span><span class=mord ><span class="mord mathnormal">p</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.00773em;">R</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >⊕</span><span class=mspace  style="margin-right:0.2222em;"></span></span><span class=base ><span class=strut  style="height:0.5806em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal">c</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.00773em;">R</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2778em;"></span></span><span class=base ><span class=strut  style="height:0.8623em;vertical-align:-0.1944em;"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.6679em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal">p</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.00773em;">R</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span><span style="top:-3.35em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.25em;"><span class=mord >~</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.1944em;"><span></span></span></span></span></span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >⊕</span><span class=mspace  style="margin-right:0.2222em;"></span></span><span class=base ><span class=strut  style="height:0.8179em;vertical-align:-0.15em;"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.6679em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal">c</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.00773em;">R</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span><span style="top:-3.35em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.25em;"><span class=mord >~</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span><span class=mord >.</span></span></span></span></span></div>
<p>When applied to an MMO context, this gives us a collision attack on the lower-half of the hash output. Luckily, the hash function <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>H</mi></mrow><annotation encoding="application/x-tex">H</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span></span></span></span> used in the challenge conveniently discards the upper-half of the hash output, so our partial collision attack becomes a full collision attack, with</p>
<div class=nonumber ><span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mtable rowspacing=0.25em  columnalign="right left" columnspacing=0em ><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mi>H</mi><mo stretchy=false >(</mo><mi>K</mi><mo separator=true >,</mo><mi>p</mi><mo stretchy=false >)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mo>=</mo><msub><mi>p</mi><mi>R</mi></msub><mo>⊕</mo><msub><mi>c</mi><mi>R</mi></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mi>H</mi><mo stretchy=false >(</mo><mi>K</mi><mo separator=true >,</mo><mover accent=true ><mi>p</mi><mo>~</mo></mover><mo stretchy=false >)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mo>=</mo><mover accent=true ><msub><mi>p</mi><mi>R</mi></msub><mo>~</mo></mover><mo>⊕</mo><mover accent=true ><msub><mi>c</mi><mi>R</mi></msub><mo>~</mo></mover></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
H(K, p) &amp;= p_R \oplus c_R\\
H(K, \tilde{p}) &amp;= \tilde{p_R} \oplus \tilde{c_R}
\end{aligned}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:3em;vertical-align:-1.25em;"></span><span class=mord ><span class=mtable ><span class=col-align-r ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:1.75em;"><span style="top:-3.91em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class=mopen >(</span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.1667em;"></span><span class="mord mathnormal">p</span><span class=mclose >)</span></span></span><span style="top:-2.41em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class=mopen >(</span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.1667em;"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.6679em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class="mord mathnormal">p</span></span><span style="top:-3.35em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.1667em;"><span class=mord >~</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.1944em;"><span></span></span></span></span></span><span class=mclose >)</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:1.25em;"><span></span></span></span></span></span><span class=col-align-l ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:1.75em;"><span style="top:-3.91em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ></span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mord ><span class="mord mathnormal">p</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.00773em;">R</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >⊕</span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mord ><span class="mord mathnormal">c</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.00773em;">R</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.41em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ></span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2778em;"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.6679em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal">p</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.00773em;">R</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span><span style="top:-3.35em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.25em;"><span class=mord >~</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.1944em;"><span></span></span></span></span></span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >⊕</span><span class=mspace  style="margin-right:0.2222em;"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.6679em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal">c</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.00773em;">R</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span><span style="top:-3.35em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.25em;"><span class=mord >~</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:1.25em;"><span></span></span></span></span></span></span></span></span></span></span></span></div>
<p>as desired.</p>
<p>To implement this attack, we will first needed to invert the round function <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi></mrow><annotation encoding="application/x-tex">f</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span></span></span></span> used in the Feistel cipher. Fortunately, the S-box and permutation components of the SPN were fairly simple to invert and the diffusion step in the <code>perm&#40;&#41;</code> function greatly resembled the <a href="https://en.wikipedia.org/wiki/Rijndael_MixColumns">MixColumns</a> operation in AES in that both consisted of matrix multiplication in a particular finite field of order <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>8</mn></msup></mrow><annotation encoding="application/x-tex">2^8</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.8141em;"></span><span class=mord ><span class=mord >2</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">8</span></span></span></span></span></span></span></span></span></span></span>. Compare for example the <code>mpy&#40;&#41;</code> function from the challenge code, and a C# implementation of multiplication in Rijindael&#39;s finite field.</p>
<pre><code class="python hljs"><span class=hljs-keyword >def</span> <span class="hljs-title function_">mpy</span>(<span class=hljs-params >x, y</span>):
  <span class=hljs-keyword >assert</span> <span class=hljs-number >0</span> &lt;= <span class=hljs-built_in >min</span>(x, y) &lt;= <span class=hljs-built_in >max</span>(x, y) &lt; <span class=hljs-number >256</span>
  p = <span class=hljs-number >0</span>
  <span class=hljs-keyword >for</span> _ <span class=hljs-keyword >in</span> <span class=hljs-built_in >range</span>(<span class=hljs-number >8</span>):
    <span class=hljs-keyword >if</span> y &amp; <span class=hljs-number >1</span> != <span class=hljs-number >0</span>:
      p ^= x
    x &lt;&lt;= <span class=hljs-number >1</span>
    <span class=hljs-keyword >if</span> x &amp; <span class=hljs-number >0x100</span> != <span class=hljs-number >0</span>:
      x ^= <span class=hljs-number >0x11d</span>
    y &gt;&gt;= <span class=hljs-number >1</span>
  <span class=hljs-keyword >return</span> p</code></pre>
<pre><code class="csharp hljs"><span class=hljs-function ><span class=hljs-keyword >private</span> <span class=hljs-built_in >byte</span> <span class=hljs-title >GMul</span>(<span class=hljs-params ><span class=hljs-built_in >byte</span> a, <span class=hljs-built_in >byte</span> b</span>)</span> { 
    <span class=hljs-built_in >byte</span> p = <span class=hljs-number >0</span>;

    <span class=hljs-keyword >for</span> (<span class=hljs-built_in >int</span> counter = <span class=hljs-number >0</span>; counter &lt; <span class=hljs-number >8</span>; counter++) {
        <span class=hljs-keyword >if</span> ((b &amp; <span class=hljs-number >1</span>) != <span class=hljs-number >0</span>) {
            p ^= a;
        }

        <span class=hljs-built_in >bool</span> hi_bit_set = (a &amp; <span class=hljs-number >0x80</span>) != <span class=hljs-number >0</span>;
        a &lt;&lt;= <span class=hljs-number >1</span>;
        <span class=hljs-keyword >if</span> (hi_bit_set) {
            a ^= <span class=hljs-number >0x1B</span>; <span class=hljs-comment >/* x^8 + x^4 + x^3 + x + 1 */</span>
        }
        b &gt;&gt;= <span class=hljs-number >1</span>;
    }

    <span class=hljs-keyword >return</span> p;
}</code></pre>
<p>The only difference between the field multiplication used by the round function and Rijindael is the finite field modulus has been changed from <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>x</mi><mn>8</mn></msup><mo>+</mo><msup><mi>x</mi><mn>4</mn></msup><mo>+</mo><msup><mi>x</mi><mn>3</mn></msup><mo>+</mo><mi>x</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">x^8 + x^4 + x^3 + x + 1</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.8974em;vertical-align:-0.0833em;"></span><span class=mord ><span class="mord mathnormal">x</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">8</span></span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222em;"></span></span><span class=base ><span class=strut  style="height:0.8974em;vertical-align:-0.0833em;"></span><span class=mord ><span class="mord mathnormal">x</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222em;"></span></span><span class=base ><span class=strut  style="height:0.8974em;vertical-align:-0.0833em;"></span><span class=mord ><span class="mord mathnormal">x</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222em;"></span></span><span class=base ><span class=strut  style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">x</span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222em;"></span></span><span class=base ><span class=strut  style="height:0.6444em;"></span><span class=mord >1</span></span></span></span> to <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>x</mi><mn>8</mn></msup><mo>+</mo><msup><mi>x</mi><mn>4</mn></msup><mo>+</mo><msup><mi>x</mi><mn>3</mn></msup><mo>+</mo><msup><mi>x</mi><mn>2</mn></msup><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">x^8 + x^4 + x^3 + x^2 + 1</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.8974em;vertical-align:-0.0833em;"></span><span class=mord ><span class="mord mathnormal">x</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">8</span></span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222em;"></span></span><span class=base ><span class=strut  style="height:0.8974em;vertical-align:-0.0833em;"></span><span class=mord ><span class="mord mathnormal">x</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222em;"></span></span><span class=base ><span class=strut  style="height:0.8974em;vertical-align:-0.0833em;"></span><span class=mord ><span class="mord mathnormal">x</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222em;"></span></span><span class=base ><span class=strut  style="height:0.8974em;vertical-align:-0.0833em;"></span><span class=mord ><span class="mord mathnormal">x</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222em;"></span></span><span class=base ><span class=strut  style="height:0.6444em;"></span><span class=mord >1</span></span></span></span>. Besides this, we can invert this step in much the same way as inverting AES.</p>
<p>With a collision attack in hand, we are now ready to complete the challenge by finding a hash collision between a &quot;safe&quot; expression and an &quot;unsafe&quot; expression containing a call to <code>get_flag&#40;&#41;</code>. The key vulnerability in the server&#39;s expression handling lies in the following function.</p>
<pre><code class="python hljs"><span class=hljs-keyword >def</span> <span class="hljs-title function_">check_if_safe</span>(<span class=hljs-params >cmd</span>):
  <span class=hljs-keyword >try</span>:
    mod = ast.parse(cmd)
    <span class=hljs-keyword >assert</span> <span class=hljs-built_in >len</span>(mod.body) == <span class=hljs-number >1</span> <span class=hljs-keyword >and</span> <span class=hljs-built_in >isinstance</span>(mod.body[<span class=hljs-number >0</span>], ast.Expr)
    <span class=hljs-keyword >return</span> check_expression_safety(mod.body[<span class=hljs-number >0</span>].value)
  <span class=hljs-keyword >except</span> (SyntaxError, UnicodeDecodeError):
    <span class=hljs-comment ># if it doesn&#x27;t parse, it won&#x27;t run</span>
    <span class=hljs-keyword >return</span> <span class=hljs-literal >True</span></code></pre>
<p>If a <code>cmd</code> is passed which results in a <code>SyntaxError</code> or a <code>UnicodeDecodeError</code>, then the server will deem that command to be safe under the assumption that it won&#39;t be able to be run. This means that we can pass two commands of the form</p>
<ul>
<li><p><code>p_hat &#43; b&quot;\nget_flag&#40;&#41;</code></p>

<li><p><code>p &#43; b&quot;\nget_flag&#40;&#41;</code>,</p>

</ul>
<p>where <code>p</code> and <code>p_hat</code> are obtained from the collision attack above. Hence both expressions will have the same hash value. </p>
<p>Since we have little control over <code>p</code> and <code>p_hat</code>, there is a good chance that both of them will contain invalid Unicode characters. Hence, it is likely that an error will be raised when the server attempts to parse <code>p_hat &#43; b&quot;\nget_flag&#40;&#41;</code>, causing it to mark the hash as &quot;safe&quot;. </p>
<p>Afterwards, we can pass the command <code>p &#43; b&quot;\nget_flag&#40;&#41;</code> to the server. Since its hash is the same as the previous command, the server will continue to execute without checking again for safety. </p>
<p>For most values of <code>p</code>, this will again result in an error, since it is unlikely that <code>p</code> consists of valid Unicode, let alone valid Python source code. However if the first character of <code>p</code> is the comment character <code>#</code>, then any syntax errors in <code>p</code> are ignored, and execution begins starting from the next physical line, causing <code>get_flag&#40;&#41;</code> to be executed&#33; </p>
<p>The probability that the first character of <code>p</code> is a <code>#</code> is roughly 1 in 256, so we can brute force for such a <code>p</code> locally with little effort. Below is an implementation in Python putting all the pieces together.</p>
<pre><code class="python hljs"><span class=hljs-comment >#!/usr/bin/env sage</span>
<span class=hljs-keyword >from</span> functools <span class=hljs-keyword >import</span> reduce
<span class=hljs-keyword >import</span> pwn
<span class=hljs-keyword >from</span> operator <span class=hljs-keyword >import</span> xor
<span class=hljs-keyword >from</span> hashlib <span class=hljs-keyword >import</span> sha256
<span class=hljs-keyword >from</span> binascii <span class=hljs-keyword >import</span> hexlify, unhexlify
<span class=hljs-keyword >from</span> sage.crypto.sbox <span class=hljs-keyword >import</span> SBox
<span class=hljs-keyword >import</span> os
<span class=hljs-keyword >import</span> ast

<span class=hljs-comment >###</span>
<span class=hljs-comment >### Cipher construction</span>
<span class=hljs-comment >###</span>
BLOCK_SZ = <span class=hljs-number >32</span>
HBS = BLOCK_SZ // <span class=hljs-number >2</span>  <span class=hljs-comment ># 16</span>
<span class=hljs-keyword >assert</span> HBS % <span class=hljs-number >4</span> == <span class=hljs-number >0</span>


<span class=hljs-keyword >def</span> <span class="hljs-title function_">mpy</span>(<span class=hljs-params >x, y</span>):  <span class=hljs-comment ># multiplication in K</span>
    <span class=hljs-keyword >assert</span> <span class=hljs-number >0</span> &lt;= <span class=hljs-built_in >min</span>(x, y) &lt;= <span class=hljs-built_in >max</span>(x, y) &lt; <span class=hljs-number >256</span>
    p = <span class=hljs-number >0</span>
    <span class=hljs-keyword >for</span> _ <span class=hljs-keyword >in</span> <span class=hljs-built_in >range</span>(<span class=hljs-number >8</span>):
        <span class=hljs-keyword >if</span> y &amp; <span class=hljs-number >1</span> != <span class=hljs-number >0</span>:
            p = p ^^ x
        x &lt;&lt;= <span class=hljs-number >1</span>
        <span class=hljs-keyword >if</span> x &amp; <span class=hljs-number >0x100</span> != <span class=hljs-number >0</span>:
            x = x ^^ <span class=hljs-number >0x11D</span>
        y &gt;&gt;= <span class=hljs-number >1</span>
    <span class=hljs-keyword >return</span> p


<span class=hljs-comment ># fmt: off</span>
M = [[<span class=hljs-number >0x04</span>, <span class=hljs-number >0x47</span>, <span class=hljs-number >0x8e</span>, <span class=hljs-number >0x01</span>], [<span class=hljs-number >0x47</span>, <span class=hljs-number >0x04</span>, <span class=hljs-number >0x01</span>, <span class=hljs-number >0x8e</span>], [<span class=hljs-number >0x8e</span>, <span class=hljs-number >0x01</span>, <span class=hljs-number >0x04</span>, <span class=hljs-number >0x47</span>], [<span class=hljs-number >0x01</span>, <span class=hljs-number >0x8e</span>, <span class=hljs-number >0x47</span>, <span class=hljs-number >0x04</span>]] <span class=hljs-comment ># 4x4 matrix</span>
P = [<span class=hljs-number >10</span>, <span class=hljs-number >11</span>, <span class=hljs-number >12</span>, <span class=hljs-number >2</span>, <span class=hljs-number >14</span>, <span class=hljs-number >6</span>, <span class=hljs-number >15</span>, <span class=hljs-number >13</span>, <span class=hljs-number >8</span>, <span class=hljs-number >7</span>, <span class=hljs-number >9</span>, <span class=hljs-number >5</span>, <span class=hljs-number >0</span>, <span class=hljs-number >1</span>, <span class=hljs-number >4</span>, <span class=hljs-number >3</span>] <span class=hljs-comment ># 16. a permutation vector</span>
S = [<span class=hljs-number >6</span>, <span class=hljs-number >98</span>, <span class=hljs-number >179</span>, <span class=hljs-number >28</span>, <span class=hljs-number >64</span>, <span class=hljs-number >3</span>, <span class=hljs-number >110</span>, <span class=hljs-number >124</span>, <span class=hljs-number >194</span>, <span class=hljs-number >137</span>, <span class=hljs-number >105</span>, <span class=hljs-number >62</span>, <span class=hljs-number >19</span>, <span class=hljs-number >146</span>, <span class=hljs-number >82</span>, <span class=hljs-number >73</span>, <span class=hljs-number >199</span>, <span class=hljs-number >10</span>, <span class=hljs-number >33</span>, <span class=hljs-number >165</span>, <span class=hljs-number >151</span>, <span class=hljs-number >251</span>, <span class=hljs-number >97</span>, <span class=hljs-number >148</span>, <span class=hljs-number >101</span>, <span class=hljs-number >153</span>, <span class=hljs-number >252</span>, <span class=hljs-number >187</span>, <span class=hljs-number >103</span>, <span class=hljs-number >254</span>, <span class=hljs-number >5</span>, <span class=hljs-number >213</span>, <span class=hljs-number >100</span>, <span class=hljs-number >108</span>, <span class=hljs-number >142</span>, <span class=hljs-number >51</span>, <span class=hljs-number >68</span>, <span class=hljs-number >224</span>, <span class=hljs-number >16</span>, <span class=hljs-number >58</span>, <span class=hljs-number >183</span>, <span class=hljs-number >208</span>, <span class=hljs-number >55</span>, <span class=hljs-number >215</span>, <span class=hljs-number >128</span>, <span class=hljs-number >210</span>, <span class=hljs-number >107</span>, <span class=hljs-number >242</span>, <span class=hljs-number >80</span>, <span class=hljs-number >192</span>, <span class=hljs-number >36</span>, <span class=hljs-number >50</span>, <span class=hljs-number >157</span>, <span class=hljs-number >173</span>, <span class=hljs-number >45</span>, <span class=hljs-number >122</span>, <span class=hljs-number >106</span>, <span class=hljs-number >56</span>, <span class=hljs-number >104</span>, <span class=hljs-number >32</span>, <span class=hljs-number >195</span>, <span class=hljs-number >232</span>, <span class=hljs-number >132</span>, <span class=hljs-number >13</span>, <span class=hljs-number >155</span>, <span class=hljs-number >246</span>, <span class=hljs-number >35</span>, <span class=hljs-number >138</span>, <span class=hljs-number >66</span>, <span class=hljs-number >221</span>, <span class=hljs-number >2</span>, <span class=hljs-number >121</span>, <span class=hljs-number >227</span>, <span class=hljs-number >113</span>, <span class=hljs-number >203</span>, <span class=hljs-number >234</span>, <span class=hljs-number >228</span>, <span class=hljs-number >207</span>, <span class=hljs-number >196</span>, <span class=hljs-number >9</span>, <span class=hljs-number >225</span>, <span class=hljs-number >201</span>, <span class=hljs-number >184</span>, <span class=hljs-number >89</span>, <span class=hljs-number >248</span>, <span class=hljs-number >95</span>, <span class=hljs-number >129</span>, <span class=hljs-number >126</span>, <span class=hljs-number >8</span>, <span class=hljs-number >222</span>, <span class=hljs-number >49</span>, <span class=hljs-number >181</span>, <span class=hljs-number >154</span>, <span class=hljs-number >241</span>, <span class=hljs-number >217</span>, <span class=hljs-number >250</span>, <span class=hljs-number >0</span>, <span class=hljs-number >249</span>, <span class=hljs-number >38</span>, <span class=hljs-number >167</span>, <span class=hljs-number >57</span>, <span class=hljs-number >41</span>, <span class=hljs-number >59</span>, <span class=hljs-number >12</span>, <span class=hljs-number >185</span>, <span class=hljs-number >30</span>, <span class=hljs-number >39</span>, <span class=hljs-number >26</span>, <span class=hljs-number >7</span>, <span class=hljs-number >214</span>, <span class=hljs-number >238</span>, <span class=hljs-number >20</span>, <span class=hljs-number >198</span>, <span class=hljs-number >79</span>, <span class=hljs-number >166</span>, <span class=hljs-number >162</span>, <span class=hljs-number >159</span>, <span class=hljs-number >239</span>, <span class=hljs-number >193</span>, <span class=hljs-number >119</span>, <span class=hljs-number >189</span>, <span class=hljs-number >65</span>, <span class=hljs-number >54</span>, <span class=hljs-number >130</span>, <span class=hljs-number >1</span>, <span class=hljs-number >178</span>, <span class=hljs-number >93</span>, <span class=hljs-number >237</span>, <span class=hljs-number >133</span>, <span class=hljs-number >63</span>, <span class=hljs-number >223</span>, <span class=hljs-number >147</span>, <span class=hljs-number >92</span>, <span class=hljs-number >43</span>, <span class=hljs-number >163</span>, <span class=hljs-number >123</span>, <span class=hljs-number >141</span>, <span class=hljs-number >191</span>, <span class=hljs-number >168</span>, <span class=hljs-number >37</span>, <span class=hljs-number >15</span>, <span class=hljs-number >220</span>, <span class=hljs-number >211</span>, <span class=hljs-number >69</span>, <span class=hljs-number >244</span>, <span class=hljs-number >27</span>, <span class=hljs-number >86</span>, <span class=hljs-number >70</span>, <span class=hljs-number >240</span>, <span class=hljs-number >53</span>, <span class=hljs-number >160</span>, <span class=hljs-number >116</span>, <span class=hljs-number >144</span>, <span class=hljs-number >145</span>, <span class=hljs-number >11</span>, <span class=hljs-number >134</span>, <span class=hljs-number >21</span>, <span class=hljs-number >229</span>, <span class=hljs-number >233</span>, <span class=hljs-number >22</span>, <span class=hljs-number >17</span>, <span class=hljs-number >182</span>, <span class=hljs-number >109</span>, <span class=hljs-number >114</span>, <span class=hljs-number >206</span>, <span class=hljs-number >158</span>, <span class=hljs-number >131</span>, <span class=hljs-number >115</span>, <span class=hljs-number >52</span>, <span class=hljs-number >197</span>, <span class=hljs-number >175</span>, <span class=hljs-number >202</span>, <span class=hljs-number >186</span>, <span class=hljs-number >143</span>, <span class=hljs-number >180</span>, <span class=hljs-number >245</span>, <span class=hljs-number >169</span>, <span class=hljs-number >25</span>, <span class=hljs-number >88</span>, <span class=hljs-number >102</span>, <span class=hljs-number >236</span>, <span class=hljs-number >140</span>, <span class=hljs-number >226</span>, <span class=hljs-number >120</span>, <span class=hljs-number >125</span>, <span class=hljs-number >4</span>, <span class=hljs-number >235</span>, <span class=hljs-number >177</span>, <span class=hljs-number >164</span>, <span class=hljs-number >47</span>, <span class=hljs-number >171</span>, <span class=hljs-number >81</span>, <span class=hljs-number >118</span>, <span class=hljs-number >48</span>, <span class=hljs-number >61</span>, <span class=hljs-number >14</span>, <span class=hljs-number >172</span>, <span class=hljs-number >72</span>, <span class=hljs-number >18</span>, <span class=hljs-number >112</span>, <span class=hljs-number >91</span>, <span class=hljs-number >255</span>, <span class=hljs-number >76</span>, <span class=hljs-number >174</span>, <span class=hljs-number >205</span>, <span class=hljs-number >216</span>, <span class=hljs-number >75</span>, <span class=hljs-number >161</span>, <span class=hljs-number >243</span>, <span class=hljs-number >29</span>, <span class=hljs-number >99</span>, <span class=hljs-number >44</span>, <span class=hljs-number >46</span>, <span class=hljs-number >231</span>, <span class=hljs-number >42</span>, <span class=hljs-number >139</span>, <span class=hljs-number >136</span>, <span class=hljs-number >67</span>, <span class=hljs-number >83</span>, <span class=hljs-number >135</span>, <span class=hljs-number >204</span>, <span class=hljs-number >84</span>, <span class=hljs-number >247</span>, <span class=hljs-number >253</span>, <span class=hljs-number >60</span>, <span class=hljs-number >150</span>, <span class=hljs-number >77</span>, <span class=hljs-number >176</span>, <span class=hljs-number >190</span>, <span class=hljs-number >127</span>, <span class=hljs-number >96</span>, <span class=hljs-number >117</span>, <span class=hljs-number >34</span>, <span class=hljs-number >90</span>, <span class=hljs-number >188</span>, <span class=hljs-number >78</span>, <span class=hljs-number >74</span>, <span class=hljs-number >149</span>, <span class=hljs-number >230</span>, <span class=hljs-number >209</span>, <span class=hljs-number >200</span>, <span class=hljs-number >31</span>, <span class=hljs-number >219</span>, <span class=hljs-number >24</span>, <span class=hljs-number >23</span>, <span class=hljs-number >85</span>, <span class=hljs-number >111</span>, <span class=hljs-number >94</span>, <span class=hljs-number >218</span>, <span class=hljs-number >71</span>, <span class=hljs-number >170</span>, <span class=hljs-number >152</span>, <span class=hljs-number >212</span>, <span class=hljs-number >40</span>, <span class=hljs-number >87</span>, <span class=hljs-number >156</span>] <span class=hljs-comment ># 256</span>
<span class=hljs-comment ># fmt: on</span>


<span class=hljs-keyword >def</span> <span class="hljs-title function_">perm</span>(<span class=hljs-params >bs</span>):  <span class=hljs-comment ># permutation, followed by matrix multiplication in GF(2^q)</span>
    bs = <span class=hljs-built_in >list</span>(bs)
    <span class=hljs-keyword >assert</span> <span class=hljs-built_in >len</span>(bs) == HBS
    m = [bs[P[i]] <span class=hljs-keyword >for</span> i <span class=hljs-keyword >in</span> <span class=hljs-built_in >range</span>(<span class=hljs-built_in >len</span>(bs))]
    ns = []
    <span class=hljs-keyword >for</span> i <span class=hljs-keyword >in</span> <span class=hljs-built_in >range</span>(<span class=hljs-number >0</span>, <span class=hljs-built_in >len</span>(m), <span class=hljs-number >4</span>):
        ms = m[i : i + <span class=hljs-number >4</span>]
        ns.append([reduce(xor, [mpy(ms[j], M[i][j]) <span class=hljs-keyword >for</span> j <span class=hljs-keyword >in</span> <span class=hljs-built_in >range</span>(<span class=hljs-number >4</span>)]) <span class=hljs-keyword >for</span> i <span class=hljs-keyword >in</span> <span class=hljs-built_in >range</span>(<span class=hljs-number >4</span>)])
    <span class=hljs-keyword >return</span> reduce(<span class=hljs-keyword >lambda</span> a, b: a + b, ns)


<span class=hljs-keyword >def</span> <span class="hljs-title function_">x</span>(<span class=hljs-params >a, b</span>):
    <span class=hljs-keyword >return</span> <span class=hljs-built_in >bytes</span>([x ^^ y <span class=hljs-keyword >for</span> (x, y) <span class=hljs-keyword >in</span> <span class=hljs-built_in >zip</span>(a, b)])


<span class=hljs-keyword >def</span> <span class="hljs-title function_">encrypt_block</span>(<span class=hljs-params >key, block</span>):
    <span class=hljs-keyword >assert</span> <span class=hljs-built_in >len</span>(block) == BLOCK_SZ
    <span class=hljs-keyword >assert</span> <span class=hljs-built_in >len</span>(key) == BLOCK_SZ
    a = sha256(key).digest()
    b = sha256(a).digest()
    c = sha256(b).digest()
    sks = [key[:HBS], key[HBS:], a[:HBS], a[HBS:], b[:HBS], b[HBS:], c[:HBS]]
    <span class=hljs-keyword >assert</span> <span class=hljs-built_in >all</span>(<span class=hljs-built_in >len</span>(x) == HBS <span class=hljs-keyword >for</span> x <span class=hljs-keyword >in</span> sks)
    L, R = block[:<span class=hljs-number >16</span>], block[<span class=hljs-number >16</span>:]
    L, R = x(perm(S[b] <span class=hljs-keyword >for</span> b <span class=hljs-keyword >in</span> x(R, sks[<span class=hljs-number >0</span>])), L), R
    L, R = L, x(perm(S[b] <span class=hljs-keyword >for</span> b <span class=hljs-keyword >in</span> x(L, sks[<span class=hljs-number >1</span>])), R)
    L, R = x(perm(S[b] <span class=hljs-keyword >for</span> b <span class=hljs-keyword >in</span> x(R, sks[<span class=hljs-number >2</span>])), L), R
    L, R = L, x(perm(S[b] <span class=hljs-keyword >for</span> b <span class=hljs-keyword >in</span> x(L, sks[<span class=hljs-number >3</span>])), R)
    L, R = x(perm(S[b] <span class=hljs-keyword >for</span> b <span class=hljs-keyword >in</span> x(R, sks[<span class=hljs-number >4</span>])), L), R
    L, R = L, x(perm(S[b] <span class=hljs-keyword >for</span> b <span class=hljs-keyword >in</span> x(L, sks[<span class=hljs-number >5</span>])), R)
    L, R = x(perm(S[b] <span class=hljs-keyword >for</span> b <span class=hljs-keyword >in</span> x(R, sks[<span class=hljs-number >6</span>])), L), R
    <span class=hljs-keyword >return</span> <span class=hljs-built_in >bytes</span>(L + R)


<span class=hljs-keyword >def</span> <span class="hljs-title function_">decrypt_block</span>(<span class=hljs-params >key, block</span>):
    <span class=hljs-keyword >assert</span> <span class=hljs-built_in >len</span>(block) == BLOCK_SZ
    <span class=hljs-keyword >assert</span> <span class=hljs-built_in >len</span>(key) == BLOCK_SZ
    a = sha256(key).digest()
    b = sha256(a).digest()
    c = sha256(b).digest()
    sks = [key[:HBS], key[HBS:], a[:HBS], a[HBS:], b[:HBS], b[HBS:], c[:HBS]]

    L, R = block[:<span class=hljs-number >16</span>], block[<span class=hljs-number >16</span>:]
    L, R = x(perm(S[b] <span class=hljs-keyword >for</span> b <span class=hljs-keyword >in</span> x(R, sks[<span class=hljs-number >6</span>])), L), R
    L, R = L, x(perm(S[b] <span class=hljs-keyword >for</span> b <span class=hljs-keyword >in</span> x(L, sks[<span class=hljs-number >5</span>])), R)
    L, R = x(perm(S[b] <span class=hljs-keyword >for</span> b <span class=hljs-keyword >in</span> x(R, sks[<span class=hljs-number >4</span>])), L), R
    L, R = L, x(perm(S[b] <span class=hljs-keyword >for</span> b <span class=hljs-keyword >in</span> x(L, sks[<span class=hljs-number >3</span>])), R)
    L, R = x(perm(S[b] <span class=hljs-keyword >for</span> b <span class=hljs-keyword >in</span> x(R, sks[<span class=hljs-number >2</span>])), L), R
    L, R = L, x(perm(S[b] <span class=hljs-keyword >for</span> b <span class=hljs-keyword >in</span> x(L, sks[<span class=hljs-number >1</span>])), R)
    L, R = x(perm(S[b] <span class=hljs-keyword >for</span> b <span class=hljs-keyword >in</span> x(R, sks[<span class=hljs-number >0</span>])), L), R
    <span class=hljs-keyword >return</span> <span class=hljs-built_in >bytes</span>(L + R)


<span class=hljs-comment >###</span>
<span class=hljs-comment >### Hash construction</span>
<span class=hljs-comment >### Matyas Meyer Oseas</span>
<span class=hljs-comment >###</span>
<span class=hljs-keyword >def</span> <span class="hljs-title function_">g</span>(<span class=hljs-params >h</span>):
    <span class=hljs-keyword >return</span> <span class=hljs-built_in >bytes</span>(h + <span class=hljs-built_in >bytes</span>([S[c] <span class=hljs-keyword >for</span> c <span class=hljs-keyword >in</span> h]))[:BLOCK_SZ]


<span class=hljs-keyword >def</span> <span class="hljs-title function_">hash</span>(<span class=hljs-params >start_key, data</span>):
    padding_needed = BLOCK_SZ - (<span class=hljs-built_in >len</span>(data) % BLOCK_SZ)
    data = data + <span class=hljs-built_in >bytes</span>(padding_needed * [padding_needed])
    blocks = [data[i : i + BLOCK_SZ] <span class=hljs-keyword >for</span> i <span class=hljs-keyword >in</span> <span class=hljs-built_in >range</span>(<span class=hljs-number >0</span>, <span class=hljs-built_in >len</span>(data), BLOCK_SZ)]
    now = start_key
    <span class=hljs-keyword >for</span> block <span class=hljs-keyword >in</span> blocks:
        <span class=hljs-comment ># eh 128 bits is enough</span>
        now = x(encrypt_block(g(now), block), block)[-<span class=hljs-number >16</span>:]
    <span class=hljs-keyword >return</span> now


<span class=hljs-comment >###</span>
<span class=hljs-comment >### https://iacr.org/archive/asiacrypt2007/48330316/48330316.pdf</span>
<span class=hljs-comment >###</span>
<span class=hljs-comment ># First, find an inverse for the round function F</span>

<span class=hljs-comment ># Helpers for MixColumns round</span>
F = GF(<span class=hljs-number >2</span>)
Fu = PolynomialRing(F, <span class=hljs-string >&quot;u&quot;</span>)
u = Fu.gen()
K = GF(<span class=hljs-number >2</span> ^ <span class=hljs-number >8</span>, <span class=hljs-string >&quot;u&quot;</span>, modulus=<span class=hljs-number >1</span> + u ^ <span class=hljs-number >2</span> + u ^ <span class=hljs-number >3</span> + u ^ <span class=hljs-number >4</span> + u ^ <span class=hljs-number >8</span>)
u = K.gen()

<span class=hljs-keyword >def</span> <span class="hljs-title function_">to_poly</span>(<span class=hljs-params >byte</span>):
    binary_repr = <span class=hljs-built_in >format</span>(byte, <span class=hljs-string >&quot;08b&quot;</span>)[::-<span class=hljs-number >1</span>] <span class=hljs-comment ># little endian</span>
    <span class=hljs-keyword >return</span> K(<span class=hljs-built_in >sum</span>(<span class=hljs-built_in >int</span>(b) * u**k <span class=hljs-keyword >for</span> k, b <span class=hljs-keyword >in</span> <span class=hljs-built_in >enumerate</span>(binary_repr)))

<span class=hljs-keyword >def</span> <span class="hljs-title function_">from_poly</span>(<span class=hljs-params >ele</span>):
    <span class=hljs-keyword >return</span> ele.to_integer()

M_algebraic = matrix(K, [<span class=hljs-built_in >list</span>(<span class=hljs-built_in >map</span>(to_poly, M_)) <span class=hljs-keyword >for</span> M_ <span class=hljs-keyword >in</span> M])

<span class=hljs-keyword >def</span> <span class="hljs-title function_">to_matrix</span>(<span class=hljs-params >half_block, algebraic = <span class=hljs-literal >False</span>, column_major = <span class=hljs-literal >False</span></span>):
    <span class=hljs-keyword >assert</span> <span class=hljs-built_in >len</span>(half_block) == HBS
    m = [half_block[i:i+<span class=hljs-number >4</span>] <span class=hljs-keyword >for</span> i <span class=hljs-keyword >in</span> <span class=hljs-built_in >range</span>(<span class=hljs-number >0</span>, <span class=hljs-built_in >len</span>(half_block), <span class=hljs-number >4</span>)]

    <span class=hljs-keyword >if</span> algebraic:
        m = matrix(K, [<span class=hljs-built_in >list</span>(<span class=hljs-built_in >map</span>(to_poly, M_)) <span class=hljs-keyword >for</span> M_ <span class=hljs-keyword >in</span> m])
    <span class=hljs-keyword >else</span>:
        m = matrix(ZZ, m)

    <span class=hljs-keyword >if</span> column_major:
        m = m.transpose()

    <span class=hljs-keyword >return</span> m

<span class=hljs-keyword >def</span> <span class="hljs-title function_">from_matrix</span>(<span class=hljs-params >mat, algebraic = <span class=hljs-literal >False</span>, column_major = <span class=hljs-literal >False</span></span>):
    <span class=hljs-keyword >if</span> column_major:
        mat = mat.transpose()

    block = <span class=hljs-built_in >list</span>(reduce(<span class=hljs-keyword >lambda</span> a, b: <span class=hljs-built_in >list</span>(a) + <span class=hljs-built_in >list</span>(b), mat.rows()))
    <span class=hljs-keyword >if</span> algebraic:
        block = [from_poly(p) <span class=hljs-keyword >for</span> p <span class=hljs-keyword >in</span> block]
    <span class=hljs-keyword >return</span> block

<span class=hljs-comment ># Helpers for substitution round</span>
sbox = SBox(S)
sbox_inv = sbox.inverse()

<span class=hljs-comment ># Helpers for permutation round</span>
P_inv = [<span class=hljs-number >12</span>, <span class=hljs-number >13</span>, <span class=hljs-number >3</span>, <span class=hljs-number >15</span>, <span class=hljs-number >14</span>, <span class=hljs-number >11</span>, <span class=hljs-number >5</span>, <span class=hljs-number >9</span>, <span class=hljs-number >8</span>, <span class=hljs-number >10</span>, <span class=hljs-number >0</span>, <span class=hljs-number >1</span>, <span class=hljs-number >2</span>, <span class=hljs-number >7</span>, <span class=hljs-number >4</span>, <span class=hljs-number >6</span>]

<span class=hljs-keyword >def</span> <span class="hljs-title function_">f</span>(<span class=hljs-params >half_block</span>):
    <span class=hljs-keyword >assert</span> <span class=hljs-built_in >len</span>(half_block) == HBS

    <span class=hljs-comment ># Substitution round</span>
    half_block = [sbox(b) <span class=hljs-keyword >for</span> b <span class=hljs-keyword >in</span> half_block]

    <span class=hljs-comment ># Permutation round</span>
    half_block = [half_block[P[i]] <span class=hljs-keyword >for</span> i <span class=hljs-keyword >in</span> <span class=hljs-built_in >range</span>(<span class=hljs-built_in >len</span>(half_block))]

    <span class=hljs-comment ># Mix columns round</span>
    m = to_matrix(half_block, algebraic=<span class=hljs-literal >True</span>, column_major=<span class=hljs-literal >True</span>)
    m = M_algebraic * m
    half_block = from_matrix(m, algebraic=<span class=hljs-literal >True</span>, column_major=<span class=hljs-literal >True</span>)

    <span class=hljs-keyword >return</span> half_block

<span class=hljs-keyword >def</span> <span class="hljs-title function_">f_inverse</span>(<span class=hljs-params >half_block</span>):
    <span class=hljs-comment ># Invert mix_columns round</span>
    m = to_matrix(half_block, algebraic=<span class=hljs-literal >True</span>, column_major=<span class=hljs-literal >True</span>)
    m = M_algebraic.inverse() * m
    half_block = from_matrix(m, algebraic=<span class=hljs-literal >True</span>, column_major=<span class=hljs-literal >True</span>)

    <span class=hljs-comment ># Invert permutation round</span>
    half_block = [half_block[P_inv[i]] <span class=hljs-keyword >for</span> i <span class=hljs-keyword >in</span> <span class=hljs-built_in >range</span>(<span class=hljs-built_in >len</span>(half_block))]

    <span class=hljs-comment ># Invert substitution round</span>
    half_block = [sbox_inv(b) <span class=hljs-keyword >for</span> b <span class=hljs-keyword >in</span> half_block]

    <span class=hljs-keyword >return</span> half_block

<span class=hljs-comment ># Now to implement the distinguisher algorithm</span>
<span class=hljs-keyword >def</span> <span class="hljs-title function_">key_schedule</span>(<span class=hljs-params >key</span>):
    <span class=hljs-keyword >assert</span> <span class=hljs-built_in >len</span>(key) == BLOCK_SZ
    a = sha256(key).digest()
    b = sha256(a).digest()
    c = sha256(b).digest()
    sks = [key[:HBS], key[HBS:], a[:HBS], a[HBS:], b[:HBS], b[HBS:], c[:HBS]]
    <span class=hljs-keyword >return</span> sks

<span class=hljs-keyword >def</span> <span class="hljs-title function_">knudsen_rijmen_distinguisher</span>(<span class=hljs-params >round_func, round_func_inv, key, x_ = <span class=hljs-literal >None</span></span>):
    subkeys = key_schedule(key)
    <span class=hljs-keyword >if</span> <span class=hljs-keyword >not</span> x_:
        x_ = os.urandom(HBS)

    gamma = x(subkeys[<span class=hljs-number >1</span>], subkeys[<span class=hljs-number >5</span>])
    alpha = x(x_, round_func_inv(x(round_func(x_), gamma)))
    z = round_func_inv(x(x(subkeys[<span class=hljs-number >2</span>], subkeys[<span class=hljs-number >4</span>]), alpha))

    p_R = reduce(x, [x_, subkeys[<span class=hljs-number >2</span>], round_func(reduce(x, [z, round_func(x_), subkeys[<span class=hljs-number >3</span>], subkeys[<span class=hljs-number >1</span>]]))])
    p_L = reduce(x, [z, round_func(x_), subkeys[<span class=hljs-number >3</span>], round_func(x(p_R, subkeys[<span class=hljs-number >0</span>]))])

    p_hat_R = reduce(x, [x_, alpha, subkeys[<span class=hljs-number >2</span>], round_func(reduce(x, [z, round_func(x_), subkeys[<span class=hljs-number >5</span>], subkeys[<span class=hljs-number >3</span>]]))])
    p_hat_L = reduce(x, [z, round_func(x_), gamma, subkeys[<span class=hljs-number >3</span>], round_func(x(p_hat_R, subkeys[<span class=hljs-number >0</span>]))])

    p = p_L + p_R
    p_hat = p_hat_L + p_hat_R

    c_R = encrypt_block(key, p)[-<span class=hljs-number >16</span>:]
    c_hat_R = encrypt_block(key, p_hat)[-<span class=hljs-number >16</span>:]

    <span class=hljs-keyword >assert</span> reduce(x, [c_R, c_hat_R, p_R, p_hat_R]) == <span class=hljs-string >b&quot;\x00&quot;</span> * HBS

    <span class=hljs-keyword >return</span> p, p_hat

<span class=hljs-comment >###</span>
<span class=hljs-comment >### AST parsing</span>
<span class=hljs-comment >###</span>
SAFE_FUNCTIONS = <span class=hljs-built_in >set</span>([<span class=hljs-string >&quot;print&quot;</span>])
OP_MAP = {
  ast.Add: <span class=hljs-keyword >lambda</span> a,b: a + b,
  ast.Sub: <span class=hljs-keyword >lambda</span> a,b: a - b,
  ast.Mult: <span class=hljs-keyword >lambda</span> a,b: a * b,
}
<span class=hljs-keyword >def</span> <span class="hljs-title function_">check_expression_safety</span>(<span class=hljs-params >expr</span>):
  <span class=hljs-keyword >if</span> <span class=hljs-built_in >isinstance</span>(expr, ast.Call):
    func = expr.func
    <span class=hljs-keyword >if</span> func.<span class=hljs-built_in >id</span> <span class=hljs-keyword >not</span> <span class=hljs-keyword >in</span> SAFE_FUNCTIONS:
      <span class=hljs-keyword >return</span> <span class=hljs-literal >False</span>
    <span class=hljs-keyword >return</span> <span class=hljs-built_in >all</span>(
      check_expression_safety(arg) <span class=hljs-keyword >for</span> arg <span class=hljs-keyword >in</span> expr.args
    ) <span class=hljs-keyword >and</span> (<span class=hljs-built_in >len</span>(expr.keywords) == <span class=hljs-number >0</span>)
  <span class=hljs-keyword >elif</span> <span class=hljs-built_in >isinstance</span>(expr, ast.BinOp):
    <span class=hljs-keyword >if</span> <span class=hljs-keyword >not</span> <span class=hljs-built_in >any</span>(<span class=hljs-built_in >isinstance</span>(expr.op, typ) <span class=hljs-keyword >for</span> typ <span class=hljs-keyword >in</span> OP_MAP):
      <span class=hljs-keyword >return</span> <span class=hljs-literal >False</span>
    <span class=hljs-keyword >return</span> check_expression_safety(expr.left) <span class=hljs-keyword >and</span> check_expression_safety(expr.right)
  <span class=hljs-keyword >elif</span> <span class=hljs-built_in >isinstance</span>(expr, ast.Constant):
    <span class=hljs-keyword >return</span> <span class=hljs-built_in >isinstance</span>(expr.value, <span class=hljs-built_in >int</span>) <span class=hljs-keyword >or</span> <span class=hljs-built_in >isinstance</span>(expr.value, <span class=hljs-built_in >str</span>)
  <span class=hljs-keyword >return</span> <span class=hljs-literal >False</span>

<span class=hljs-keyword >def</span> <span class="hljs-title function_">check_if_safe</span>(<span class=hljs-params >cmd</span>):
  <span class=hljs-keyword >try</span>:
    mod = ast.parse(cmd)
    <span class=hljs-keyword >assert</span> <span class=hljs-built_in >len</span>(mod.body) == <span class=hljs-number >1</span> <span class=hljs-keyword >and</span> <span class=hljs-built_in >isinstance</span>(mod.body[<span class=hljs-number >0</span>], ast.Expr)
    <span class=hljs-keyword >return</span> check_expression_safety(mod.body[<span class=hljs-number >0</span>].value)
  <span class=hljs-keyword >except</span> (SyntaxError, UnicodeDecodeError):
    <span class=hljs-comment ># if it doesn&#x27;t parse, it won&#x27;t run</span>
    <span class=hljs-keyword >return</span> <span class=hljs-literal >True</span>

FUNC_MAP = {
  <span class=hljs-string >&quot;print&quot;</span>: <span class=hljs-built_in >print</span>,
  <span class=hljs-string >&quot;get_flag&quot;</span>: <span class=hljs-keyword >lambda</span>: FLAG
}
<span class=hljs-keyword >def</span> <span class="hljs-title function_">eval_expr</span>(<span class=hljs-params >expr</span>):
  <span class=hljs-keyword >if</span> <span class=hljs-built_in >isinstance</span>(expr, ast.Call):
    func = expr.func
    args = [eval_expr(arg) <span class=hljs-keyword >for</span> arg <span class=hljs-keyword >in</span> expr.args]
    <span class=hljs-keyword >return</span> FUNC_MAP[func.<span class=hljs-built_in >id</span>](*args)
  <span class=hljs-keyword >elif</span> <span class=hljs-built_in >isinstance</span>(expr, ast.BinOp):
    <span class=hljs-keyword >return</span> OP_MAP[<span class=hljs-built_in >type</span>(expr.op)](eval_expr(expr.left), eval_expr(expr.right))
  <span class=hljs-keyword >elif</span> <span class=hljs-built_in >isinstance</span>(expr, ast.Constant):
    <span class=hljs-keyword >if</span> <span class=hljs-built_in >isinstance</span>(expr.value, <span class=hljs-built_in >int</span>) <span class=hljs-keyword >or</span> <span class=hljs-built_in >isinstance</span>(expr.value, <span class=hljs-built_in >str</span>):
      <span class=hljs-keyword >return</span> expr.value
  <span class=hljs-keyword >raise</span> Exception(<span class=hljs-string >&quot;Something has gone wrong!&quot;</span>)

<span class=hljs-keyword >def</span> <span class="hljs-title function_">evaluate_safe</span>(<span class=hljs-params >cmd</span>):
  <span class=hljs-keyword >try</span>:
    mod = ast.parse(cmd)
    <span class=hljs-keyword >assert</span> <span class=hljs-built_in >len</span>(mod.body) == <span class=hljs-number >1</span> <span class=hljs-keyword >and</span> <span class=hljs-built_in >isinstance</span>(mod.body[<span class=hljs-number >0</span>], ast.Expr)
    <span class=hljs-keyword >return</span> eval_expr(mod.body[<span class=hljs-number >0</span>].value)
  <span class=hljs-keyword >except</span> (SyntaxError, UnicodeDecodeError):
    <span class=hljs-comment ># no parse, just fail</span>
    <span class=hljs-built_in >print</span>(<span class=hljs-string >&quot;There was a syntax error in your command - try a different one?&quot;</span>)

<span class=hljs-keyword >def</span> <span class="hljs-title function_">find_exploit_pair</span>(<span class=hljs-params >key</span>):
    <span class=hljs-keyword >while</span> <span class=hljs-literal >True</span>:
        p, p_hat = knudsen_rijmen_distinguisher(f, f_inverse, key)
        <span class=hljs-keyword >try</span>:
            ast.parse(p)
            p_valid = <span class=hljs-literal >True</span>
        <span class=hljs-keyword >except</span>:
            p_valid = <span class=hljs-literal >False</span>
        <span class=hljs-keyword >try</span>:
            ast.parse(p_hat)
            p_hat_valid = <span class=hljs-literal >True</span>
        <span class=hljs-keyword >except</span>:
            p_hat_valid = <span class=hljs-literal >False</span>
        <span class=hljs-keyword >if</span> p_valid ^^ p_hat_valid:
            <span class=hljs-keyword >if</span> p_valid:
                <span class=hljs-keyword >assert</span> p[:<span class=hljs-number >1</span>] == <span class=hljs-string >b&quot;#&quot;</span>
                <span class=hljs-keyword >return</span> p, p_hat
            <span class=hljs-keyword >else</span>:
                <span class=hljs-keyword >assert</span> p_hat_valid
                <span class=hljs-keyword >return</span> p_hat, p

pwn.context.log_level = <span class=hljs-string >&quot;debug&quot;</span>
<span class=hljs-keyword >def</span> <span class="hljs-title function_">solve</span>():
    conn = pwn.connect(<span class=hljs-string >&quot;mmorpg.chal.pwni.ng&quot;</span>, <span class=hljs-number >1337</span>)
    <span class=hljs-comment ># conn = pwn.process([&quot;python&quot;, &quot;mmorpg.py&quot;])</span>

    conn.recvuntil(<span class=hljs-string >b&quot;Hashing via key&quot;</span>)
    start_key = unhexlify(conn.recvline().decode().strip().strip(<span class=hljs-string >&quot;&#x27;&quot;</span>).strip(<span class=hljs-string >&quot;b&#x27;&quot;</span>))

    p, p_hat = find_exploit_pair(start_key)

    safe = p_hat + <span class=hljs-string >b&quot;\nget_flag()&quot;</span>
    unsafe = p + <span class=hljs-string >b&quot;\nget_flag()&quot;</span>

    <span class=hljs-keyword >assert</span> <span class=hljs-built_in >hash</span>(start_key, safe) == <span class=hljs-built_in >hash</span>(start_key, unsafe)
    conn.sendline(safe.<span class=hljs-built_in >hex</span>().encode(<span class=hljs-string >&quot;utf-8&quot;</span>))
    conn.sendline(unsafe.<span class=hljs-built_in >hex</span>().encode(<span class=hljs-string >&quot;utf-8&quot;</span>))
    conn.interactive()</code></pre>
<h3 id=flag__3 ><a href="#flag__3" class=header-anchor >Flag</a></h3>
<pre><code class="plaintext hljs">PCTF{n1c3_w0rk_th4ts_a_sp0oky_h45h_coll1der_e66351ecdc2a593278174541ad513125}</code></pre>
<div class=page-foot >
    Last modified: April 14, 2024.
    Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a> and the <a href="https://julialang.org">Julia programming language</a>.
</div>
</div>
        </div> 
    </div> 
    
        



    
    
        <script src="/wednesday/libs/highlight/highlight.min.js"></script>
<script src="/wednesday/libs/highlight/rust.min.js"></script>
<script src="/wednesday/libs/highlight/csharp.min.js"></script>
<script>hljs.highlightAll();hljs.configure({tabReplace: '    '});</script>