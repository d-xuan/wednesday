<!doctype html> <html lang=en > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <link rel=stylesheet  href="/libs/katex/katex.min.css"> <link rel=stylesheet  href="/libs/highlight/styles/base16/chalk.min.css" /> <link rel=stylesheet  href="/css/franklin.css" /> <link rel=stylesheet  href="/css/tufte.css" /> <link rel=stylesheet  href="/css/latex.css" /> <link rel=stylesheet  href="/css/adjust.css" /> <link rel=icon  href="/assets/favicon.png" /> <title>Soundness violations in popular zero knowledge proof libraries</title> <div id=layout > <div id=menu > <ul> <li><a href="/">home</a> <li><a href="/about/">about</a> <li><a href="/ctf/">ctf</a> <li><a href="/research/">research</a> </ul> </div> <div id=main ></div> </div> <div class=franklin-content ><h1 id=soundness_violations_in_popular_zero_knowledge_proof_libraries ><a href="#soundness_violations_in_popular_zero_knowledge_proof_libraries" class=header-anchor >Soundness violations in popular zero knowledge proof libraries</a></h1> <p>I&#39;ve been thinking quite a bit about ECDSA threshold signatures over the past two years, which means I have also been spending a lot of time inspecting <a href="https://www.zkdocs.com/docs/zkdocs/zero-knowledge-protocols/product-primes/paillier_blum_modulus/">Paillier-Blum modulus proofs</a>. These proofs form a critical component of Paillier based threshold signature protocols, particularly those derived from the <a href="https://eprint.iacr.org/2019/114">GG18</a>-<a href="https://eprint.iacr.org/2020/540">GG20</a> family, such as <a href="https://eprint.iacr.org/2020/492">CMP20</a> and <a href="https://eprint.iacr.org/2021/060">CGGMP21</a>.</p> <p>The text of the proof goes something like this, following the exposition of CMP20 Section 4.3:</p> <p><strong>Inputs</strong>: Common input is <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span>. Prover has secret input <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy=false >(</mo><mi>p</mi><mo separator=true >,</mo><mi>q</mi><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">(p, q)</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mopen >(</span><span class="mord mathnormal">p</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class=mclose >)</span></span></span></span> such that <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo>=</mo><mi>p</mi><mi>q</mi></mrow><annotation encoding="application/x-tex">N = pq</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2778em;"></span></span><span class=base ><span class=strut  style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">pq</span></span></span></span>.</p> <ol> <li><p>Prover samples a random <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>w</mi><mo>←</mo><msub><mi mathvariant=double-struck >Z</mi><mi>N</mi></msub></mrow><annotation encoding="application/x-tex">w \leftarrow \mathbb{Z}_N</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >←</span><span class=mspace  style="margin-right:0.2778em;"></span></span><span class=base ><span class=strut  style="height:0.8389em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathbb">Z</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> of Jacobi symbol <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">-1</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.7278em;vertical-align:-0.0833em;"></span><span class=mord >−</span><span class=mord >1</span></span></span></span> and sends it to the verifier.</p> <li><p>Verifier sends <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy=false >{</mo><msub><mi>y</mi><mi>i</mi></msub><mo>←</mo><msub><mi mathvariant=double-struck >Z</mi><mi>N</mi></msub><msub><mo stretchy=false >}</mo><mrow><mi>i</mi><mo>∈</mo><mo stretchy=false >[</mo><mi>m</mi><mo stretchy=false >]</mo></mrow></msub></mrow><annotation encoding="application/x-tex">\{y_i \leftarrow \mathbb{Z}_N\}_{i \in [m]}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mopen >{</span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >←</span><span class=mspace  style="margin-right:0.2778em;"></span></span><span class=base ><span class=strut  style="height:1.1052em;vertical-align:-0.3552em;"></span><span class=mord ><span class="mord mathbb">Z</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mclose ><span class=mclose >}</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3448em;"><span style="top:-2.5198em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">∈</span><span class="mopen mtight">[</span><span class="mord mathnormal mtight">m</span><span class="mclose mtight">]</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.3552em;"><span></span></span></span></span></span></span></span></span></span></p> <li><p>For every <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>∈</mo><mo stretchy=false >[</mo><mi>m</mi><mo stretchy=false >]</mo></mrow><annotation encoding="application/x-tex">i \in [m]</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6986em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">i</span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >∈</span><span class=mspace  style="margin-right:0.2778em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mopen >[</span><span class="mord mathnormal">m</span><span class=mclose >]</span></span></span></span> set:</p> <ul> <li><p><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mo>=</mo><mroot><msub><mi>y</mi><mi>i</mi></msub><mn>4</mn></mroot><mspace></mspace><mspace width=0.6667em /><mrow><mi mathvariant=normal >m</mi><mi mathvariant=normal >o</mi><mi mathvariant=normal >d</mi></mrow><mtext> </mtext><mtext> </mtext><mi>N</mi></mrow><annotation encoding="application/x-tex">x = \sqrt[4]{y_i} \mod N</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.4306em;"></span><span class="mord mathnormal">x</span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2778em;"></span></span><span class=base ><span class=strut  style="height:1.04em;vertical-align:-0.3369em;"></span><span class="mord sqrt"><span class=root ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.5419em;"><span style="top:-2.7197em;"><span class=pstrut  style="height:2.5em;"></span><span class="sizing reset-size6 size1 mtight"><span class="mord mtight"><span class="mord mtight">4</span></span></span></span></span></span></span></span><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.7031em;"><span class=svg-align  style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=mord  style="padding-left:0.833em;"><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.6631em;"><span class=pstrut  style="height:3em;"></span><span class=hide-tail  style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width='400em' height='1.08em' viewBox='0 0 400000 1080' preserveAspectRatio='xMinYMin slice'><path d='M95,702 c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14 c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54 c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10 s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429 c69,-144,104.5,-217.7,106.5,-221 l0 -0 c5.3,-9.3,12,-14,20,-14 H400000v40H845.2724 s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7 c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z M834 80h400000v40h-400000z'/></svg></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.3369em;"><span></span></span></span></span></span><span class="mspace allowbreak"></span><span class=mspace  style="margin-right:0.6667em;"></span></span><span class=base ><span class=strut  style="height:0.6944em;"></span><span class=mord ><span class=mord ><span class="mord mathrm">mod</span></span></span><span class=mspace  style="margin-right:0.1667em;"></span><span class=mspace  style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span>, where <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>y</mi><mi>i</mi><mo mathvariant=normal  lspace=0em  rspace=0em >′</mo></msubsup><mo>=</mo><mo stretchy=false >(</mo><mo>−</mo><mn>1</mn><msup><mo stretchy=false >)</mo><mi>a</mi></msup><msup><mi>w</mi><mi>b</mi></msup><msub><mi>y</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">y_i&#x27; = (-1)^a w^b y_i</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1.0106em;vertical-align:-0.2587em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.7519em;"><span style="top:-2.4413em;margin-left:-0.0359em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.2587em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2778em;"></span></span><span class=base ><span class=strut  style="height:1.0991em;vertical-align:-0.25em;"></span><span class=mopen >(</span><span class=mord >−</span><span class=mord >1</span><span class=mclose ><span class=mclose >)</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span></span></span></span></span></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span></span></span></span></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> for unique <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>i</mi></msub><mo separator=true >,</mo><msub><mi>b</mi><mi>i</mi></msub><mo>∈</mo><mo stretchy=false >{</mo><mn>0</mn><mo separator=true >,</mo><mn>1</mn><mo stretchy=false >}</mo></mrow><annotation encoding="application/x-tex">a_i, b_i \in \{0, 1\}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.8889em;vertical-align:-0.1944em;"></span><span class=mord ><span class="mord mathnormal">a</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.1667em;"></span><span class=mord ><span class="mord mathnormal">b</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >∈</span><span class=mspace  style="margin-right:0.2778em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mopen >{</span><span class=mord >0</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.1667em;"></span><span class=mord >1</span><span class=mclose >}</span></span></span></span> such that <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">x_i</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.5806em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal">x</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is well defined.</p> <li><p><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>z</mi><mi>i</mi></msub><mo>=</mo><mo stretchy=false >{</mo><msubsup><mi>y</mi><mi>i</mi><mrow><msup><mi>N</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup><mspace></mspace><mspace width=0.6667em /><mrow><mi mathvariant=normal >m</mi><mi mathvariant=normal >o</mi><mi mathvariant=normal >d</mi></mrow><mtext> </mtext><mtext> </mtext><mi>ϕ</mi><mo stretchy=false >(</mo><mi>N</mi><mo stretchy=false >)</mo></mrow></msubsup><mo stretchy=false >}</mo><mspace></mspace><mspace width=0.6667em /><mrow><mi mathvariant=normal >m</mi><mi mathvariant=normal >o</mi><mi mathvariant=normal >d</mi></mrow><mtext> </mtext><mtext> </mtext><mi>N</mi></mrow><annotation encoding="application/x-tex">z_i = \{y_i^{N^{-1} \mod \phi(N)}\} \mod N</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.5806em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2778em;"></span></span><span class=base ><span class=strut  style="height:1.4206em;vertical-align:-0.2769em;"></span><span class=mopen >{</span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:1.1437em;"><span style="top:-2.4231em;margin-left:-0.0359em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8913em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class=pstrut  style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mspace allowbreak mtight"></span><span class="mspace mtight" style="margin-right:0.7807em;"></span><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">mod</span></span></span><span class="mspace mtight" style="margin-right:0.1952em;"></span><span class="mspace mtight" style="margin-right:0.1952em;"></span><span class="mord mathnormal mtight">ϕ</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span><span class="mclose mtight">)</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.2769em;"><span></span></span></span></span></span></span><span class=mclose >}</span><span class="mspace allowbreak"></span><span class=mspace  style="margin-right:0.6667em;"></span></span><span class=base ><span class=strut  style="height:0.6944em;"></span><span class=mord ><span class=mord ><span class="mord mathrm">mod</span></span></span><span class=mspace  style="margin-right:0.1667em;"></span><span class=mspace  style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span></p> </ul> <li><p>Send <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy=false >{</mo><mo stretchy=false >(</mo><msub><mi>x</mi><mi>i</mi></msub><mo separator=true >,</mo><msub><mi>a</mi><mi>i</mi></msub><mo separator=true >,</mo><msub><mi>b</mi><mi>i</mi></msub><mo stretchy=false >)</mo><mo separator=true >,</mo><msub><mi>z</mi><mi>i</mi></msub><msub><mo stretchy=false >}</mo><mrow><mi>i</mi><mo>∈</mo><mo stretchy=false >[</mo><mi>m</mi><mo stretchy=false >]</mo></mrow></msub></mrow><annotation encoding="application/x-tex">\{(x_i, a_i, b_i), z_i\}_{i \in [m]}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1.1052em;vertical-align:-0.3552em;"></span><span class=mopen >{(</span><span class=mord ><span class="mord mathnormal">x</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.1667em;"></span><span class=mord ><span class="mord mathnormal">a</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.1667em;"></span><span class=mord ><span class="mord mathnormal">b</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mclose >)</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.1667em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mclose ><span class=mclose >}</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3448em;"><span style="top:-2.5198em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">∈</span><span class="mopen mtight">[</span><span class="mord mathnormal mtight">m</span><span class="mclose mtight">]</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.3552em;"><span></span></span></span></span></span></span></span></span></span> to the Verifier.</p> </ol> <p><strong>Verification</strong>: Accept iff all of the following hold:</p> <ul> <li><p><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> is an odd composite number.</p> <li><p><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>z</mi><mi>i</mi><mi>N</mi></msubsup><mo>=</mo><msub><mi>y</mi><mi>i</mi></msub><mspace></mspace><mspace width=0.6667em /><mrow><mi mathvariant=normal >m</mi><mi mathvariant=normal >o</mi><mi mathvariant=normal >d</mi></mrow><mtext> </mtext><mtext> </mtext><mi>N</mi></mrow><annotation encoding="application/x-tex">z_i^{N} = y_i \mod N</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1.1em;vertical-align:-0.2587em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.8413em;"><span style="top:-2.4413em;margin-left:-0.044em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.2587em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2778em;"></span></span><span class=base ><span class=strut  style="height:0.625em;vertical-align:-0.1944em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace allowbreak"></span><span class=mspace  style="margin-right:0.6667em;"></span></span><span class=base ><span class=strut  style="height:0.6944em;"></span><span class=mord ><span class=mord ><span class="mord mathrm">mod</span></span></span><span class=mspace  style="margin-right:0.1667em;"></span><span class=mspace  style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> for every <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>∈</mo><mo stretchy=false >[</mo><mi>m</mi><mo stretchy=false >]</mo></mrow><annotation encoding="application/x-tex">i \in [m]</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6986em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">i</span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >∈</span><span class=mspace  style="margin-right:0.2778em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mopen >[</span><span class="mord mathnormal">m</span><span class=mclose >]</span></span></span></span>.</p> <li><p><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>x</mi><mi>i</mi><mn>4</mn></msubsup><mo>=</mo><mo stretchy=false >(</mo><mo>−</mo><mn>1</mn><msup><mo stretchy=false >)</mo><msub><mi>a</mi><mi>i</mi></msub></msup><msup><mi>w</mi><msub><mi>b</mi><mi>i</mi></msub></msup><msub><mi>y</mi><mi>i</mi></msub><mspace></mspace><mspace width=0.6667em /><mrow><mi mathvariant=normal >m</mi><mi mathvariant=normal >o</mi><mi mathvariant=normal >d</mi></mrow><mtext> </mtext><mtext> </mtext><mi>N</mi></mrow><annotation encoding="application/x-tex">x_i^{4} = (-1)^{a_i} w^{b_i} y_i \mod N</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1.0728em;vertical-align:-0.2587em;"></span><span class=mord ><span class="mord mathnormal">x</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.8141em;"><span style="top:-2.4413em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">4</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.2587em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2778em;"></span></span><span class=base ><span class=strut  style="height:1.0991em;vertical-align:-0.25em;"></span><span class=mopen >(</span><span class=mord >−</span><span class=mord >1</span><span class=mclose ><span class=mclose >)</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3281em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class=pstrut  style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">b</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3281em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class=pstrut  style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace allowbreak"></span><span class=mspace  style="margin-right:0.6667em;"></span></span><span class=base ><span class=strut  style="height:0.6944em;"></span><span class=mord ><span class=mord ><span class="mord mathrm">mod</span></span></span><span class=mspace  style="margin-right:0.1667em;"></span><span class=mspace  style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> and <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>i</mi></msub><mo separator=true >,</mo><msub><mi>b</mi><mi>i</mi></msub><mo>∈</mo><mo stretchy=false >{</mo><mn>0</mn><mo separator=true >,</mo><mn>1</mn><mo stretchy=false >}</mo></mrow><annotation encoding="application/x-tex">a_i, b_i \in \{0, 1\}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.8889em;vertical-align:-0.1944em;"></span><span class=mord ><span class="mord mathnormal">a</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.1667em;"></span><span class=mord ><span class="mord mathnormal">b</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >∈</span><span class=mspace  style="margin-right:0.2778em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mopen >{</span><span class=mord >0</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.1667em;"></span><span class=mord >1</span><span class=mclose >}</span></span></span></span> for every <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>∈</mo><mo stretchy=false >[</mo><mi>m</mi><mo stretchy=false >]</mo></mrow><annotation encoding="application/x-tex">i \in [m]</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6986em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">i</span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >∈</span><span class=mspace  style="margin-right:0.2778em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mopen >[</span><span class="mord mathnormal">m</span><span class=mclose >]</span></span></span></span>.</p> </ul> <p>A crucial step is that the Verifier must check that <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>w</mi></mrow><annotation encoding="application/x-tex">w</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span></span></span></span> has Jacobi symbol <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">-1</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.7278em;vertical-align:-0.0833em;"></span><span class=mord >−</span><span class=mord >1</span></span></span></span>. When following CMP20&#39;s exposition, it is easy to miss this step since the property is only mentioned in Step 1, but is missing from final list of verifications. This can lead to soundness violations in the Paillier-Blum proof, which when used in the context of threshold signature protocols such as CMP20, can lead to full private key recovery in as few as 16 signatures.</p> <p>In this article, we describe three vulnerabilities in popular ZKP libraries which were in the folklore but have now been patched. As far as I can tell, only the <code>paillier-zk</code> bug has an official advisory attached, so these are still worth watching out for in case you are using or auditing an implementation which depends on a vulnerable version.</p> <h4 id=bug_1_missing_w_verification_in_fireblocks_mpc-lib ><a href="#bug_1_missing_w_verification_in_fireblocks_mpc-lib" class=header-anchor >Bug 1: Missing <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>w</mi></mrow><annotation encoding="application/x-tex">w</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span></span></span></span> verification in Fireblocks <code>mpc-lib</code></a></h4> <p>Since CMP20 was originally developed by Fireblocks, the <a href="https://github.com/fireblocks/mpc-lib"><code>mpc-lib</code></a> repo can in some ways be regarded as the &quot;reference implementation&quot; of the protocol. However prior to commit <a href="https://github.com/fireblocks/mpc-lib/commit/84b7fb83502a998703b6ceb113273fc20fa55b7b"><code>84b7fb8</code></a>, the Paillier-Blum modulus proof did not verify that <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>w</mi></mrow><annotation encoding="application/x-tex">w</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span></span></span></span> and <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> were coprime, which is necessary for <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>w</mi></mrow><annotation encoding="application/x-tex">w</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span></span></span></span> to have Jacobi symbol <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">-1</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.7278em;vertical-align:-0.0833em;"></span><span class=mord >−</span><span class=mord >1</span></span></span></span>.</p> <pre><code class="diff hljs"><span class=hljs-comment >diff --git a/src/common/crypto/paillier/paillier_zkp.c b/src/common/crypto/paillier/paillier_zkp.c</span>
<span class=hljs-comment >index 65d666a..4eadaf0 100644</span>
<span class=hljs-comment >--- a/src/common/crypto/paillier/paillier_zkp.c</span>
<span class=hljs-comment >+++ b/src/common/crypto/paillier/paillier_zkp.c</span>
<span class=hljs-meta >@@ -953,6 +953,11 @@</span> long paillier_verify_paillier_blum_zkp(const paillier_public_key_t *pub, const u
     if (!y || !tmp)
         goto cleanup;
 
<span class=hljs-addition >+    if (!is_coprime_fast(proof.w, pub-&gt;n, ctx))</span>
<span class=hljs-addition >+    {</span>
<span class=hljs-addition >+        ret = PAILLIER_ERROR_INVALID_PROOF;</span>
<span class=hljs-addition >+        goto cleanup;</span>
<span class=hljs-addition >+    }</span>
     for (uint32_t i = 0; i &lt; PAILLIER_BLUM_STATISTICAL_SECURITY; ++i)
     {
         do
<span class=hljs-meta >@@ -960,6 +965,11 @@</span> long paillier_verify_paillier_blum_zkp(const paillier_public_key_t *pub, const u
             deterministic_rand(seed, n_len, y, &amp;seed);
         } while (BN_cmp(y, pub-&gt;n) &gt;= 0);
         
<span class=hljs-addition >+        if (!is_coprime_fast(y, pub-&gt;n, ctx))</span>
<span class=hljs-addition >+        {</span>
<span class=hljs-addition >+            ret = PAILLIER_ERROR_INVALID_PROOF;</span>
<span class=hljs-addition >+            goto cleanup;</span>
<span class=hljs-addition >+        }</span>
         if (!BN_mod_exp(tmp, proof.z[i], pub-&gt;n, pub-&gt;n, ctx))
             goto cleanup;
         if (BN_cmp(tmp, y) != 0)</code></pre> <p>Without this check, the protocol becomes vulnerable to a key recovery attack similar to the attack of <a href="https://www.cve.org/CVERecord?id&#61;CVE-2023-33241">CVE-2023-33241</a> on GG18/GG20. This missing coprimality check was the subject of my 2025 DownUnderCTF challenge <code>good-game-well-played</code>, the solve script for which can be found <a href="https://github.com/DownUnderCTF/Challenges_2025_Public/tree/main/crypto/good_game_well_played/solve">here</a>. The script implements a modified version of the CVE-2023-33241 attack, adapted for the CMP20 protcol. </p> <h4 id=bug_2_missing_w_verification_in_lfdt_paillier-zk_crate ><a href="#bug_2_missing_w_verification_in_lfdt_paillier-zk_crate" class=header-anchor >Bug 2: Missing <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>w</mi></mrow><annotation encoding="application/x-tex">w</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span></span></span></span> verification in LFDT <code>paillier-zk</code> crate</a></h4> <p>In a similar manner, the <code>paillier-zk</code> crate prior to commit <a href="https://github.com/LFDT-Lockness/paillier-zk/commit/9a7d2fea8b7d4eb0d35cd797e2d607bda20c19c4"><code>9a7d2fe</code></a> does not verify that <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>w</mi></mrow><annotation encoding="application/x-tex">w</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span></span></span></span> has Jacobi symbol <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">-1</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.7278em;vertical-align:-0.0833em;"></span><span class=mord >−</span><span class=mord >1</span></span></span></span>.</p> <pre><code class="diff hljs"><span class=hljs-comment >diff --git a/src/paillier_blum_modulus.rs b/src/paillier_blum_modulus.rs</span>
<span class=hljs-comment >index fcf60fe..784be60 100644</span>
<span class=hljs-comment >--- a/src/paillier_blum_modulus.rs</span>
<span class=hljs-comment >+++ b/src/paillier_blum_modulus.rs</span>
<span class=hljs-meta >@@ -123,7 +123,10 @@</span> pub mod interactive {
     use rand_core::RngCore;
     use rug::{Complete, Integer};
 
<span class=hljs-deletion >-    use crate::common::sqrt::{blum_sqrt, find_residue, sample_neg_jacobi};</span>
<span class=hljs-addition >+    use crate::common::{</span>
<span class=hljs-addition >+        fail_if_ne,</span>
<span class=hljs-addition >+        sqrt::{blum_sqrt, find_residue, sample_neg_jacobi},</span>
<span class=hljs-addition >+    };</span>
     use crate::{BadExponent, Error, ErrorReason, InvalidProof, InvalidProofReason};
 
     use super::{Challenge, Commitment, Data, PrivateData, Proof, ProofPoint};
<span class=hljs-meta >@@ -179,6 +182,11 @@</span> pub mod interactive {
         if data.n.is_even() {
             return Err(InvalidProofReason::ModulusIsEven.into());
         }
<span class=hljs-addition >+        fail_if_ne(</span>
<span class=hljs-addition >+            InvalidProofReason::EqualityCheck(1),</span>
<span class=hljs-addition >+            &amp;data.n.gcd_ref(&amp;commitment.w).complete(),</span>
<span class=hljs-addition >+            Integer::ONE,</span>
<span class=hljs-addition >+        )?;</span>
         for (point, y) in proof.points.iter().zip(challenge.ys.iter()) {
             if Integer::from(
                 point</code></pre> <p>When this bug was patched, the changelog blamed the CGGMP21 paper for omitting the coprimality check between <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>w</mi></mrow><annotation encoding="application/x-tex">w</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span></span></span></span> and <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span>, stating:</p> <pre><code class="julia hljs">[!WARNING]
This library version uses Zero-Knowledge proofs from the CGGMP21 paper, 
which contains a critical vulnerability that could lead to full private 
key recovery.</code></pre> <p>However, if one takes a charitable view, one could also argue that the paper was not at fault, since coprimality between <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>w</mi></mrow><annotation encoding="application/x-tex">w</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span></span></span></span> and <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> was already implied when <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>w</mi></mrow><annotation encoding="application/x-tex">w</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span></span></span></span> was stated to have Jacobi symbol <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">-1</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.7278em;vertical-align:-0.0833em;"></span><span class=mord >−</span><span class=mord >1</span></span></span></span> &#40;for if <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>w</mi></mrow><annotation encoding="application/x-tex">w</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span></span></span></span> and <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> shared non-trivial factors then the Jacobi symbol would be <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6444em;"></span><span class=mord >0</span></span></span></span>&#41;.</p> <h4 id=bug_3_missing_primality_and_coprimality_check_in_safeheron_crypto_suites ><a href="#bug_3_missing_primality_and_coprimality_check_in_safeheron_crypto_suites" class=header-anchor >Bug 3: Missing primality and coprimality check in Safeheron Crypto Suites </a></h4> <p>The Safeheron Crypto Suites are a self-described foundational cryptographic library, developed by Safeheron. Included within is a module for Paillier-Blum modulus proofs, which prior to commit <a href="https://github.com/Safeheron/safeheron-crypto-suites-cpp/commit/36f0a0ff352e9f23080bf1de448581deb3d61485"><code>36f0a0f</code></a> did not verify that <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>w</mi></mrow><annotation encoding="application/x-tex">w</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span></span></span></span> and <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> were coprime, nor that <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> itself was composite. However, the verification logic <em>did</em> verify that <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn><mo>&lt;</mo><mi>w</mi><mo>&lt;</mo><mi>N</mi></mrow><annotation encoding="application/x-tex">0 &lt; w &lt; N</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6835em;vertical-align:-0.0391em;"></span><span class=mord >0</span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >&lt;</span><span class=mspace  style="margin-right:0.2778em;"></span></span><span class=base ><span class=strut  style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >&lt;</span><span class=mspace  style="margin-right:0.2778em;"></span></span><span class=base ><span class=strut  style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span>. The left two possible methods to forge a proof:</p> <ol> <li><p>Supply <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> prime and try to prove that a prime is a Paillier-Blum modulus</p> <li><p>Supply for <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>w</mi></mrow><annotation encoding="application/x-tex">w</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span></span></span></span> a factor &#40;or product of factors&#41; of <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> and attempt to forge a proof for non-biprime <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span>.</p> </ol> <p>By CRT, the latter case reduces naturally to the former, since if <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo>=</mo><msub><mo>∏</mo><mi>i</mi></msub><msub><mi>p</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">N = \prod_{i}p_i</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2778em;"></span></span><span class=base ><span class=strut  style="height:1.0497em;vertical-align:-0.2997em;"></span><span class=mop ><span class="mop op-symbol small-op" style="position:relative;top:0em;">∏</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.162em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.2997em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.1667em;"></span><span class=mord ><span class="mord mathnormal">p</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> and we choose <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>w</mi><mo>=</mo><msub><mo>∏</mo><mrow><mi>i</mi><mo mathvariant=normal >≠</mo><mi>j</mi></mrow></msub><msub><mi>p</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">w = \prod_{i \neq j} p_i</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2778em;"></span></span><span class=base ><span class=strut  style="height:1.1858em;vertical-align:-0.4358em;"></span><span class=mop ><span class="mop op-symbol small-op" style="position:relative;top:0em;">∏</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.1864em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight"><span class="mrel mtight"><span class="mord vbox mtight"><span class="thinbox mtight"><span class="rlap mtight"><span class=strut  style="height:0.8889em;vertical-align:-0.1944em;"></span><span class=inner ><span class="mord mtight"><span class="mrel mtight"></span></span></span><span class=fix ></span></span></span></span></span><span class="mrel mtight">=</span></span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.4358em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.1667em;"></span><span class=mord ><span class="mord mathnormal">p</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, then <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>w</mi><mo>≡</mo><mn>0</mn><mspace></mspace><mspace width=0.6667em /><mrow><mi mathvariant=normal >m</mi><mi mathvariant=normal >o</mi><mi mathvariant=normal >d</mi></mrow><mtext> </mtext><mtext> </mtext><msub><mi>p</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">w \equiv 0 \mod p_i</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.4637em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >≡</span><span class=mspace  style="margin-right:0.2778em;"></span></span><span class=base ><span class=strut  style="height:0.6444em;"></span><span class=mord >0</span><span class="mspace allowbreak"></span><span class=mspace  style="margin-right:0.6667em;"></span></span><span class=base ><span class=strut  style="height:0.8889em;vertical-align:-0.1944em;"></span><span class=mord ><span class=mord ><span class="mord mathrm">mod</span></span></span><span class=mspace  style="margin-right:0.1667em;"></span><span class=mspace  style="margin-right:0.1667em;"></span><span class=mord ><span class="mord mathnormal">p</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> whenever <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo mathvariant=normal >≠</mo><mi>j</mi></mrow><annotation encoding="application/x-tex">i \neq j</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">i</span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel ><span class=mrel ><span class="mord vbox"><span class=thinbox ><span class=rlap ><span class=strut  style="height:0.8889em;vertical-align:-0.1944em;"></span><span class=inner ><span class=mord ><span class=mrel ></span></span></span><span class=fix ></span></span></span></span></span><span class=mrel >=</span></span><span class=mspace  style="margin-right:0.2778em;"></span></span><span class=base ><span class=strut  style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span>. Hence the proof is trivial in all factors besides <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">p_j</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.7167em;vertical-align:-0.2861em;"></span><span class=mord ><span class="mord mathnormal">p</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>, which is equivalent to the first case.</p> <p>To attack the first case, we observe that the Paillier-Blum modulus proof consists primarily of two halves. The first half is proving that <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant=double-struck >Z</mi><mi mathvariant=normal >/</mi><mi>N</mi><mi mathvariant=double-struck >Z</mi></mrow><annotation encoding="application/x-tex">\mathbb{Z}/N\mathbb{Z}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathbb">Z</span><span class=mord >/</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mord mathbb">Z</span></span></span></span> has <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span>-th roots, which is equivalent to showing that <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant=normal >g</mi><mi mathvariant=normal >c</mi><mi mathvariant=normal >d</mi></mrow><mo stretchy=false >(</mo><mi>N</mi><mo separator=true >,</mo><mi>ϕ</mi><mo stretchy=false >(</mo><mi>N</mi><mo stretchy=false >)</mo><mo stretchy=false >)</mo><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\mathrm{gcd}(N, \phi(N)) = 1</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mord ><span class="mord mathrm">gcd</span></span><span class=mopen >(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.1667em;"></span><span class="mord mathnormal">ϕ</span><span class=mopen >(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class=mclose >))</span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2778em;"></span></span><span class=base ><span class=strut  style="height:0.6444em;"></span><span class=mord >1</span></span></span></span>. Since this is automatically true for prime <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span>, we can proceed according to protocol in this case.</p> <p>The second case involves showing that <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> contains at most two factors. Given a challenge <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">y_i</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.625em;vertical-align:-0.1944em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, the prover must show that one of <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mi>i</mi></msub><mo separator=true >,</mo><mo>−</mo><msub><mi>y</mi><mi>i</mi></msub><mo separator=true >,</mo><mi>w</mi><msub><mi>y</mi><mi>i</mi></msub><mo separator=true >,</mo><mo>−</mo><mi>w</mi><msub><mi>y</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">y_i, -y_i, wy_i, -wy_i</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.7778em;vertical-align:-0.1944em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.1667em;"></span><span class=mord >−</span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.1667em;"></span><span class=mord >−</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> has Legendre symbol <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6444em;"></span><span class=mord >1</span></span></span></span> in each factor, which is necessary for being a quadratic residue in <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant=double-struck >Z</mi><mi mathvariant=normal >/</mi><mi>N</mi><mi mathvariant=double-struck >Z</mi></mrow><annotation encoding="application/x-tex">\mathbb{Z}/N\mathbb{Z}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathbb">Z</span><span class=mord >/</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mord mathbb">Z</span></span></span></span>. This is done by giving the Prover control over two binary switches which respectively control the parity of the Legendre symbol in certain subsets of factors of <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span>. By choosing to multiply by <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">-1</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.7278em;vertical-align:-0.0833em;"></span><span class=mord >−</span><span class=mord >1</span></span></span></span>, the Prover can invert the parity in every factor. By choosing to multiply by <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>w</mi></mrow><annotation encoding="application/x-tex">w</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span></span></span></span>, the Prover can invert the parity of the Legendre symbol in an odd number of factors. Hence, if <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> is square-free and has more than two factors then the Prover can succeed with probability at most <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mi mathvariant=normal >/</mi><mn>2</mn></mrow><annotation encoding="application/x-tex">1/2</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mord >1/2</span></span></span></span>. On the other hand if <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> has less than two factors, then the Prover can always succeed. In particular, a valid proof can always be constructed when <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> is prime, as shown below:</p> <pre><code class="cpp hljs"><span class=hljs-comment >// soundness violation #1: we prove that a prime p is a Paillier-Blum Modulus</span>
<span class=hljs-built_in >TEST</span>(ZKP, PailBlumModulusProofPrime)
{
    std::string P_hex = <span class=hljs-string >&quot;a57a9a469c1019907d35f3bb798e4b99c23609cf963d68e7f5727e6a7dabe5c85c8beaf292813c461cb0245ad294aa31d5284eb6d2b16f6cc81d4ebc0d939fa46e4d92c4a506206b72de28a5e333208bf0fb90c1f0231fee6f13ed323736706711fa5708dc7d68298a3ca4e30c3fee3db65e85f10e16332abcface9eb7b4fa7e2b9d32914a3aac48d8a98001461925b7aae886499538b833ba705cd934126cf9c038bdc41b9939a1dfd9e9ef9aa3e992e6662c5ef85b8c9e71ffe7d41841eefbaa9ac8943ac3cddfddd82bfd502a90a92db1916eadba25fd4e2c64d9038c029487b99d5433a8d01708b55fad4e5cc552d5af97a6d9adefabdb440f17dd82727f&quot;</span>;
    BN P = BN::<span class=hljs-built_in >FromHexStr</span>(P_hex);
    safeheron::zkp::pail::PailBlumModulusProof proof;

    <span class=hljs-comment >// commit -&gt; chose any w with jacobi symbol -1</span>
    proof.w_ = <span class=hljs-built_in >RandomBNLt</span>(P);
    <span class=hljs-keyword >while</span> (BN::<span class=hljs-built_in >JacobiSymbol</span>(proof.w_, P) != <span class=hljs-number >-1</span>){
        proof.w_ = <span class=hljs-built_in >RandomBNLt</span>(P);
    }

    <span class=hljs-built_in >ASSERT_TRUE</span>(BN::<span class=hljs-built_in >JacobiSymbol</span>(<span class=hljs-built_in >BN</span>(<span class=hljs-number >6</span>), <span class=hljs-built_in >BN</span>(<span class=hljs-number >9</span>)) == <span class=hljs-number >0</span>);
    std::vector&lt;<span class=hljs-type >int</span>&gt; prime_arr;
    <span class=hljs-built_in >prime_util</span>(<span class=hljs-number >6000</span>, prime_arr);
    <span class=hljs-built_in >ASSERT_TRUE</span>(prime_arr.<span class=hljs-built_in >at</span>(<span class=hljs-number >0</span>) == <span class=hljs-number >2</span>);

    <span class=hljs-comment >// challenge</span>
    std::vector&lt;BN&gt; y_arr;
    proof.<span class=hljs-built_in >GenerateYs</span>(y_arr, P, proof.w_, ITERATIONS_BlumInt_Proof );

    <span class=hljs-comment >// reveal</span>
    <span class=hljs-keyword >for</span>(<span class=hljs-type >int</span> i = <span class=hljs-number >0</span>; i &lt; ITERATIONS_BlumInt_Proof; ++i) {
        <span class=hljs-comment >// by fermat&#x27;s little theorem -&gt; y^p = y mod p</span>
        BN z = y_arr[i];

        <span class=hljs-type >int32_t</span> a, b;           <span class=hljs-comment >// a controls -1, b controls w</span>
        <span class=hljs-keyword >if</span> (BN::<span class=hljs-built_in >JacobiSymbol</span>(y_arr[i], P) == <span class=hljs-number >1</span>) {
            <span class=hljs-comment >// y is a quadratic residue mod p</span>
            <span class=hljs-comment >// since p = 3 mod 4, by biquadratic reciprocity, y is also a quartic residue mod p</span>
            a = b = <span class=hljs-number >0</span>;
        } <span class=hljs-keyword >else</span> {
            <span class=hljs-comment >// -1 is always quadratic non residue</span>
            a = <span class=hljs-number >1</span>;
            b = <span class=hljs-number >0</span>;
        }

        <span class=hljs-comment >// we are guaranteed that (-1)^a * y is a quadratic residue.</span>
        BN root = (a ? y_arr[i].<span class=hljs-built_in >Neg</span>() : y_arr[i]) % P;
        root = root.<span class=hljs-built_in >SqrtM</span>(P);
        <span class=hljs-comment >// if sqrt(a * y) is again a quadratic residue, then</span>
        <span class=hljs-comment >// sqrt(sqrt(a * y))^4 = y</span>
        <span class=hljs-keyword >if</span> (BN::<span class=hljs-built_in >JacobiSymbol</span>(root, P) == <span class=hljs-number >1</span>) {
            root = root.<span class=hljs-built_in >SqrtM</span>(P);
        } <span class=hljs-keyword >else</span> {
            <span class=hljs-comment >// otherwise -sqrt(a*y) is a quadratic residue,</span>
            <span class=hljs-comment >// so sqrt(-sqrt(a * y)) is a quartic residue</span>
            root = (root.<span class=hljs-built_in >Neg</span>() % P).<span class=hljs-built_in >SqrtM</span>(P);
        }

        proof.x_arr_.<span class=hljs-built_in >push_back</span>(root);
        proof.z_arr_.<span class=hljs-built_in >push_back</span>(z);
        proof.a_arr_.<span class=hljs-built_in >push_back</span>(a);
        proof.b_arr_.<span class=hljs-built_in >push_back</span>(b);
    }

    <span class=hljs-comment >// verify</span>
    <span class=hljs-built_in >ASSERT_TRUE</span>(proof.<span class=hljs-built_in >Verify</span>(P));
}</code></pre> </div> </div> </div> <script src="/libs/highlight/highlight.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/php.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/diff.min.js"></script> <script src="/libs/highlight/rust.min.js"></script> <script src="/libs/highlight/csharp.min.js"></script> <script> hljs.highlightAll(); hljs.configure({ tabReplace: " " }); </script>